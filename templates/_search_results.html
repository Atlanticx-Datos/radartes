{% if pages %}
{% for page in pages %}
<tr style="
    background-color: 
    {% if page.destinatarios == 'Destacar' %} rgba(251, 146, 60, 0.15); 
    {% else %} transparent; 
    {% endif %}
;">
    <th class="w-[7%]">
        <label class="flex justify-center items-center w-full h-full">
            <input type="checkbox" 
                   name="selected_pages" 
                   value="{{ page.id }}"
                   class="checkbox rounded-none h-4 w-4">
        </label>
    </th>
    <td class="w-[45%] md:w-[38%] pl-6">
        <div class="flex items-center">
            <div>
                <div class="font-medium text-sm leading-tight mb-1">
                    <span class="md:hidden">{{ page.nombre | truncate(25) }}</span>
                    <span class="hidden md:inline">{{ page.nombre }}</span>
                </div>
                <div class="text-xs opacity-50 leading-none">{{ page.país }}</div>
            </div>
        </div>
        <input type="hidden" name="name_{{ page.id }}" value="{{ page.nombre }}">
        <input type="hidden" name="country_{{ page.id }}" value="{{ page.país }}">
        <input type="hidden" name="url_{{ page.id }}" value="{{ page.base_url if page.base_url else page.url }}">
        <input type="hidden" name="recipients_{{ page.id }}" value="{{ page.destinatarios }}">
        <input type="hidden" name="fecha_de_cierre_{{ page.id }}" value="{{ page.fecha_de_cierre }}">
    </td>
    <td class="w-[30%] md:w-[35%]">
        <div class="border-left-custom text-sm py-2 capitalize-first h-12 flex items-center pl-6" style="line-height: 0.8rem;">
            <span class="md:hidden whitespace-nowrap">
                {{ page.ai_keywords | capitalize }}
                / <span class="bg-gray-200 bg-opacity-75 backdrop-blur-md px-1 ml-1 whitespace-nowrap">
                    {{ page.url_base }}
                </span>
            </span>
            <span class="hidden md:inline whitespace-nowrap">
                {{ page.ai_keywords | capitalize }}
                / <span class="bg-gray-200 bg-opacity-75 backdrop-blur-md px-1 ml-1 whitespace-nowrap">
                    {{ page.url_base }}
                </span>
            </span>
        </div>
    </td>
    <td class="w-[10%] md:w-[12%] text-xs text-center fecha-de-cierre">
        {{ page.fecha_de_cierre | default("Sin cierre") | format_date }}
    </td>
    <th class="w-[8%] md:w-[8%] min-w-[70px] relative">
        <div class="flex items-center justify-center">
            <div class="inline-flex items-center gap-1.5 md:gap-3 bg-slate-100 py-2 px-3 md:px-4 ml-9 md:ml-1 mr-4">
                <button
                   role="button"
                   tabindex="0"
                   data-url="{{ page.base_url if page.base_url else page.url }}"
                   data-keywords="{{ page.ai_keywords }}"
                   data-name="{{ page.nombre }}"
                   data-country="{{ page.país }}"
                   class="opportunity-link flex items-center justify-center w-4 h-4">
                    <svg class="w-3 md:w-4" data-slot="icon" fill="none" stroke-width="1.5" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 19.5L19.5 4.5M19.5 4.5H8.25M19.5 4.5V15.75"></path>
                    </svg>
                </button>
                <div class="static">
                    <button tabindex="0" 
                            role="button" 
                            class="flex items-center justify-center w-4 h-4"
                            {% if session.get('user') %}
                                onclick="toggleDropdown(this)"
                            {% else %}
                                onclick="redirectToLogin()"
                            {% endif %}>
                        <svg class="w-3 md:w-4" data-slot="icon" fill="none" stroke-width="1.5" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M7.217 10.907a2.25 2.25 0 1 0 0 2.186m0-2.186c.18.324.283.696.283 1.093s-.103.77-.283 1.093m0-2.186 9.566-5.314m-9.566 7.5 9.566 5.314m0 0a2.25 2.25 0 1 0 3.935 2.186 2.25 2.25 0 0 0-3.935-2.186Zm0-12.814a2.25 2.25 0 1 0 3.933-2.185 2.25 2.25 0 0 0-3.933 2.185Z"></path>
                        </svg>
                    </button>
                    {% if session.get('user') %}
                        <ul class="dropdown-content menu p-2 shadow-xl bg-white rounded-md w-52 border border-black mt-3 absolute right-0 hidden">
                            <li class="menu-item"><a href="#" onclick="shareOpportunity('{{ page.url }}', '{{ page.nombre }}', 'whatsapp')">WhatsApp</a></li>
                            <li class="menu-item"><a href="#" onclick="shareOpportunity('{{ page.url }}', '{{ page.nombre }}', 'linkedin')">LinkedIn</a></li>
                            <li class="menu-item"><a href="#" onclick="shareOpportunity('{{ page.url }}', '{{ page.nombre }}', 'gmail')">Email</a></li>
                        </ul>
                    {% endif %}
                </div>
            </div>
        </div>
    </th>
</tr>
{% endfor %}
{% else %}
<tr>
    <td colspan="5" class="p-2 text-center">No se encontró nada relevante.</td>
</tr>
{% endif %}

<style>
    .border-left-custom {
            position: relative;
        }

        .border-left-custom::before {
            content: '';
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 4px;
            height: 70%;
            background-color: #e5e7eb;
        }

        .capitalize-first::first-letter {
            text-transform: uppercase !important;
        }

    tr:last-child {
        margin-bottom: 8rem !important;
    }
    
    #search-results {
        padding-bottom: 8rem;
    }

    .fecha-de-cierre {
        text-align: center;
    }

    .fecha-de-cierre.confirmar {
        padding-left: 6px; /* Adjusts the text slightly to the right */
    }

    /* Force solid background and proper stacking for dropdowns */
    .dropdown-content {
        background-color: white !important;
        box-shadow: 0 0 10px rgba(0,0,0,0.1), 0 4px 6px -1px rgba(0,0,0,0.1) !important;
    }
    
    /* Ensure menu items have solid background */
    .dropdown-content .menu-item {
        background-color: white !important;
    }
    
    /* Create stacking context */
    .dropdown {
        position: relative;
        isolation: isolate;
    }
</style>

<script>
    function shareOpportunity(url, title, platform) {
        const encodedUrl = encodeURIComponent(url);
        const encodedTitle = encodeURIComponent('\n- + Oportunidades');

        let shareUrl = '';

        if (platform === 'whatsapp') {
            shareUrl = `https://wa.me/?text=${encodedTitle}%20${encodedUrl}`;
        } else if (platform === 'linkedin') {
            shareUrl = `https://www.linkedin.com/sharing/share-offsite/?url=${encodedUrl}&text=${encodedTitle}`;
        } else if (platform === 'gmail') {
            shareUrl = `mailto:?subject=${encodeURIComponent(encodedTitle)}&body=${encodedUrl}`;
        }
        window.open(shareUrl, '_blank');
    }

    document.addEventListener('DOMContentLoaded', function () {
        document.querySelectorAll('.fecha-de-cierre').forEach(function (element) {
            if (element.textContent.trim() === 'Sin Cierre') {
                element.textContent = 'Confirmar';
                element.classList.add('confirmar'); // Add class to apply specific styles
            }
            // Ensure all fecha-de-cierre elements are centered
            element.classList.add('text-center');
        });
    });

    function handleDropdown(event) {
        // Prevent the click from bubbling up
        event.stopPropagation();
    }

    // Close dropdown when clicking outside
    document.addEventListener('click', function(event) {
        const dropdowns = document.querySelectorAll('details.dropdown');
        dropdowns.forEach(dropdown => {
            if (!dropdown.contains(event.target)) {
                dropdown.removeAttribute('open');
            }
        });
    });

    function manageDropdownStack(dropdownEl) {
        // Get all SVG icons in the table
        const icons = document.querySelectorAll('th svg');
        const dropdown = dropdownEl.querySelector('.dropdown-content');
        
        // Store original z-index values
        icons.forEach(icon => {
            if (!icon.dataset.originalZ) {
                icon.dataset.originalZ = getComputedStyle(icon).zIndex;
            }
            icon.style.zIndex = '1';
        });

        // Set dropdown to highest z-index
        dropdown.style.zIndex = '9999';
        dropdown.style.backgroundColor = 'white';
        
        // Add click outside listener
        const closeDropdown = (e) => {
            if (!dropdownEl.contains(e.target)) {
                // Restore original z-index values
                icons.forEach(icon => {
                    icon.style.zIndex = icon.dataset.originalZ || 'auto';
                });
                document.removeEventListener('click', closeDropdown);
            }
        };
        
        document.addEventListener('click', closeDropdown);
    }

    function toggleDropdown(button) {
        // Prevent any event bubbling and default behavior
        event.preventDefault();
        event.stopPropagation();
        
        // Clear any existing alerts
        const alertContainer = document.getElementById('alert-container');
        if (alertContainer) {
            alertContainer.innerHTML = '';
        }
        
        // Close all other table dropdowns first
        document.querySelectorAll('th .dropdown-content').forEach(d => {
            if (d !== button.nextElementSibling) {
                d.classList.add('hidden');
            }
        });
        
        // Toggle current dropdown
        const dropdown = button.nextElementSibling;
        dropdown.classList.toggle('hidden');
        
        // Position the dropdown relative to the button
        if (!dropdown.classList.contains('hidden')) {
            const buttonHeight = button.offsetHeight;
            dropdown.style.top = `${buttonHeight + 4}px`;
            dropdown.style.right = '0';
            dropdown.style.zIndex = '9999';
        }
    }

    // Close dropdown when clicking outside, but only for table dropdowns
    document.addEventListener('click', function(event) {
        if (!event.target.closest('th .dropdown-content') && !event.target.closest('th button')) {
            document.querySelectorAll('th .dropdown-content').forEach(d => {
                d.classList.add('hidden');
            });
        }
        
        // Prevent form submission checks when clicking dropdowns
        if (event.target.closest('.dropdown-content') || event.target.closest('button[onclick*="toggleDropdown"]')) {
            event.stopPropagation();
        }
    });
</script>