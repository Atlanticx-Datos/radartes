{% extends 'layout.html' %}

{% block body %}

<body>
    <div id="spinner" class="spinner h-8 w-8" style="display: none;">
        <img src="{{ url_for('static', filename='public/spinner.gif') }}" alt="Loading...">
    </div>

    <div class="px-0 md:px-8 mt-4 md:-mt-10" style="margin-left: -1rem !important; margin-right: -0.5rem !important;">
        <!-- Title section -->
        <div class="mb-5 md:mb-20">
            <h1
                class="text-3xl md:text-4xl font-bold text-black leading-none md:leading-tight tracking-tight mt-6 md:mt-12 md:mt-0 ml-4">
                Informate, compartí y guardá oportunidades, gratis.
            </h1>
        </div>

        <!-- Main content -->
        <main class="w-full relative">
            <div class="grid grid-cols-1 md:grid-cols-12 gap-0">
                <!-- First Column: Accordions -->
                <div
                    class="col-span-1 md:col-span-5 lg:col-span-4 flex flex-col justify-between min-w-0 md:border-r border-neutral">
                    <div class="flex-1 flex flex-col gap-2">
                        <!-- Accordion 1 -->
                        <div class="join join-vertical w-full">
                            <div class="collapse join-item border-b border-neutral rounded-none w-full">
                                <input type="radio" name="my-accordion-1" checked="" />
                                <div class="collapse-title text-sm tracking-tighter text-neutral-700 inline-block">
                                    <span class="md:border border-neutral-300 md:px-4 md:py-2">
                                        CIERRAN PRONTO
                                    </span>
                                </div>
                                <div class="collapse-content w-full">
                                    {% if closing_soon_pages %}
                                    {% for page in closing_soon_pages %}
                                    <p class="relative">
                                        <a href="{{ page.base_url if page.base_url else page.url }}" target="_blank" data-name="{{ page.nombre }}"
                                            data-country="{{ page.País }}" data-url="{{ page.url }}"
                                            class="cierran-pronto-link">
                                            {{ page.nombre | truncate(50) }}
                                            <span
                                                class="absolute right-0 top-1/2 transform -translate-y-1/2 flex items-center justify-center -mr-1">
                                                <span
                                                    class="flex items-center justify-center group-hover:bg-slate-200 group-hover:rounded-md transition-all duration-200 p-2">
                                                    <svg class="w-3 h-3 z-10" data-slot="icon" fill="none"
                                                        stroke-width="1.5" stroke="currentColor" viewBox="0 0 24 24"
                                                        xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                                                        <path stroke-linecap="round" stroke-linejoin="round"
                                                            d="m4.5 19.5 15-15m0 0H8.25m11.25 0v11.25"></path>
                                                    </svg>
                                                </span>
                                            </span>
                                        </a>
                                    </p>
                                    {% endfor %}
                                    {% else %}
                                    <p>No hay oportunidades este mes.</p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        <!-- Accordion 2 -->
                        <div class="join join-vertical w-full">
                            <div class="collapse join-item border-neutral rounded-none w-full">
                                <input type="radio" name="my-accordion-2" checked="" />
                                <div
                                    class="collapse-title text-sm tracking-tighter text-neutral-700 inline-block md:mt">
                                    <span class="md:border border-neutral-300 md:px-4 md:py-2">
                                        DESTACADAS
                                    </span>
                                </div>
                                <div class="collapse-content w-full">
                                    {% if destacar_pages %}
                                    {% for page in destacar_pages %}
                                    <p class="relative">
                                        <a href="{{ page.base_url if page.base_url else page.url }}" target="_blank" data-name="{{ page.nombre }}"
                                            data-country="{{ page.País }}" data-url="{{ page.url }}"
                                            class="accordion-link" onclick="handleDestacadaClick(this)">
                                            <span class="md:hidden whitespace-nowrap">
                                                {{ page.nombre | truncate(18, true, "...") }}
                                                {% if page.entidad %}
                                                / <span
                                                    class="bg-gray-200 bg-opacity-75 backdrop-blur-md px-1 ml-1 whitespace-nowrap">
                                                    {{ page.entidad | truncate(12, true, "...") }}
                                                </span>
                                                {% endif %}
                                            </span>
                                            <span class="hidden md:inline whitespace-nowrap">
                                                {{ page.nombre | truncate(25, true, "...") }}
                                                {% if page.entidad %}
                                                / <span
                                                    class="bg-gray-200 bg-opacity-75 backdrop-blur-md px-1 ml-1 whitespace-nowrap">
                                                    {{ page.entidad | truncate(12, true, "...") }}
                                                </span>
                                                {% endif %}
                                            </span>
                                            <span
                                                class="absolute right-0 top-1/2 transform -translate-y-1/2 flex items-center justify-center -mr-2">
                                                <span
                                                    class="flex items-center justify-center group-hover:bg-slate-200 group-hover:rounded-md transition-all duration-200 p-2">
                                                    <svg class="w-3 h-3 z-10" data-slot="icon" fill="none"
                                                        stroke-width="1.5" stroke="currentColor" viewBox="0 0 24 24"
                                                        xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                                                        <path stroke-linecap="round" stroke-linejoin="round"
                                                            d="m4.5 19.5 15-15m0 0H8.25m11.25 0v11.25"></path>
                                                    </svg>
                                                </span>
                                            </span>
                                        </a>
                                    </p>
                                    {% endfor %}
                                    {% else %}
                                    <p>Vuelva a intentar</p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Search Input -->
                    <div class="flex-shrink-0 flex items-center relative w-full">
                        <input type="text" id="search-input" placeholder="Buscar por nombre, tipo o mes"
                            class="input input-bordered rounded-none w-full pl-6 lg:ml-0 focus:ring-0 focus:ring-offset-0 focus:ring-inset md:border-r-0 bg-slate-100"
                            name="search" hx-get="/database" hx-trigger="keyup changed delay:500ms"
                            hx-target="#search-results" hx-include="[name='expanded']" hx-indicator="#spinner"
                            hx-swap="innerHTML" hx-preserve="true">
                        <div class="absolute right-2 top-1/2 transform -translate-y-1/2 cursor-pointer"
                            onclick="clearSearch()">
                            <svg class="w-4 h-4" fill="none" stroke-width="1.5" stroke="currentColor"
                                viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12"></path>
                            </svg>
                        </div>
                    </div>
                </div>

                <!-- Second Column: Table -->
                <div class="col-span-1 md:col-span-7 lg:col-span-8 mt-2 lg:mt-0 min-w-0" id="table-container"
                    hx-preserve="true">
                    <form id="save-form" method="POST">
                        <div class="border-b border-neutral" id="results-container">
                            <div
                                class="max-h-[35rem] min-h-[20rem] overflow-y-auto overflow-x-hidden pl-4 md:pl-0 md:scrollbar-none custom-scrollbar md:border-t border-black md:border-r md:border-r-black">
                                <div
                                    class="w-[120%] md:w-full -ml-4 md:ml-0 overflow-x-auto md:overflow-x-hidden scrollbar-none">
                                    <div class="min-w-full">
                                        <table class="w-full h-full table-fixed relative isolate">
                                            <thead class="sticky top-0 bg-white z-20">
                                                <tr>
                                                    <th class="w-[7%] 3 pt-4 pb-3">✓</th>
                                                    <th
                                                        class="w-[38%] text-xs tracking-tighter text-neutral-700 text-left pl-6 pt-4 pb-3">
                                                        Oportunidad</th>
                                                    <th
                                                        class="w-[35%] text-xs tracking-tighter text-neutral-700 text-left pl-6 pt-4 pb-3">
                                                        Descripción</th>
                                                    <th
                                                        class="w-[12%] text-xs tracking-tighter text-neutral-700 text-center pt-4 pb-3">
                                                        Cierre</th>
                                                    <th class="w-[8%] pt-4 pb-3"></th>
                                                </tr>
                                            </thead>
                                            <tbody id="search-results" class="relative z-30">
                                                {% include "_search_results.html" %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="flex justify-center items-center space-x-2 mt-6 mb-4">
                            <div id="alert-container" class="flex items-center"></div>
                            {% if session.get('user') %}
                                <button type="submit" id="save-button" class="uppercase text-sm font-black tracking-tighter text-neutral-700">
                                    Guardar Seleccionados
                                </button>
                            {% else %}
                                <button type="button" onclick="redirectToLogin()" 
                                        class="uppercase text-sm font-black tracking-tighter text-neutral-700">
                                    Iniciar sesión para guardar
                                </button>
                            {% endif %}
                        </div>
                    </form>
                </div>
        </main>
        {% include 'footer.html' %}
    </div>


    <style>
        .spinner {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
        }

        /* Hide scrollbar for all devices */
        .scrollbar-none::-webkit-scrollbar,
        .custom-scrollbar::-webkit-scrollbar,
        #results-container>div::-webkit-scrollbar,
        #results-container::-webkit-scrollbar {
            display: none !important;
            width: 0 !important;
            height: 0 !important;
        }

        /* Firefox */
        .scrollbar-none,
        .custom-scrollbar,
        #results-container>div,
        #results-container {
            scrollbar-width: none !important;
            -ms-overflow-style: none !important;
        }

        /* Ensure clickable areas are accessible */
        .dropdown,
        .opportunity-link {
            position: relative !important;
            z-index: 10 !important;
        }

        @media (max-width: 1024px) {

            #results-container,
            #results-container>div,
            .max-h-\[35rem\] {
                overflow-x: auto !important;
            }

            /* Override any md: prefixed overflow classes */
            .md\:overflow-x-hidden {
                overflow-x: auto !important;
            }

            table {
                table-layout: fixed !important;
                width: 150% !important;
            }

            /* Adjust z-index for headers */
            th:nth-child(2),
            /* Oportunidad */
            th:nth-child(3)

            /* Descripción */
                {
                position: relative !important;
                z-index: 1 !important;
                /* Ensure headers are below the border */
            }

            /* Adjust sticky header behavior */
            thead.sticky {
                position: sticky !important;
                top: 0 !important;
                z-index: 1 !important;
                /* Ensure header is above table content */
                background: white !important;
            }

            /* Ensure border stays above sticky header */
            .max-h-\[35rem\].md\:border-r {
                position: relative !important;
                z-index: 20 !important;
                /* Higher z-index for the border */
            }
        }


        /* Keep overflow hidden for larger screens */
        @media (min-width: 1025px) {

            #results-container,
            #results-container>div,
            .max-h-\[35rem\] {
                overflow-x: hidden !important;
            }
        }

        /* Hide scrollbars but keep functionality */
        .scrollbar-none::-webkit-scrollbar,
        .custom-scrollbar::-webkit-scrollbar,
        #results-container>div::-webkit-scrollbar,
        #results-container::-webkit-scrollbar {
            width: 0 !important;
            height: 0 !important;
        }
    </style>


    <!-- Script for handling HTMX search -->
    <script>
        let searchInProgress = false;
        let searchTimeout;

        // Function to handle search input
        function handleSearchInput(event) {
            if (searchInProgress) return;

            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                const searchTerm = event.target.value.trim();
                if (searchTerm.length >= 3) {
                    searchInProgress = true;
                    trackSearch(searchTerm);
                    fetchSearchResults(searchTerm);
                }
            }, 1000);
        }

        // Function to handle search submission
        function handleKeyPress(event) {
            if (event.key === 'Enter' && !searchInProgress) {
                event.preventDefault();
                const searchValue = document.getElementById('search-input').value.trim();
                if (searchValue.length >= 3) {
                    searchInProgress = true;
                    toggleSpinner(true);
                    trackSearch(searchValue);
                    fetchSearchResults(searchValue);
                }
            }
        }

        // Define the handler function outside so we can reuse it
        function attachOpportunityHandlers() {
            document.querySelectorAll('.opportunity-link').forEach(link => {
                // Remove any existing click handlers
                const newLink = link.cloneNode(true);
                link.parentNode.replaceChild(newLink, link);

                newLink.addEventListener('click', function (e) {
                    e.preventDefault();
                    e.stopPropagation();

                    const keywords = this.dataset.keywords || '';
                    const categoryAnalysis = analyzeKeywords(keywords);

                    const eventData = {
                        'opportunity_name': this.dataset.name,
                        'country': this.dataset.country || 'sin país',
                        'opportunity_keywords': keywords,
                        'opportunity_type': categoryAnalysis.primaryCategory,
                        'opportunity_secondary_type': categoryAnalysis.secondaryCategory,
                        'event_category': 'Oportunidad',
                        'section': 'main'
                    };

                    console.log('Sending event data:', eventData);
                    gtag('event', 'opportunity_click', eventData);

                    // Create and trigger a hidden link
                    const a = document.createElement('a');
                    a.href = this.dataset.url;
                    a.rel = 'noopener noreferrer';
                    a.target = '_blank';
                    document.body.appendChild(a);

                    // Trigger click
                    a.click();

                    // Remove the element and force focus back to current window
                    requestAnimationFrame(() => {
                        document.body.removeChild(a);
                        window.focus();
                    });

                    return false;
                });
            });
        }

        // Initial attachment of handlers
        document.addEventListener('DOMContentLoaded', attachOpportunityHandlers);

        // Function to fetch search results
        function fetchSearchResults(searchValue) {
            const spinner = document.getElementById('spinner');
            if (spinner) {
                spinner.style.display = 'block';
            }

            const searchResult = expandSearchTerms(searchValue);
            console.log('Search payload:', searchResult);

            const queryParams = new URLSearchParams({
                search: searchResult.terms,
                expanded: searchResult.expanded
            });

            fetch(`/database?${queryParams.toString()}`, {
                headers: {
                    'HX-Request': 'true',
                    'HX-Trigger': 'search'
                }
            })
                .then(response => response.text())
                .then(html => {
                    const searchResults = document.getElementById('search-results');
                    searchResults.innerHTML = html;

                    // Re-apply grid classes to parent elements
                    const firstColumn = document.querySelector('.col-span-1.md\\:col-span-5.lg\\:col-span-4');
                    const secondColumn = document.querySelector('.col-span-1.md\\:col-span-7.lg\\:col-span-8');

                    if (firstColumn) {
                        firstColumn.className = 'col-span-1 md:col-span-5 lg:col-span-4 md:border-r border-neutral flex flex-col justify-between';
                    }
                    if (secondColumn) {
                        secondColumn.className = 'col-span-1 md:col-span-7 lg:col-span-8 mt-2 lg:mt-0 border-neutral';
                    }

                    scrollToTop('results-container');
                    setupSearchHandlers();
                    attachOpportunityHandlers();
                })
                .catch(error => {
                    console.error('Search error:', error);
                    trackSearchError(searchValue, 'fetch_error');
                })
                .finally(() => {
                    if (spinner) {
                        spinner.style.display = 'none';
                    }
                    searchInProgress = false;
                });
        }

        // Function to clear search
        function clearSearch() {
            const searchInput = document.getElementById('search-input');
            if (searchInput) {
                searchInput.value = '';

                if (!searchInProgress) {
                    searchInProgress = true;
                    toggleSpinner(true);

                    fetch('/database?clear=true', {
                        headers: { 'HX-Request': 'true' }
                    })
                        .then(response => response.text())
                        .then(html => {
                            document.getElementById('search-results').innerHTML = html;
                            scrollToTop('results-container');
                            setupSearchHandlers(); // Reattach handlers after clearing
                            attachOpportunityHandlers();

                            // Actualizar la URL en el historial del navegador
                            history.pushState(null, '', '/database');
                        })
                        .catch(error => {
                            console.error('Clear error:', error);
                        })
                        .finally(() => {
                            searchInProgress = false;
                            toggleSpinner(false);
                        });
                }
            }
        }

        // Function to toggle spinner visibility
        function toggleSpinner(show) {
            const spinner = document.getElementById('spinner');
            if (spinner) {
                spinner.style.display = show ? 'block' : 'none';
            }
        }

        // Function to scroll to top of an element
        function scrollToTop(id) {
            const element = document.getElementById(id);
            if (element) {
                element.scrollTop = 0;
            }
        }

        // Function to track search events
        function trackSearch(searchTerm) {
            gtag('event', 'opportunity_search', {
                send_to: 'G-36M4V4L5RX',
                search_term: searchTerm,
                search_type: 'opportunity'
            });
        }

        // Function to track search errors
        function trackSearchError(searchTerm, errorType) {
            gtag('event', 'search_error', {
                search_term: searchTerm,
                error_type: errorType
            });
        }

        // Function to sanitize keywords
        function sanitizeKeywords(keywords) {
            if (!keywords) return '';

            // Si keywords es un string JSON, parsearlo primero
            try {
                if (typeof keywords === 'string') {
                    keywords = JSON.parse(keywords);
                }
            } catch (e) {
                console.warn('Error parsing keywords:', e);
            }

            // Mapa de reemplazo de caracteres especiales
            const replacements = {
                '\u00ed': 'í',
                '\u00e1': 'á',
                '\u00e9': 'é',
                '\u00f3': 'ó',
                '\u00fa': 'ú',
                '\u00f1': 'ñ'
            };

            // Si keywords es un string, aplicar reemplazos
            if (typeof keywords === 'string') {
                Object.entries(replacements).forEach(([code, char]) => {
                    keywords = keywords.replace(new RegExp(code, 'g'), char);
                });
                return keywords;
            }

            // Si keywords es un array, aplicar a cada elemento
            if (Array.isArray(keywords)) {
                return keywords.map(k => {
                    if (typeof k === 'string') {
                        Object.entries(replacements).forEach(([code, char]) => {
                            k = k.replace(new RegExp(code, 'g'), char);
                        });
                    }
                    return k;
                });
            }

            return keywords;
        }

        // Simplified GA4 configuration for production domain only
        gtag('config', 'G-36M4V4L5RX', {
            send_page_view: true,
            link_attribution: false,
            enhanced_link_attribution: false,
            enhanced_measurement: false,
            cookie_domain: 'oportunidades.lat'
        });

        // Enhanced categories based on actual data patterns
        function analyzeKeywords(keywords) {
            const categories = {
                // Funding Types (Tipos de Financiación)
                beca: [
                    'beca', 'becas', 'scholarship', 'fellowship', 'grant',
                    'financiacion', 'financiamiento', 'apoyo economico', 'stipend'
                ],

                residencia: [
                    'residencia', 'residency', 'artist in residence',
                    'estancia artistica', 'art residency', 'creative residency'
                ],

                premio: [
                    'premio', 'award', 'concurso', 'certamen', 'competition',
                    'reconocimiento', 'prize', 'contest'
                ],

                // Artistic Fields (Campos Artísticos)
                artes_visuales: [
                    'arte visual', 'pintura', 'escultura', 'artes plasticas',
                    'visual art', 'fine arts', 'arte contemporaneo',
                    'contemporary art', 'mixed media'
                ],

                fotografia: [
                    'fotografia', 'photography', 'photo', 'fotografica',
                    'photoespana', 'fotorreportaje', 'fotoperiodismo'
                ],

                audiovisual: [
                    'cine', 'film', 'video', 'documental', 'cortometraje',
                    'cinematografia', 'audiovisual', 'animacion'
                ],

                performing_arts: [
                    'teatro', 'danza', 'performance', 'escenicas',
                    'performing arts', 'theatre', 'dance', 'circo'
                ],

                // Academic/Professional Development
                formacion: [
                    'formacion', 'curso', 'taller', 'workshop', 'masterclass',
                    'training', 'education', 'professional development'
                ],

                investigacion: [
                    'investigacion', 'research', 'academic', 'estudio',
                    'desarrollo', 'phd', 'doctorado', 'thesis'
                ],

                // Format/Platform
                digital: [
                    'digital', 'virtual', 'online', 'tecnologia',
                    'new media', 'net art', 'digital art'
                ],

                exposicion: [
                    'exposicion', 'exhibition', 'muestra', 'gallery',
                    'exhibicion', 'galeria'
                ],

                festival: [
                    'festival', 'bienal', 'feria', 'biennial',
                    'fair', 'encuentro', 'trienal'
                ]
            };

            const normalizedKeywords = keywords.toLowerCase()
                .normalize("NFD")
                .replace(/[\u0300-\u036f]/g, ""); // Remove diacritics

            const matchedCategories = [];
            for (const [category, keywordList] of Object.entries(categories)) {
                if (keywordList.some(keyword => normalizedKeywords.includes(keyword))) {
                    matchedCategories.push(category);
                }
            }

            return {
                primaryCategory: matchedCategories[0] || 'sin_categorizar',
                secondaryCategory: matchedCategories[1] || '',
                allCategories: matchedCategories // Useful for deeper analysis
            };
        }

        // GA4 country tracking
        function trackOpportunityView(opportunity) {
            gtag('event', 'view_opportunity', {
                'page_title': opportunity.nombre,
                'country': opportunity.País,
                'opportunity_type': opportunity.matchedCategories.join(',')
            });
        }

        // Add debug logging
        document.addEventListener('DOMContentLoaded', function () {
            console.log('Attaching click handlers...');

            // Remove any existing handlers first
            document.querySelectorAll('.opportunity-link').forEach(link => {
                const clone = link.cloneNode(true);
                link.parentNode.replaceChild(clone, link);
            });

            // Attach new handlers
            document.querySelectorAll('.opportunity-link').forEach(link => {
                console.log('Attaching handler to:', link.dataset.name);

                link.addEventListener('click', function (e) {
                    e.preventDefault();
                    e.stopPropagation();

                    console.log('Click handler fired for:', this.dataset.name);

                    const keywords = this.dataset.keywords || '';
                    const categoryAnalysis = analyzeKeywords(keywords);

                    const eventData = {
                        'opportunity_name': this.dataset.name,
                        'country': this.dataset.country || 'sin país',
                        'opportunity_keywords': keywords,
                        'opportunity_type': categoryAnalysis.primaryCategory,
                        'opportunity_secondary_type': categoryAnalysis.secondaryCategory,
                        'event_category': 'Oportunidad',
                        'section': 'main'
                    };

                    console.log('Sending event data:', eventData);
                    gtag('event', 'opportunity_click', eventData);

                    setTimeout(() => {
                        window.open(this.dataset.url, '_blank', 'noopener,noreferrer');
                    }, 100);
                });
            });
        });

        // Remove any other click handlers
        if (typeof handleOpportunityClick === 'function') {
            delete window.handleOpportunityClick;
        }

        // Add validation function
        function validateCategories(opportunity) {
            if (!opportunity.matchedCategories || opportunity.matchedCategories.length === 0) {
                console.warn(`Warning: No categories matched for opportunity: ${opportunity.title}`);
            }

            // Check for potentially missing categories
            const keywords = opportunity.keywords.toLowerCase();
            const uncategorizedKeywords = findUncategorizedKeywords(keywords);
            if (uncategorizedKeywords.length > 0) {
                console.warn(`Potential new keywords found: ${uncategorizedKeywords.join(', ')}`);
            }
        }

        function handleOpportunityClick(element) {
            // Get data from element
            const keywords = element.dataset.keywords || '';
            const name = element.dataset.name || '';
            const country = element.dataset.country || 'sin país';
            const url = element.dataset.url;

            // Analyze categories from keywords
            const categoryAnalysis = analyzeKeywords(keywords);

            // Prepare event data for GA4
            const eventData = {
                'opportunity_name': name,
                'country': country,
                'opportunity_keywords': keywords,
                'opportunity_type': categoryAnalysis.primaryCategory,      // Primary category
                'opportunity_secondary_type': categoryAnalysis.secondaryCategory,  // Secondary category
                'event_category': 'Oportunidad',
                'section': 'main'
            };

            // Log for debugging
            console.log('Sending to GA4:', eventData);

            // Send to GA4
            gtag('event', 'opportunity_click', eventData);

            // Navigate after tracking
            setTimeout(() => {
                window.open(url, '_blank', 'noopener,noreferrer');
            }, 100);
        }

        function handleDestacadaClick(element) {
            const eventData = {
                'opportunity_name': element.dataset.name,
                'country': element.dataset.country || 'sin país',
                'section': 'destacadas',
                'event_category': 'Accordion'
            };

            gtag('event', 'destacadas_click', eventData);  // This specific event name

            window.open(element.dataset.url, '_blank', 'noopener,noreferrer');
        }

        function handleCierranProntoClick(element) {
            const eventData = {
                'opportunity_name': element.dataset.name,
                'country': element.dataset.country || 'sin país',
                'section': 'cierran_pronto',
                'event_category': 'Accordion'
            };

            gtag('event', 'cierranPronto_click', eventData);  // This specific event name

            window.open(element.dataset.url, '_blank', 'noopener,noreferrer');
        }

        document.addEventListener('DOMContentLoaded', function () {
            // For Cierran Pronto links
            document.querySelectorAll('.cierran-pronto-link').forEach(link => {
                // Remove any existing click handlers
                const newLink = link.cloneNode(true);
                link.parentNode.replaceChild(newLink, link);

                newLink.addEventListener('click', function (e) {
                    e.preventDefault();
                    e.stopPropagation();
                    e.stopImmediatePropagation();  // Stop other handlers

                    const eventData = {
                        'opportunity_name': this.dataset.name,
                        'country': this.dataset.country || 'sin país',
                        'section': 'cierran_pronto',
                        'event_category': 'Accordion',
                        'opportunity_keywords': this.dataset.keywords || ''
                    };

                    // Send our custom event
                    gtag('event', 'cierranPronto_click', eventData);

                    // Navigate after tracking
                    setTimeout(() => {
                        window.open(this.dataset.url, '_blank', 'noopener,noreferrer');
                    }, 100);

                    return false;  // Prevent bubbling
                }, true);  // Use capture phase
            });

            // For Destacadas links
            document.querySelectorAll('.accordion-link').forEach(link => {
                // Remove any existing click handlers
                const newLink = link.cloneNode(true);
                link.parentNode.replaceChild(newLink, link);

                newLink.addEventListener('click', function (e) {
                    e.preventDefault();
                    e.stopPropagation();
                    e.stopImmediatePropagation();  // Stop other handlers

                    const eventData = {
                        'opportunity_name': this.dataset.name,
                        'country': this.dataset.country || 'sin país',
                        'section': 'destacadas',
                        'event_category': 'Accordion',
                        'opportunity_keywords': this.dataset.keywords || ''
                    };

                    // Send our custom event
                    gtag('event', 'destacadas_click', eventData);

                    // Navigate after tracking
                    setTimeout(() => {
                        window.open(this.dataset.url, '_blank', 'noopener,noreferrer');
                    }, 100);

                    return false;  // Prevent bubbling
                }, true);  // Use capture phase
            });
        });

        // Disable GA4's automatic link tracking
        gtag('config', 'G-36M4V4L5RX', {
            send_page_view: true,
            link_attribution: false,
            enhanced_link_attribution: false
        });

        document.addEventListener('DOMContentLoaded', function () {
            // Get total opportunities count
            const totalOpportunities = document.querySelectorAll('.opportunity-link').length;
            console.log('Total opportunities:', totalOpportunities); // Debug log

            document.querySelectorAll('.opportunity-link').forEach(link => {
                const newLink = link.cloneNode(true);
                link.parentNode.replaceChild(newLink, link);

                newLink.addEventListener('click', function (e) {
                    e.preventDefault();
                    e.stopPropagation();

                    const keywords = this.dataset.keywords || '';
                    const categoryAnalysis = analyzeKeywords(keywords);

                    const eventData = {
                        'opportunity_name': this.dataset.name,
                        'country': this.dataset.country || 'sin país',
                        'opportunity_keywords': keywords,
                        'opportunity_type': categoryAnalysis.primaryCategory,
                        'opportunity_secondary_type': categoryAnalysis.secondaryCategory,
                        'event_category': 'Oportunidad',
                        'section': 'main',
                        'total_opportunities': totalOpportunities
                    };

                    console.log('Sending event data with total:', eventData);
                    gtag('event', 'opportunity_click', eventData);

                    // Create and trigger a hidden link
                    const a = document.createElement('a');
                    a.href = this.dataset.url;
                    a.rel = 'noopener noreferrer';
                    a.target = '_blank';
                    document.body.appendChild(a);

                    a.click();

                    requestAnimationFrame(() => {
                        document.body.removeChild(a);
                        window.focus();
                    });

                    return false;
                });
            });
        });

        // Replace the existing SEARCH_CATEGORIES with this refined version
        const SEARCH_CATEGORIES = {
            music: {
                triggers: ['música', 'musica', 'music', 'musical'],
                related: [
                    // Core Music Terms
                    'composición', 'composicion', 'composition',
                    'concierto', 'concert', 'orchestra', 'orquesta',
                    'ópera', 'opera',
                    'interpretación musical', 'interpretacion musical',
                    'dirección musical', 'direccion musical', 'conducting',
                    'sonido musical', 'producción musical',

                    // Instruments and Voice
                    'instrumento', 'instrument', 'piano', 'violin', 'guitarra',
                    'canto', 'singing', 'canción', 'cancion',
                    'banda', 'band', 'ensemble', 'coro', 'choir',

                    // Music Education and Institutions
                    'conservatorio', 'conservatory',
                    'escuela de música', 'escuela de musica',
                    'ibermúsicas', 'ibermusicas',

                    // Music Roles
                    'compositor', 'compositora', 'composer',
                    'músico', 'musico', 'musician',
                    'director musical', 'directora musical',

                    // Educational Terms
                    'beca', 'becas', 'scholarship',
                    'maestría', 'maestria', 'master',
                    'doctorado', 'doctorate', 'phd',
                    'universidad', 'university', 'univ',
                    'facultad', 'faculty',
                    'posgrado', 'postgrado',
                    'licenciatura', 'bachelor',
                    'formación', 'formacion',

                    // General Artist Terms (to catch residencies)
                    'residencia artística', 'residencia artistica',
                    'residencia para artistas', 'artist residency',
                    'residencia de creación', 'residencia de creacion',
                    'artista', 'artistas', 'artist', 'artists'
                ]
            }
        };

        // Normalize text helper function
        function normalizeText(text) {
            return text.toLowerCase()
                .normalize("NFD")
                .replace(/[\u0300-\u036f]/g, "");
        }

        // Update expandSearchTerms to better handle residency terms
        function expandSearchTerms(searchTerm) {
            const normalizedSearch = normalizeText(searchTerm);

            for (const [category, data] of Object.entries(SEARCH_CATEGORIES)) {
                if (data.triggers.some(trigger => {
                    const normalizedTrigger = normalizeText(trigger);
                    return normalizedTrigger === normalizedSearch ||
                        normalizedSearch.includes(normalizedTrigger);
                })) {
                    // Get all terms including residency-related ones
                    const allTerms = new Set([
                        ...data.triggers,
                        ...data.related,
                        // Always include general residency terms
                        'residencia artística', 'residencia artistica',
                        'residencia para artistas', 'artist residency',
                        'residencia de creación', 'residencia de creacion',
                        'artista', 'artistas', 'artist', 'artists'
                    ]);

                    const normalizedTerms = [...allTerms].map(term => normalizeText(term));

                    console.log(`Expanded search for ${searchTerm} to:`, normalizedTerms);
                    return {
                        terms: normalizedTerms.join('|'),
                        expanded: true
                    };
                }
            }

            return {
                terms: searchTerm,
                expanded: false
            };
        }

        // Update the event handling setup
        document.addEventListener('DOMContentLoaded', function () {
            // Initial setup of search input handler
            setupSearchHandlers();
        });

        // Create a new function to setup all search-related handlers
        function setupSearchHandlers() {
            const searchInput = document.getElementById('search-input');
            if (searchInput) {
                // Remove existing listeners first
                const newSearchInput = searchInput.cloneNode(true);
                searchInput.parentNode.replaceChild(newSearchInput, searchInput);

                // Add input event listener
                newSearchInput.addEventListener('input', handleSearchInput);

                // Add keypress event listener
                newSearchInput.addEventListener('keypress', handleKeyPress);
            }
        }

        // Add event listener for HTMX after-swap
        document.body.addEventListener('htmx:afterSwap', function (event) {
            setupSearchHandlers();
            attachOpportunityHandlers();
        });

        document.addEventListener('DOMContentLoaded', function () {
            console.log('HTMX loaded:', typeof htmx !== 'undefined');
            const searchInput = document.getElementById('search-input');
            console.log('Search input found:', searchInput !== null);
            if (searchInput) {
                console.log('HTMX attributes:', {
                    get: searchInput.getAttribute('hx-get'),
                    trigger: searchInput.getAttribute('hx-trigger'),
                    target: searchInput.getAttribute('hx-target')
                });
            }
        });

        // Replace the form submission handling code with this corrected version
        document.addEventListener('DOMContentLoaded', function () {
            const saveForm = document.getElementById('save-form');
            const saveButton = document.getElementById('save-button');
            let isSubmitting = false;

            if (saveForm && saveButton) {
                saveButton.addEventListener('click', function (e) {
                    e.preventDefault();
                    
                    if (isSubmitting) return;

                    const checkedOpportunities = document.querySelectorAll('input[type="checkbox"]:checked');
                    const alertContainer = document.getElementById('alert-container');

                    if (checkedOpportunities.length === 0) {
                        alertContainer.innerHTML = `
                            <div role="alert" class="flex items-center justify-center alert alert-warning p-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-5 w-5" fill="none" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                                </svg>
                            </div>
                        `;
                        setTimeout(() => {
                            alertContainer.innerHTML = '';
                        }, 3000);
                        return;
                    }

                    isSubmitting = true;
                    const formData = new FormData();

                    checkedOpportunities.forEach(checkbox => {
                        formData.append('selected_pages', checkbox.value);
                    });

                    fetch('/save_user_opportunity', {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest'
                        },
                        credentials: 'same-origin'
                    })
                    .then(response => {
                        if (!response.ok) {
                            return response.text().then(text => {
                                throw new Error(text || 'Network response was not ok');
                            });
                        }
                        return response.text();
                    })
                    .then(html => {
                        alertContainer.innerHTML = `
                            <div role="alert" class="flex items-center justify-center alert alert-success p-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-5 w-5" fill="none" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                            </div>
                        `;

                        checkedOpportunities.forEach(checkbox => {
                            checkbox.checked = false;
                        });

                        setTimeout(() => {
                            alertContainer.innerHTML = '';
                        }, 3000);
                    })
                    .catch(error => {
                        alertContainer.innerHTML = `
                            <div role="alert" class="flex items-center justify-center alert alert-error p-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-5 w-5" fill="none" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                            </div>
                        `;

                        setTimeout(() => {
                            alertContainer.innerHTML = '';
                        }, 3000);
                    })
                    .finally(() => {
                        isSubmitting = false;
                    });
                });
            }
        });

        // Remove the previous HTMX event listeners since we're handling it with fetch now

        function redirectToLogin() {
            window.location.href = "{{ url_for('login', next=request.path) }}";
        }

        window.addEventListener('popstate', function(event) {
            // Recargar la página o restablecer el estado
            location.reload();
        });
    </script>


</body>
{% endblock %}