{% extends 'layout.html' %}

{% block body %}

<body>
    <div class="max-w-[1400px] mx-auto px-2 md:px-8 -mt-10">
        <!-- Title section -->
        <div class="mb-8 md:mb-20">
            <h1 class="text-3xl md:text-4xl font-bold text-black leading-none md:leading-tight tracking-tight mt-4 md:mt-12 md:mt-0 ml-4">
                Informate, compartí y guardá oportunidades, gratis. 
            </h1>
        </div>

        <!-- Main content -->
        <main class="w-full relative">
            <div class="grid grid-cols-1 md:grid-cols-12 gap-0">
                <!-- First Column: Accordions -->
                <div class="col-span-1 md:col-span-5 lg:col-span-4 md:border-r border-neutral flex flex-col justify-between">
                    <div class="flex flex-col gap-2">
                        <!-- Accordion 1 -->
                        <div class="join join-vertical w-full">
                            <div class="collapse join-item border-b border-neutral rounded-none w-full">
                                <input type="radio" name="my-accordion-1" checked="" />
                                <div class="collapse-title text-sm tracking-tighter text-neutral-700 inline-block">
                                    <span class="md:border border-neutral-300 md:px-4 md:py-2">
                                        CIERRAN PRONTO
                                    </span>
                                </div>
                                <div class="collapse-content w-full">
                                    {% if closing_soon_pages %}
                                    {% for page in closing_soon_pages %}
                                    <p class="relative">
                                        <a href="{{ page.url }}" target="_blank"
                                            data-name="{{ page.nombre }}"
                                            data-country="{{ page.País }}"
                                            data-url="{{ page.url }}"
                                            class="cierran-pronto-link">
                                            {{ page.nombre | truncate(50) }}
                                            <span
                                                class="absolute right-0 top-1/2 transform -translate-y-1/2 flex items-center justify-center -mr-1">
                                                <span
                                                    class="flex items-center justify-center group-hover:bg-slate-200 group-hover:rounded-md transition-all duration-200 p-2">
                                                    <svg class="w-3 h-3 z-10" data-slot="icon" fill="none"
                                                        stroke-width="1.5" stroke="currentColor" viewBox="0 0 24 24"
                                                        xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                                                        <path stroke-linecap="round" stroke-linejoin="round"
                                                            d="m4.5 19.5 15-15m0 0H8.25m11.25 0v11.25"></path>
                                                    </svg>
                                                </span>
                                            </span>
                                        </a>
                                    </p>
                                    {% endfor %}
                                    {% else %}
                                    <p>No hay oportunidades este mes.</p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        <!-- Accordion 2 -->
                        <div class="join join-vertical w-full">
                            <div class="collapse join-item border-neutral rounded-none w-full">
                                <input type="radio" name="my-accordion-2" checked="" />
                                <div class="collapse-title text-sm tracking-tighter text-neutral-700 inline-block md:mt">
                                    <span class="md:border border-neutral-300 md:px-4 md:py-2">
                                        DESTACADAS
                                    </span>
                                </div>
                                <div class="collapse-content w-full">
                                    {% if destacar_pages %}
                                    {% for page in destacar_pages %}
                                    <p class="relative">
                                        <a href="{{ page.url }}" target="_blank"
                                            data-name="{{ page.nombre }}"
                                            data-country="{{ page.País }}"
                                            data-url="{{ page.url }}"
                                            class="accordion-link"
                                            onclick="handleDestacadaClick(this)">
                                            <span class="md:hidden whitespace-nowrap">
                                                {{ page.nombre | truncate(18, true, "...") }}
                                                {% if page.entidad %}
                                                    / <span class="bg-gray-200 bg-opacity-75 backdrop-blur-md px-1 ml-1 whitespace-nowrap">
                                                        {{ page.entidad | truncate(12, true, "...") }}
                                                    </span>
                                                {% endif %}
                                            </span>
                                            <span class="hidden md:inline whitespace-nowrap">
                                                {{ page.nombre | truncate(25, true, "...") }}
                                                {% if page.entidad %}
                                                    / <span class="bg-gray-200 bg-opacity-75 backdrop-blur-md px-1 ml-1 whitespace-nowrap">
                                                        {{ page.entidad | truncate(12, true, "...") }}
                                                    </span>
                                                {% endif %}
                                            </span>
                                            <span
                                                class="absolute right-0 top-1/2 transform -translate-y-1/2 flex items-center justify-center -mr-2">
                                                <span
                                                    class="flex items-center justify-center group-hover:bg-slate-200 group-hover:rounded-md transition-all duration-200 p-2">
                                                    <svg class="w-3 h-3 z-10" data-slot="icon" fill="none"
                                                        stroke-width="1.5" stroke="currentColor" viewBox="0 0 24 24"
                                                        xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                                                        <path stroke-linecap="round" stroke-linejoin="round"
                                                            d="m4.5 19.5 15-15m0 0H8.25m11.25 0v11.25"></path>
                                                    </svg>
                                                </span>
                                            </span>
                                        </a>
                                    </p>
                                    {% endfor %}
                                    {% else %}
                                    <p>Vuelva a intentar</p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Search Input -->
                    <div class="flex items-center relative w-full">
                        <input 
                            type="text" 
                            id="search-input" 
                            placeholder="Buscar por nombre, tipo o mes"
                            class="input input-bordered rounded-none w-full pl-6 lg:ml-0 focus:ring-0 focus:ring-offset-0 focus:ring-inset md:border-r-0 bg-slate-100"
                            name="search" 
                            onkeypress="handleKeyPress(event)"
                        >
                        <div class="absolute right-2 top-1/2 transform -translate-y-1/2 cursor-pointer"
                            onclick="clearSearch()">
                            <svg class="w-4 h-4" fill="none" stroke-width="1.5" stroke="currentColor" viewBox="0 0 24 24"
                                xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12"></path>
                            </svg>
                        </div>
                    </div>
                    <!-- Spinner -->
                    <div id="spinner" class="spinner h-8 w-8">
                        <img src="/static/public/spinner.gif" alt="Loading...">
                    </div>
                </div>

                <!-- Second Column: Table -->
                <div class="col-span-1 md:col-span-7 lg:col-span-8 mt-2 lg:mt-0 border-neutral">
                    <form id="save-form" hx-post="/save_user_opportunity" hx-trigger="submit" hx-swap="innerHTML"
                        hx-target="#alert-container">
                        <div class="border-b border-neutral" id="results-container">
                            <div class="max-h-[35rem] min-h-[20rem] overflow-auto pl-4 md:pl-0 custom-scrollbar md:border-t border-black md:border-r md:border-r-black" >
                                <table class="w-full h-full relative md:top-3">
                                    <thead>
                                        <tr class="my-4">
                                            <th class="w-10">✓</th>
                                            <th class="w-1/4 text-xs tracking-tighter text-neutral-700 text-center md:pr-28 uppercase">Oportunidad</th>
                                            <th class="w-1/4 text-xs tracking-tighter text-neutral-700 uppercase text-start md:text-center pl-6 md:pl-0 md:pr-4">Descripción</th>
                                            <th class="flex-1"></th>
                                        </tr>
                                    </thead>
                                    <tbody id="search-results" class="relative top-2">
                                        {% include "_search_results.html" %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="flex justify-center items-center space-x-2 mt-6 mb-4">
                            <div id="alert-container" class="flex items-center"></div>
                            <button type="submit"
                                class="uppercase text-sm font-black tracking-tighter text-neutral-700">Guardar
                                Seleccionados</button>
                        </div>
                    </form>
                </div>

                <!-- Third Column: Empty Container -->
                <!-- <div class="hidden md:block col-span-1 mt-2 lg:mt-0 flex flex-col relative left-3" style="width: 40px;">
                    <div class="bg-orange-500 rounded-t-md" style="height: 20px;"></div>
                    <div class="bg-black" style="height: 20px;"></div>
                    <div class="bg-[#0cc7c7]" style="height: 20px;"></div>
                    <div class="bg-[#10e07f] rounded-b-md" style="height: 20px;"></div>
                    <div class="flex justify-center relative top-8 animate-bounce">
                        <svg class="w-6 h-6" data-slot="icon" fill="none" stroke-width="1.5" stroke="currentColor"
                            viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 13.5 12 21m0 0-7.5-7.5M12 21V3">
                            </path>
                        </svg>
                    </div>
                </div> -->
            </div>
        </main>
        {% include 'footer.html' %}
    </div>


    <style>
        .spinner {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
        }

        /* Improve touch scrolling behavior */
        #results-container > div {
            -webkit-overflow-scrolling: touch;
            scroll-behavior: smooth;
        }

        /* Ensure the container can be scrolled in both directions */
        .overflow-auto {
            overscroll-behavior: auto;
        }
    </style>
 

    <!-- Script for handling HTMX search -->
    <script>
        let searchInProgress = false;
        let searchTimeout;

        // Function to handle search input
        function handleSearchInput(event) {
            if (searchInProgress) return;
            
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                const searchTerm = event.target.value.trim();
                if (searchTerm.length >= 3) {
                    searchInProgress = true;
                    trackSearch(searchTerm);
                    fetchSearchResults(searchTerm);
                }
            }, 1000);
        }

        // Function to handle search submission
        function handleKeyPress(event) {
            if (event.key === 'Enter' && !searchInProgress) {
                event.preventDefault();
                const searchValue = document.getElementById('search-input').value.trim();
                if (searchValue.length >= 3) {
                    searchInProgress = true;
                    toggleSpinner(true);
                    trackSearch(searchValue);
                    fetchSearchResults(searchValue);
                }
            }
        }

        // Define the handler function outside so we can reuse it
        function attachOpportunityHandlers() {
            document.querySelectorAll('.opportunity-link').forEach(link => {
                // Remove any existing click handlers
                const newLink = link.cloneNode(true);
                link.parentNode.replaceChild(newLink, link);

                newLink.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();

                    const keywords = this.dataset.keywords || '';
                    const categoryAnalysis = analyzeKeywords(keywords);

                    const eventData = {
                        'opportunity_name': this.dataset.name,
                        'country': this.dataset.country || 'sin país',
                        'opportunity_keywords': keywords,
                        'opportunity_type': categoryAnalysis.primaryCategory,
                        'opportunity_secondary_type': categoryAnalysis.secondaryCategory,
                        'event_category': 'Oportunidad',
                        'section': 'main'
                    };

                    console.log('Sending event data:', eventData);
                    gtag('event', 'opportunity_click', eventData);

                    // Create and trigger a hidden link
                    const a = document.createElement('a');
                    a.href = this.dataset.url;
                    a.rel = 'noopener noreferrer';
                    a.target = '_blank';
                    document.body.appendChild(a);
                    
                    // Trigger click
                    a.click();
                    
                    // Remove the element and force focus back to current window
                    requestAnimationFrame(() => {
                        document.body.removeChild(a);
                        window.focus();
                    });
                    
                    return false;
                });
            });
        }

        // Initial attachment of handlers
        document.addEventListener('DOMContentLoaded', attachOpportunityHandlers);

        // Function to fetch search results
        function fetchSearchResults(searchValue) {
            const spinner = document.getElementById('spinner');
            spinner.style.display = 'block';

            const searchResult = expandSearchTerms(searchValue);
            console.log('Search payload:', searchResult);
            
            const queryParams = new URLSearchParams({
                search: searchResult.terms,
                expanded: searchResult.expanded
            });

            fetch(`/database?${queryParams.toString()}`, {
                headers: { 'HX-Request': 'true' }
            })
            .then(response => response.text())
            .then(html => {
                document.getElementById('search-results').innerHTML = html;
                scrollToTop('results-container');
                setupSearchHandlers(); // Reattach handlers after search
                attachOpportunityHandlers();
            })
            .catch(error => {
                console.error('Search error:', error);
                trackSearchError(searchValue, 'fetch_error');
            })
            .finally(() => {
                spinner.style.display = 'none';
                searchInProgress = false; // Reset search flag
            });
        }

        // Function to clear search
        function clearSearch() {
            const searchInput = document.getElementById('search-input');
            if (searchInput) {
                searchInput.value = '';
                
                if (!searchInProgress) {
                    searchInProgress = true;
                    toggleSpinner(true);
                    
                    fetch('/database?clear=true', {
                        headers: { 'HX-Request': 'true' }
                    })
                    .then(response => response.text())
                    .then(html => {
                        document.getElementById('search-results').innerHTML = html;
                        scrollToTop('results-container');
                        setupSearchHandlers(); // Reattach handlers after clearing
                        attachOpportunityHandlers();
                    })
                    .catch(error => {
                        console.error('Clear error:', error);
                    })
                    .finally(() => {
                        searchInProgress = false;
                        toggleSpinner(false);
                    });
                }
            }
        }

        // Function to toggle spinner visibility
        function toggleSpinner(show) {
            const spinner = document.getElementById('spinner');
            spinner.style.display = show ? 'block' : 'none';
        }

        // Function to scroll to top of an element
        function scrollToTop(id) {
            const element = document.getElementById(id);
            if (element) {
                element.scrollTop = 0;
            }
        }

        // Function to track search events
        function trackSearch(searchTerm) {
            gtag('event', 'opportunity_search', {
                send_to: 'G-36M4V4L5RX',
                search_term: searchTerm,
                search_type: 'opportunity'
            });
        }

        // Function to track search errors
        function trackSearchError(searchTerm, errorType) {
            gtag('event', 'search_error', {
                search_term: searchTerm,
                error_type: errorType
            });
        }

        // Function to sanitize keywords
        function sanitizeKeywords(keywords) {
            if (!keywords) return '';
            
            // Si keywords es un string JSON, parsearlo primero
            try {
                if (typeof keywords === 'string') {
                    keywords = JSON.parse(keywords);
                }
            } catch (e) {
                console.warn('Error parsing keywords:', e);
            }

            // Mapa de reemplazo de caracteres especiales
            const replacements = {
                '\u00ed': 'í',
                '\u00e1': 'á',
                '\u00e9': 'é',
                '\u00f3': 'ó',
                '\u00fa': 'ú',
                '\u00f1': 'ñ'
            };

            // Si keywords es un string, aplicar reemplazos
            if (typeof keywords === 'string') {
                Object.entries(replacements).forEach(([code, char]) => {
                    keywords = keywords.replace(new RegExp(code, 'g'), char);
                });
                return keywords;
            }

            // Si keywords es un array, aplicar a cada elemento
            if (Array.isArray(keywords)) {
                return keywords.map(k => {
                    if (typeof k === 'string') {
                        Object.entries(replacements).forEach(([code, char]) => {
                            k = k.replace(new RegExp(code, 'g'), char);
                        });
                    }
                    return k;
                });
            }

            return keywords;
        }

        // Simplified GA4 configuration for production domain only
        gtag('config', 'G-36M4V4L5RX', {
            send_page_view: true,
            link_attribution: false,
            enhanced_link_attribution: false,
            enhanced_measurement: false,
            cookie_domain: 'oportunidades.lat'
        });

        // Enhanced categories based on actual data patterns
        function analyzeKeywords(keywords) {
            const categories = {
                // Funding Types (Tipos de Financiación)
                beca: [
                    'beca', 'becas', 'scholarship', 'fellowship', 'grant',
                    'financiacion', 'financiamiento', 'apoyo economico', 'stipend'
                ],
                
                residencia: [
                    'residencia', 'residency', 'artist in residence', 
                    'estancia artistica', 'art residency', 'creative residency'
                ],
                
                premio: [
                    'premio', 'award', 'concurso', 'certamen', 'competition',
                    'reconocimiento', 'prize', 'contest'
                ],

                // Artistic Fields (Campos Artísticos)
                artes_visuales: [
                    'arte visual', 'pintura', 'escultura', 'artes plasticas',
                    'visual art', 'fine arts', 'arte contemporaneo',
                    'contemporary art', 'mixed media'
                ],
                
                fotografia: [
                    'fotografia', 'photography', 'photo', 'fotografica',
                    'photoespana', 'fotorreportaje', 'fotoperiodismo'
                ],
                
                audiovisual: [
                    'cine', 'film', 'video', 'documental', 'cortometraje',
                    'cinematografia', 'audiovisual', 'animacion'
                ],
                
                performing_arts: [
                    'teatro', 'danza', 'performance', 'escenicas',
                    'performing arts', 'theatre', 'dance', 'circo'
                ],

                // Academic/Professional Development
                formacion: [
                    'formacion', 'curso', 'taller', 'workshop', 'masterclass',
                    'training', 'education', 'professional development'
                ],
                
                investigacion: [
                    'investigacion', 'research', 'academic', 'estudio',
                    'desarrollo', 'phd', 'doctorado', 'thesis'
                ],

                // Format/Platform
                digital: [
                    'digital', 'virtual', 'online', 'tecnologia',
                    'new media', 'net art', 'digital art'
                ],
                
                exposicion: [
                    'exposicion', 'exhibition', 'muestra', 'gallery',
                    'exhibicion', 'galeria'
                ],
                
                festival: [
                    'festival', 'bienal', 'feria', 'biennial',
                    'fair', 'encuentro', 'trienal'
                ]
            };

            const normalizedKeywords = keywords.toLowerCase()
                .normalize("NFD")
                .replace(/[\u0300-\u036f]/g, ""); // Remove diacritics

            const matchedCategories = [];
            for (const [category, keywordList] of Object.entries(categories)) {
                if (keywordList.some(keyword => normalizedKeywords.includes(keyword))) {
                    matchedCategories.push(category);
                }
            }

            return {
                primaryCategory: matchedCategories[0] || 'sin_categorizar',
                secondaryCategory: matchedCategories[1] || '',
                allCategories: matchedCategories // Useful for deeper analysis
            };
        }

        // GA4 country tracking
        function trackOpportunityView(opportunity) {
            gtag('event', 'view_opportunity', {
                'page_title': opportunity.nombre,
                'country': opportunity.País,
                'opportunity_type': opportunity.matchedCategories.join(',')
            });
        }

        // Add debug logging
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Attaching click handlers...');
            
            // Remove any existing handlers first
            document.querySelectorAll('.opportunity-link').forEach(link => {
                const clone = link.cloneNode(true);
                link.parentNode.replaceChild(clone, link);
            });
            
            // Attach new handlers
            document.querySelectorAll('.opportunity-link').forEach(link => {
                console.log('Attaching handler to:', link.dataset.name);
                
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    console.log('Click handler fired for:', this.dataset.name);
                    
                    const keywords = this.dataset.keywords || '';
                    const categoryAnalysis = analyzeKeywords(keywords);
                    
                    const eventData = {
                        'opportunity_name': this.dataset.name,
                        'country': this.dataset.country || 'sin país',
                        'opportunity_keywords': keywords,
                        'opportunity_type': categoryAnalysis.primaryCategory,
                        'opportunity_secondary_type': categoryAnalysis.secondaryCategory,
                        'event_category': 'Oportunidad',
                        'section': 'main'
                    };
                    
                    console.log('Sending event data:', eventData);
                    gtag('event', 'opportunity_click', eventData);
                    
                    setTimeout(() => {
                        window.open(this.dataset.url, '_blank', 'noopener,noreferrer');
                    }, 100);
                });
            });
        });

        // Remove any other click handlers
        if (typeof handleOpportunityClick === 'function') {
            delete window.handleOpportunityClick;
        }

        // Add validation function
        function validateCategories(opportunity) {
            if (!opportunity.matchedCategories || opportunity.matchedCategories.length === 0) {
                console.warn(`Warning: No categories matched for opportunity: ${opportunity.title}`);
            }
            
            // Check for potentially missing categories
            const keywords = opportunity.keywords.toLowerCase();
            const uncategorizedKeywords = findUncategorizedKeywords(keywords);
            if (uncategorizedKeywords.length > 0) {
                console.warn(`Potential new keywords found: ${uncategorizedKeywords.join(', ')}`);
            }
        }

        function handleOpportunityClick(element) {
            // Get data from element
            const keywords = element.dataset.keywords || '';
            const name = element.dataset.name || '';
            const country = element.dataset.country || 'sin país';
            const url = element.dataset.url;

            // Analyze categories from keywords
            const categoryAnalysis = analyzeKeywords(keywords);

            // Prepare event data for GA4
            const eventData = {
                'opportunity_name': name,
                'country': country,
                'opportunity_keywords': keywords,
                'opportunity_type': categoryAnalysis.primaryCategory,      // Primary category
                'opportunity_secondary_type': categoryAnalysis.secondaryCategory,  // Secondary category
                'event_category': 'Oportunidad',
                'section': 'main'
            };

            // Log for debugging
            console.log('Sending to GA4:', eventData);

            // Send to GA4
            gtag('event', 'opportunity_click', eventData);

            // Navigate after tracking
            setTimeout(() => {
                window.open(url, '_blank', 'noopener,noreferrer');
            }, 100);
        }

        function handleDestacadaClick(element) {
            const eventData = {
                'opportunity_name': element.dataset.name,
                'country': element.dataset.country || 'sin país',
                'section': 'destacadas',
                'event_category': 'Accordion'
            };
            
            gtag('event', 'destacadas_click', eventData);  // This specific event name
            
            window.open(element.dataset.url, '_blank', 'noopener,noreferrer');
        }

        function handleCierranProntoClick(element) {
            const eventData = {
                'opportunity_name': element.dataset.name,
                'country': element.dataset.country || 'sin país',
                'section': 'cierran_pronto',
                'event_category': 'Accordion'
            };
            
            gtag('event', 'cierranPronto_click', eventData);  // This specific event name
            
            window.open(element.dataset.url, '_blank', 'noopener,noreferrer');
        }

        document.addEventListener('DOMContentLoaded', function() {
            // For Cierran Pronto links
            document.querySelectorAll('.cierran-pronto-link').forEach(link => {
                // Remove any existing click handlers
                const newLink = link.cloneNode(true);
                link.parentNode.replaceChild(newLink, link);
                
                newLink.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    e.stopImmediatePropagation();  // Stop other handlers
                    
                    const eventData = {
                        'opportunity_name': this.dataset.name,
                        'country': this.dataset.country || 'sin país',
                        'section': 'cierran_pronto',
                        'event_category': 'Accordion',
                        'opportunity_keywords': this.dataset.keywords || ''
                    };
                    
                    // Send our custom event
                    gtag('event', 'cierranPronto_click', eventData);
                    
                    // Navigate after tracking
                    setTimeout(() => {
                        window.open(this.dataset.url, '_blank', 'noopener,noreferrer');
                    }, 100);
                    
                    return false;  // Prevent bubbling
                }, true);  // Use capture phase
            });

            // For Destacadas links
            document.querySelectorAll('.accordion-link').forEach(link => {
                // Remove any existing click handlers
                const newLink = link.cloneNode(true);
                link.parentNode.replaceChild(newLink, link);
                
                newLink.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    e.stopImmediatePropagation();  // Stop other handlers
                    
                    const eventData = {
                        'opportunity_name': this.dataset.name,
                        'country': this.dataset.country || 'sin país',
                        'section': 'destacadas',
                        'event_category': 'Accordion',
                        'opportunity_keywords': this.dataset.keywords || ''
                    };
                    
                    // Send our custom event
                    gtag('event', 'destacadas_click', eventData);
                    
                    // Navigate after tracking
                    setTimeout(() => {
                        window.open(this.dataset.url, '_blank', 'noopener,noreferrer');
                    }, 100);
                    
                    return false;  // Prevent bubbling
                }, true);  // Use capture phase
            });
        });

        // Disable GA4's automatic link tracking
        gtag('config', 'G-36M4V4L5RX', {
            send_page_view: true,
            link_attribution: false,
            enhanced_link_attribution: false
        });

        document.addEventListener('DOMContentLoaded', function() {
            // Get total opportunities count
            const totalOpportunities = document.querySelectorAll('.opportunity-link').length;
            console.log('Total opportunities:', totalOpportunities); // Debug log
            
            document.querySelectorAll('.opportunity-link').forEach(link => {
                const newLink = link.cloneNode(true);
                link.parentNode.replaceChild(newLink, link);

                newLink.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();

                    const keywords = this.dataset.keywords || '';
                    const categoryAnalysis = analyzeKeywords(keywords);

                    const eventData = {
                        'opportunity_name': this.dataset.name,
                        'country': this.dataset.country || 'sin país',
                        'opportunity_keywords': keywords,
                        'opportunity_type': categoryAnalysis.primaryCategory,
                        'opportunity_secondary_type': categoryAnalysis.secondaryCategory,
                        'event_category': 'Oportunidad',
                        'section': 'main',
                        'total_opportunities': totalOpportunities
                    };

                    console.log('Sending event data with total:', eventData);
                    gtag('event', 'opportunity_click', eventData);

                    // Create and trigger a hidden link
                    const a = document.createElement('a');
                    a.href = this.dataset.url;
                    a.rel = 'noopener noreferrer';
                    a.target = '_blank';
                    document.body.appendChild(a);
                    
                    a.click();
                    
                    requestAnimationFrame(() => {
                        document.body.removeChild(a);
                        window.focus();
                    });
                    
                    return false;
                });
            });
        });

        // Replace the existing SEARCH_CATEGORIES with this refined version
        const SEARCH_CATEGORIES = {
            music: {
                triggers: ['música', 'musica', 'music', 'musical'],
                related: [
                    // Core Music Terms
                    'composición', 'composicion', 'composition',
                    'concierto', 'concert', 'orchestra', 'orquesta',
                    'ópera', 'opera',
                    'interpretación musical', 'interpretacion musical',
                    'dirección musical', 'direccion musical', 'conducting',
                    'sonido musical', 'producción musical',
                    
                    // Instruments and Voice
                    'instrumento', 'instrument', 'piano', 'violin', 'guitarra',
                    'canto', 'singing', 'canción', 'cancion',
                    'banda', 'band', 'ensemble', 'coro', 'choir',
                    
                    // Music Education and Institutions
                    'conservatorio', 'conservatory',
                    'escuela de música', 'escuela de musica',
                    'ibermúsicas', 'ibermusicas',
                    
                    // Music Roles
                    'compositor', 'compositora', 'composer',
                    'músico', 'musico', 'musician',
                    'director musical', 'directora musical',
                    
                    // Educational Terms
                    'beca', 'becas', 'scholarship',
                    'maestría', 'maestria', 'master',
                    'doctorado', 'doctorate', 'phd',
                    'universidad', 'university', 'univ',
                    'facultad', 'faculty',
                    'posgrado', 'postgrado',
                    'licenciatura', 'bachelor',
                    'formación', 'formacion',
                    
                    // General Artist Terms (to catch residencies)
                    'residencia artística', 'residencia artistica',
                    'residencia para artistas', 'artist residency',
                    'residencia de creación', 'residencia de creacion',
                    'artista', 'artistas', 'artist', 'artists'
                ]
            }
        };

        // Normalize text helper function
        function normalizeText(text) {
            return text.toLowerCase()
                .normalize("NFD")
                .replace(/[\u0300-\u036f]/g, "");
        }

        // Update expandSearchTerms to better handle residency terms
        function expandSearchTerms(searchTerm) {
            const normalizedSearch = normalizeText(searchTerm);
            
            for (const [category, data] of Object.entries(SEARCH_CATEGORIES)) {
                if (data.triggers.some(trigger => {
                    const normalizedTrigger = normalizeText(trigger);
                    return normalizedTrigger === normalizedSearch || 
                           normalizedSearch.includes(normalizedTrigger);
                })) {
                    // Get all terms including residency-related ones
                    const allTerms = new Set([
                        ...data.triggers,
                        ...data.related,
                        // Always include general residency terms
                        'residencia artística', 'residencia artistica',
                        'residencia para artistas', 'artist residency',
                        'residencia de creación', 'residencia de creacion',
                        'artista', 'artistas', 'artist', 'artists'
                    ]);
                    
                    const normalizedTerms = [...allTerms].map(term => normalizeText(term));
                    
                    console.log(`Expanded search for ${searchTerm} to:`, normalizedTerms);
                    return {
                        terms: normalizedTerms.join('|'),
                        expanded: true
                    };
                }
            }
            
            return {
                terms: searchTerm,
                expanded: false
            };
        }

        // Update the event handling setup
        document.addEventListener('DOMContentLoaded', function() {
            // Initial setup of search input handler
            setupSearchHandlers();
        });

        // Create a new function to setup all search-related handlers
        function setupSearchHandlers() {
            const searchInput = document.getElementById('search-input');
            if (searchInput) {
                // Remove existing listeners first
                const newSearchInput = searchInput.cloneNode(true);
                searchInput.parentNode.replaceChild(newSearchInput, searchInput);
                
                // Add input event listener
                newSearchInput.addEventListener('input', handleSearchInput);
                
                // Add keypress event listener
                newSearchInput.addEventListener('keypress', handleKeyPress);
            }
        }

        // Add event listener for HTMX after-swap
        document.body.addEventListener('htmx:afterSwap', function(event) {
            setupSearchHandlers();
            attachOpportunityHandlers();
        });
    </script>


</body>
{% endblock %}