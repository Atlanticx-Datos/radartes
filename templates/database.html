{% extends 'layout.html' %}

{% block body %}

<body>
    <div id="spinner" class="spinner h-8 w-8" style="display: none;">
        <img src="{{ url_for('static', filename='public/spinner.gif') }}" alt="Loading...">
    </div>

    <div class="px-0 md:px-8 mt-4 md:-mt-10" style="margin-left: -1rem !important; margin-right: -0.5rem !important;">
        <!-- Title section -->
        <div class="mb-5 md:mb-20">
            <h1
                class="text-3xl md:text-4xl font-bold text-black leading-none md:leading-tight tracking-tight mt-6 md:mt-12 md:mt-0 ml-4">
                Informate, compartí y guardá oportunidades, gratis.
            </h1>
        </div>

        <!-- Main content -->
        <main class="w-full relative">
            <div class="grid grid-cols-1 md:grid-cols-12 gap-0">
                <!-- First Column: Accordions -->
                <div
                    class="col-span-1 md:col-span-5 lg:col-span-4 flex flex-col justify-between min-w-0 md:border-r border-neutral">
                    <div class="flex-1 flex flex-col gap-2">
                        <!-- Accordion 1 -->
                        <div class="join join-vertical w-full">
                            <div class="collapse join-item border-b border-neutral rounded-none w-full">
                                <input type="radio" name="my-accordion-1" checked="" />
                                <div class="collapse-title text-sm tracking-tighter text-neutral-700 inline-block">
                                    <span class="md:border border-neutral-300 md:px-4 md:py-2">
                                        CIERRAN PRONTO
                                    </span>
                                </div>
                                <div class="collapse-content w-full">
                                    {% if closing_soon_pages %}
                                    {% for page in closing_soon_pages %}
                                    <p class="relative">
                                        <a href="{{ page.base_url if page.base_url else page.url }}" target="_blank" data-name="{{ page.nombre }}"
                                            data-country="{{ page.País }}" data-url="{{ page.url }}"
                                            class="cierran-pronto-link">
                                            {{ page.nombre | truncate(50) }}
                                            <span
                                                class="absolute right-0 top-1/2 transform -translate-y-1/2 flex items-center justify-center -mr-1">
                                                <span
                                                    class="flex items-center justify-center group-hover:bg-slate-200 group-hover:rounded-md transition-all duration-200 p-2">
                                                    <svg class="w-3 h-3 z-10" data-slot="icon" fill="none"
                                                        stroke-width="1.5" stroke="currentColor" viewBox="0 0 24 24"
                                                        xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                                                        <path stroke-linecap="round" stroke-linejoin="round"
                                                            d="m4.5 19.5 15-15m0 0H8.25m11.25 0v11.25"></path>
                                                    </svg>
                                                </span>
                                            </span>
                                        </a>
                                    </p>
                                    {% endfor %}
                                    {% else %}
                                    <p>No hay oportunidades este mes.</p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        <!-- Accordion 2 -->
                        <div class="join join-vertical w-full">
                            <div class="collapse join-item border-neutral rounded-none w-full">
                                <input type="radio" name="my-accordion-2" checked="" />
                                <div
                                    class="collapse-title text-sm tracking-tighter text-neutral-700 inline-block md:mt">
                                    <span class="md:border border-neutral-300 md:px-4 md:py-2">
                                        DESTACADAS
                                    </span>
                                </div>
                                <div class="collapse-content w-full">
                                    {% if destacar_pages %}
                                    {% for page in destacar_pages %}
                                    <p class="relative">
                                        <a href="{{ page.base_url if page.base_url else page.url }}" target="_blank" data-name="{{ page.nombre }}"
                                            data-country="{{ page.País }}" data-url="{{ page.url }}"
                                            class="accordion-link" onclick="handleDestacadaClick(this)">
                                            <span class="md:hidden whitespace-nowrap">
                                                {{ page.nombre | truncate(18, true, "...") }}
                                                {% if page.entidad %}
                                                / <span
                                                    class="bg-gray-200 bg-opacity-75 backdrop-blur-md px-1 ml-1 whitespace-nowrap">
                                                    {{ page.entidad | truncate(12, true, "...") }}
                                                </span>
                                                {% endif %}
                                            </span>
                                            <span class="hidden md:inline whitespace-nowrap">
                                                {{ page.nombre | truncate(25, true, "...") }}
                                                {% if page.entidad %}
                                                / <span
                                                    class="bg-gray-200 bg-opacity-75 backdrop-blur-md px-1 ml-1 whitespace-nowrap">
                                                    {{ page.entidad | truncate(12, true, "...") }}
                                                </span>
                                                {% endif %}
                                            </span>
                                            <span
                                                class="absolute right-0 top-1/2 transform -translate-y-1/2 flex items-center justify-center -mr-2">
                                                <span
                                                    class="flex items-center justify-center group-hover:bg-slate-200 group-hover:rounded-md transition-all duration-200 p-2">
                                                    <svg class="w-3 h-3 z-10" data-slot="icon" fill="none"
                                                        stroke-width="1.5" stroke="currentColor" viewBox="0 0 24 24"
                                                        xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                                                        <path stroke-linecap="round" stroke-linejoin="round"
                                                            d="m4.5 19.5 15-15m0 0H8.25m11.25 0v11.25"></path>
                                                    </svg>
                                                </span>
                                            </span>
                                        </a>
                                    </p>
                                    {% endfor %}
                                    {% else %}
                                    <p>Vuelva a intentar</p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Search Input -->
                    <div class="flex-shrink-0 flex items-center relative w-full">
                        <input type="text" id="search-input" placeholder="Buscar por nombre, tipo o mes"
                            class="input input-bordered rounded-none w-full pl-6 lg:ml-0 focus:ring-0 focus:ring-offset-0 focus:ring-inset md:border-r-0 bg-slate-100"
                            name="search" hx-get="/database" hx-trigger="keyup changed delay:500ms"
                            hx-target="#search-results" hx-include="[name='expanded']" hx-indicator="#spinner"
                            hx-swap="innerHTML" hx-preserve="true">
                        <div class="absolute right-2 top-1/2 transform -translate-y-1/2 cursor-pointer"
                            onclick="clearSearch()">
                            <svg class="w-4 h-4" fill="none" stroke-width="1.5" stroke="currentColor"
                                viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12"></path>
                            </svg>
                        </div>
                    </div>
                </div>

                <!-- Second Column: Table -->
                <div class="col-span-1 md:col-span-7 lg:col-span-8 mt-2 lg:mt-0 min-w-0" id="table-container"
                    hx-preserve="true">
                    <form id="save-form" method="POST">
                        <div class="border-b border-neutral" id="results-container">
                            <div
                                class="max-h-[35rem] min-h-[20rem] overflow-y-auto overflow-x-hidden pl-4 md:pl-0 md:scrollbar-none custom-scrollbar md:border-t border-black md:border-r md:border-r-black">
                                <div
                                    class="w-[120%] md:w-full -ml-4 md:ml-0 overflow-x-auto md:overflow-x-hidden scrollbar-none">
                                    <div class="min-w-full">
                                        <table class="w-full h-full table-fixed relative isolate">
                                            <thead class="sticky top-0 bg-white z-20">
                                                <tr>
                                                    <th class="w-[7%] 3 pt-4 pb-3">✓</th>
                                                    <th
                                                        class="w-[38%] text-xs tracking-tighter text-neutral-700 text-left pl-6 pt-4 pb-3">
                                                        Oportunidad</th>
                                                    <th
                                                        class="w-[35%] text-xs tracking-tighter text-neutral-700 text-left pl-6 pt-4 pb-3">
                                                        Descripción</th>
                                                    <th
                                                        class="w-[12%] text-xs tracking-tighter text-neutral-700 text-center pt-4 pb-3">
                                                        Cierre</th>
                                                    <th class="w-[8%] pt-4 pb-3"></th>
                                                </tr>
                                            </thead>
                                            <tbody id="search-results" class="relative z-30">
                                                {% include "_search_results.html" %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="flex justify-center items-center space-x-2 mt-6 mb-4">
                            <div id="alert-container" class="flex items-center"></div>
                            {% if session.get('user') %}
                                <button type="submit" id="save-button" class="uppercase text-sm font-black tracking-tighter text-neutral-700">
                                    Guardar Seleccionados
                                </button>
                            {% else %}
                                <button type="button" onclick="redirectToLogin()" 
                                        class="uppercase text-sm font-black tracking-tighter text-neutral-700">
                                    Iniciar sesión para guardar
                                </button>
                            {% endif %}
                        </div>
                    </form>
                </div>
        </main>
        {% include 'footer.html' %}
    </div>


    <style>
        .spinner {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
        }

        /* Hide scrollbar for all devices */
        .scrollbar-none::-webkit-scrollbar,
        .custom-scrollbar::-webkit-scrollbar,
        #results-container>div::-webkit-scrollbar,
        #results-container::-webkit-scrollbar {
            display: none !important;
            width: 0 !important;
            height: 0 !important;
        }

        /* Firefox */
        .scrollbar-none,
        .custom-scrollbar,
        #results-container>div,
        #results-container {
            scrollbar-width: none !important;
            -ms-overflow-style: none !important;
        }

        /* Ensure clickable areas are accessible */
        .dropdown,
        .opportunity-link {
            position: relative !important;
            z-index: 10 !important;
        }

        @media (max-width: 1024px) {

            #results-container,
            #results-container>div,
            .max-h-\[35rem\] {
                overflow-x: auto !important;
            }

            /* Override any md: prefixed overflow classes */
            .md\:overflow-x-hidden {
                overflow-x: auto !important;
            }

            table {
                table-layout: fixed !important;
                width: 150% !important;
            }

            /* Adjust z-index for headers */
            th:nth-child(2),
            /* Oportunidad */
            th:nth-child(3)

            /* Descripción */
                {
                position: relative !important;
                z-index: 1 !important;
                /* Ensure headers are below the border */
            }

            /* Adjust sticky header behavior */
            thead.sticky {
                position: sticky !important;
                top: 0 !important;
                z-index: 1 !important;
                /* Ensure header is above table content */
                background: white !important;
            }

            /* Ensure border stays above sticky header */
            .max-h-\[35rem\].md\:border-r {
                position: relative !important;
                z-index: 20 !important;
                /* Higher z-index for the border */
            }
        }


        /* Keep overflow hidden for larger screens */
        @media (min-width: 1025px) {

            #results-container,
            #results-container>div,
            .max-h-\[35rem\] {
                overflow-x: hidden !important;
            }
        }

        /* Hide scrollbars but keep functionality */
        .scrollbar-none::-webkit-scrollbar,
        .custom-scrollbar::-webkit-scrollbar,
        #results-container>div::-webkit-scrollbar,
        #results-container::-webkit-scrollbar {
            width: 0 !important;
            height: 0 !important;
        }
    </style>


    <!-- Script for handling HTMX search -->
    <script>
        let searchInProgress = false;
        let searchTimeout;

        // Función para manejar la entrada de búsqueda
        function handleSearchInput(event) {
            if (searchInProgress) return;

            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                const searchTerm = event.target.value.trim();
                if (searchTerm.length >= 3) {
                    searchInProgress = true;
                    trackSearch(searchTerm);
                    htmx.ajax('GET', `/database?search=${encodeURIComponent(searchTerm)}`, {
                        target: '#search-results',
                        swap: 'innerHTML',
                        headers: { 'HX-Request': 'true' },
                    }).then(() => {
                        searchInProgress = false;
                    }).catch(error => {
                        console.error('Search error:', error);
                        searchInProgress = false;
                    });
                }
            }, 500); // 500ms de debounce
        }

        // Función para manejar la pulsación de teclas (Enter)
        function handleKeyPress(event) {
            if (event.key === 'Enter' && !searchInProgress) {
                event.preventDefault();
                const searchValue = document.getElementById('search-input').value.trim();
                if (searchValue.length >= 3) {
                    searchInProgress = true;
                    trackSearch(searchValue);
                    htmx.ajax('GET', `/database?search=${encodeURIComponent(searchValue)}`, {
                        target: '#search-results',
                        swap: 'innerHTML',
                        headers: { 'HX-Request': 'true' },
                        onAfterSwap: () => {
                            scrollToTop('search-results');
                            searchInProgress = false;
                        },
                        onError: (error) => {
                            console.error('Search error:', error);
                            trackSearchError(searchValue, 'fetch_error');
                            searchInProgress = false;
                        }
                    });
                }
            }
        }

        // Función para limpiar la búsqueda utilizando HTMX
        function clearSearch() {
            const searchInput = document.getElementById('search-input');
            if (searchInput) {
                searchInput.value = '';

                if (!searchInProgress) {
                    searchInProgress = true;
                    htmx.ajax('GET', '/database?clear=true', {
                        target: '#search-results',
                        swap: 'innerHTML',
                        headers: { 'HX-Request': 'true' },
                        onAfterSwap: () => {
                            scrollToTop('search-results');
                            searchInProgress = false;
                        },
                        onError: (error) => {
                            console.error('Clear error:', error);
                            searchInProgress = false;
                        }
                    });
                }
            }
        }

        // Función para alternar la visibilidad del spinner
        function toggleSpinner(show) {
            const spinner = document.getElementById('spinner');
            if (spinner) {
                spinner.style.display = show ? 'block' : 'none';
            }
        }

        // Función para desplazarse al inicio de un elemento
        function scrollToTop(id) {
            const element = document.getElementById(id);
            if (element) {
                element.scrollTop = 0;
            }
        }

        // Función para rastrear eventos de búsqueda
        function trackSearch(searchTerm) {
            gtag('event', 'opportunity_search', {
                send_to: 'G-36M4V4L5RX',
                search_term: searchTerm,
                search_type: 'opportunity'
            });
        }

        // Función para rastrear errores de búsqueda
        function trackSearchError(searchTerm, errorType) {
            gtag('event', 'search_error', {
                search_term: searchTerm,
                error_type: errorType
            });
        }

        // Inicialización de eventos al cargar el DOM
        document.addEventListener('DOMContentLoaded', function () {
            const searchInput = document.getElementById('search-input');
            if (searchInput) {
                searchInput.addEventListener('input', handleSearchInput);
                searchInput.addEventListener('keypress', handleKeyPress);
            }

            // Usar delegación de eventos para los enlaces de oportunidades y clear_search
            document.body.addEventListener('click', function (event) {
                // Manejar enlaces de oportunidades
                const opportunityLink = event.target.closest('.opportunity-link');
                if (opportunityLink) {
                    event.preventDefault();
                    
                    // Obtener datos para analytics
                    const eventData = {
                        'opportunity_name': opportunityLink.dataset.name || '',
                        'country': opportunityLink.dataset.country || 'sin país',
                        'opportunity_keywords': opportunityLink.dataset.keywords || '',
                        'event_category': 'Oportunidad',
                        'section': 'main'
                    };

                    // Enviar evento a Google Analytics
                    console.log('Sending event data:', eventData);
                    gtag('event', 'opportunity_click', eventData);

                    // Abrir enlace en nueva pestaña
                    const url = opportunityLink.getAttribute('data-url');
                    if (url) {
                        window.open(url, '_blank', 'noopener,noreferrer');
                    }
                    return false;
                }

                // Manejar clear_search
                const clearButton = event.target.closest('[onclick="clearSearch()"]');
                if (clearButton) {
                    event.preventDefault();
                    window.location.href = '/database';
                    return false;
                }
            });

            // Manejar el botón de retroceso y el historial
            window.addEventListener('popstate', function(event) {
                window.location.reload();
            });

            // Eventos HTMX para el spinner
            document.body.addEventListener('htmx:beforeRequest', function(event) {
                toggleSpinner(true);
            });

            document.body.addEventListener('htmx:afterRequest', function(event) {
                toggleSpinner(false);
            });

            document.body.addEventListener('htmx:responseError', function(event) {
                console.error('HTMX Response Error:', event.detail.xhr);
                toggleSpinner(false);
            });

            // Registrar el total de oportunidades para depuración
            const totalOpportunities = document.querySelectorAll('.opportunity-link').length;
            console.log('Total opportunities:', totalOpportunities);
        });

        // Opcional: Rastrear solicitudes HTMX para depuración
        document.addEventListener('htmx:configRequest', function(evt) {
            console.log('HTMX request triggered:', evt.detail);
        });

        // Ocultar el spinner en caso de errores de respuesta
        document.body.addEventListener('htmx:responseError', function(event) {
            console.error('HTMX Response Error:', event.detail.xhr);
            toggleSpinner(false);
        });
    </script>


</body>
{% endblock %}