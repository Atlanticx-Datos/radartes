{% extends 'layout.html' %}

{% block body %}

<body>
    <main class="w-full mx-auto pr-2 sm:pr-4 md:pr-6 lg:pr-8 xl:pr-10 2xl:pr-12 pl-1 sm:pl-2 md:pl-3 lg:pl-4 xl:pl-5 2xl:pl-6 mt-2 max-w-screen-2xl">
        <div class="grid grid-cols-1 md:grid-cols-12 md:gap-x-8 gap-0">
            <!-- First Column: Accordions -->
            <div class="col-span-1 md:col-span-4 md:-mr-4 mt-2 md:mt-0 border-r border-neutral flex flex-col justify-between">
                <div class="flex flex-col gap-2">
                    <!-- Accordion 1 -->
                    <div class="join join-vertical w-full">
                        <div class="collapse join-item border-b border-neutral rounded-none w-full">
                            <input type="radio" name="my-accordion-1" checked="" />
                            <div class="collapse-title text-sm tracking-tighter text-neutral-700">
                                CIERRAN PRONTO
                            </div>
                            <div class="collapse-content w-full">
                                {% if closing_soon_pages %}
                                {% for page in closing_soon_pages %}
                                <p class="relative">
                                    <a href="{{ page.url }}" target="_blank"
                                        data-name="{{ page.nombre }}"
                                        class="accordion-link"
                                        onclick="trackAccordionClick('cierranPronto', '{{ page.nombre }}', '{{ page.url }}')">
                                        {{ page.nombre | truncate(50) }}
                                        <span
                                            class="absolute right-0 top-1/2 transform -translate-y-1/2 flex items-center justify-center -mr-1">
                                            <span
                                                class="flex items-center justify-center group-hover:bg-slate-200 group-hover:rounded-md transition-all duration-200 p-2">
                                                <svg class="w-3 h-3 z-10" data-slot="icon" fill="none"
                                                    stroke-width="1.5" stroke="currentColor" viewBox="0 0 24 24"
                                                    xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                                                    <path stroke-linecap="round" stroke-linejoin="round"
                                                        d="m4.5 19.5 15-15m0 0H8.25m11.25 0v11.25"></path>
                                                </svg>
                                            </span>
                                        </span>
                                    </a>
                                </p>
                                {% endfor %}
                                {% else %}
                                <p>No hay oportunidades este mes.</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    <!-- Accordion 2 -->
                    <div class="join join-vertical w-full">
                        <div class="collapse join-item border-neutral rounded-none w-full">
                            <input type="radio" name="my-accordion-2" checked="" />
                            <div class="collapse-title text-sm tracking-tighter text-neutral-700">
                                DESTACADAS
                            </div>
                            <div class="collapse-content w-full">
                                {% if destacar_pages %}
                                {% for page in destacar_pages %}
                                <p class="relative">
                                    <a href="{{ page.url }}" target="_blank"
                                        data-name="{{ page.nombre }}"
                                        class="accordion-link"
                                        onclick="trackAccordionClick('destacadas', '{{ page.nombre }}', '{{ page.url }}')">
                                        {{ page.nombre | truncate(30) }}
                                        <span
                                            class="absolute right-0 top-1/2 transform -translate-y-1/2 flex items-center justify-center -mr-2">
                                            <span
                                                class="flex items-center justify-center group-hover:bg-slate-200 group-hover:rounded-md transition-all duration-200 p-2">
                                                <svg class="w-3 h-3 z-10" data-slot="icon" fill="none"
                                                    stroke-width="1.5" stroke="currentColor" viewBox="0 0 24 24"
                                                    xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                                                    <path stroke-linecap="round" stroke-linejoin="round"
                                                        d="m4.5 19.5 15-15m0 0H8.25m11.25 0v11.25"></path>
                                                </svg>
                                            </span>
                                        </span>
                                    </a>
                                </p>
                                {% endfor %}
                                {% else %}
                                <p>Vuelva a intentar</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Search Input -->
                <div class="flex items-center relative w-full">
                    <input 
                        type="text" 
                        id="search-input" 
                        placeholder="Buscar por país, tipo, nombre o mes"
                        class="input input-bordered rounded-none w-full pl-6 lg:ml-0 focus:ring-0 focus:ring-offset-0 focus:ring-inset md:border-r-0"
                        name="search" 
                        onkeypress="handleKeyPress(event)"
                    >
                    <div class="absolute right-2 top-1/2 transform -translate-y-1/2 cursor-pointer"
                        onclick="clearSearch()">
                        <svg class="w-4 h-4" fill="none" stroke-width="1.5" stroke="currentColor" viewBox="0 0 24 24"
                            xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12"></path>
                        </svg>
                    </div>
                </div>
                <!-- Spinner -->
                <div id="spinner" class="spinner h-8 w-8">
                    <img src="/static/public/spinner.gif" alt="Loading...">
                </div>
            </div>

            <!-- Second Column: Table -->
            <div class="col-span-1 md:col-span-6 md:ml-4 mt-2 lg:mt-0 border-neutral">
                <form id="save-form" hx-post="/save_user_opportunity" hx-trigger="submit" hx-swap="innerHTML"
                    hx-target="#alert-container">
                    <div class="border-b border-neutral overflow-auto" style="max-height: 35rem;"
                        id="results-container">
                        <style>
                            ::-webkit-scrollbar {
                                width: 0;
                                height: 0;
                            }
                        </style>
                        <table class="w-full">
                            <thead>
                                <tr>
                                    <th class="w-10">✓</th>
                                    <th class="w-1/4 text-xs tracking-tighter text-neutral-700 text-center md:pr-28 uppercase">Oportunidad</th>
                                    <th class="w-1/4 text-xs tracking-tighter text-neutral-700 uppercase text-start md:text-center pl-6 md:pl-0 md:pr-4">Descripción</th>
                                    <th class="flex-1"></th>
                                </tr>
                            </thead>
                            <tbody id="search-results" class="relative top-2">
                                {% include "_search_results.html" %}
                            </tbody>
                        </table>
                    </div>
                    <div class="flex justify-center items-center space-x-2 mt-6 mb-4">
                        <div id="alert-container" class="flex items-center"></div>
                        <button type="submit"
                            class="uppercase text-sm font-black tracking-tighter text-neutral-700">Guardar
                            Seleccionados</button>
                    </div>
                </form>
            </div>

            <!-- Third Column: Empty Container -->
            <div class="col-span-1 md:col-span-2 mt-2 lg:mt-0 flex flex-col border-neutral bg-accent relative md:left-6">
                <div class="flex-1 border-b border-r border-l border-t border-black bg-secondary pb-36"></div>
                <div class="flex-1 border-r border-l border-black"></div>
                <div class="flex justify-center relative top-16 animate-bounce">
                    <svg class="w-6 h-6" data-slot="icon" fill="none" stroke-width="1.5" stroke="currentColor"
                        viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 13.5 12 21m0 0-7.5-7.5M12 21V3">
                        </path>
                    </svg>
                </div>
            </div>
        </div>
    </main>


    <style>
        .spinner {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
        }

       
    </style>
 

    <!-- Script for handling HTMX search -->
    <script>
        let searchInProgress = false;
        let searchTimeout;

        // Function to handle search input
        function handleSearchInput(event) {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                const searchTerm = event.target.value.trim();
                if (searchTerm.length >= 3) {
                    trackSearch(searchTerm);
                }
            }, 1000);
        }

        // Function to handle search submission
        function handleKeyPress(event) {
            if (event.key === 'Enter' && !searchInProgress) {
                event.preventDefault();
                const searchValue = document.getElementById('search-input').value.trim();
                if (searchValue.length >= 3) {
                    searchInProgress = true;
                    toggleSpinner(true);
                    trackSearch(searchValue);
                    fetchSearchResults(searchValue);
                }
            }
        }

        // Function to fetch search results
        function fetchSearchResults(searchValue) {
            fetch(`/database?search=${encodeURIComponent(searchValue)}`, {
                headers: { 'HX-Request': 'true' }
            })
            .then(response => response.text())
            .then(html => {
                document.getElementById('search-results').innerHTML = html;
                scrollToTop('results-container');
            })
            .catch(error => {
                console.error('Search error:', error);
                trackSearchError(searchValue, 'fetch_error');
            })
            .finally(() => {
                searchInProgress = false;
                toggleSpinner(false);
            });
        }

        // Function to clear search
        function clearSearch() {
            if (!searchInProgress) {
                document.getElementById('search-input').value = '';
                searchInProgress = true;
                toggleSpinner(true);
                fetch('/database?clear=true', {
                    headers: { 'HX-Request': 'true' }
                })
                .then(response => response.text())
                .then(html => {
                    document.getElementById('search-results').innerHTML = html;
                    scrollToTop('results-container');
                })
                .catch(error => {
                    console.error('Clear error:', error);
                })
                .finally(() => {
                    searchInProgress = false;
                    toggleSpinner(false);
                });
            }
        }

        // Function to toggle spinner visibility
        function toggleSpinner(show) {
            const spinner = document.getElementById('spinner');
            spinner.style.display = show ? 'block' : 'none';
        }

        // Function to scroll to top of an element
        function scrollToTop(id) {
            const element = document.getElementById(id);
            if (element) {
                element.scrollTop = 0;
            }
        }

        // Function to track search events
        function trackSearch(searchTerm) {
            gtag('event', 'opportunity_search', {
                send_to: 'G-36M4V4L5RX',
                search_term: searchTerm,
                search_type: 'opportunity'
            });
        }

        // Function to track search errors
        function trackSearchError(searchTerm, errorType) {
            gtag('event', 'search_error', {
                search_term: searchTerm,
                error_type: errorType
            });
        }

        // Function to sanitize keywords
        function sanitizeKeywords(keywords) {
            if (!keywords) return '';
            
            // Si keywords es un string JSON, parsearlo primero
            try {
                if (typeof keywords === 'string') {
                    keywords = JSON.parse(keywords);
                }
            } catch (e) {
                console.warn('Error parsing keywords:', e);
            }

            // Mapa de reemplazo de caracteres especiales
            const replacements = {
                '\u00ed': 'í',
                '\u00e1': 'á',
                '\u00e9': 'é',
                '\u00f3': 'ó',
                '\u00fa': 'ú',
                '\u00f1': 'ñ'
            };

            // Si keywords es un string, aplicar reemplazos
            if (typeof keywords === 'string') {
                Object.entries(replacements).forEach(([code, char]) => {
                    keywords = keywords.replace(new RegExp(code, 'g'), char);
                });
                return keywords;
            }

            // Si keywords es un array, aplicar a cada elemento
            if (Array.isArray(keywords)) {
                return keywords.map(k => {
                    if (typeof k === 'string') {
                        Object.entries(replacements).forEach(([code, char]) => {
                            k = k.replace(new RegExp(code, 'g'), char);
                        });
                    }
                    return k;
                });
            }

            return keywords;
        }

        // Configurar GA4 con opciones restrictivas
        gtag('config', 'G-36M4V4L5RX', {
            send_page_view: true,
            link_attribution: false,
            enhanced_link_attribution: false,
            enhanced_measurement: false
        });

        // Función de análisis de categorías
        function analyzeKeywords(keywords) {
            const normalizedKeywords = keywords.toLowerCase()
                .normalize("NFD")
                .replace(/[\u0300-\u036f]/g, "");
            
            const categories = {
                // Tipos de Financiación/Apoyo
                beca: [
                    'beca', 'becas', 'scholarship', 'fellowship', 'grant',
                    'estatal', 'estatales', 'financiacion', 'financiamiento',
                    'apoyo economico', 'stipend', 'allowance', 'aid'
                ],
                
                residencia: [
                    'residencia', 'residency', 'artist in residence', 'estancia',
                    'alojamiento', 'hospedaje', 'studio space', 'workspace',
                    'espacio de trabajo', 'artist housing'
                ],
                
                premio: [
                    'premio', 'award', 'concurso', 'certamen', 'competition',
                    'reconocimiento', 'distinction', 'prize', 'contest',
                    'galardón', 'premiación'
                ],
                
                convocatoria: [
                    'convocatoria', 'open call', 'call for', 'llamado',
                    'aplicacion', 'postulacion', 'submission', 'applications',
                    'proposals', 'entries'
                ],
                
                // Disciplinas Artísticas
                fotografia: [
                    'fotografia', 'photo', 'photoespana', 'fotografica',
                    'imagen', 'camara', 'lens', 'photographic', 'photography',
                    'fotorreportaje', 'fotoperiodismo'
                ],
                
                artes_visuales: [
                    'arte visual', 'pintura', 'escultura', 'artes plasticas',
                    'dibujo', 'grabado', 'instalacion', 'mixed media',
                    'arte contemporaneo', 'visual art', 'fine arts',
                    'ceramica', 'textil', 'grafico'
                ],
                
                audiovisual: [
                    'cine', 'film', 'video', 'documental', 'cortometraje',
                    'largometraje', 'cinematografia', 'audiovisual',
                    'animacion', 'motion', 'screenplay', 'guion'
                ],
                
                escenicos: [
                    'teatro', 'danza', 'performance', 'escenicas',
                    'coreografia', 'dramaturgia', 'theatrical',
                    'performing arts', 'stage', 'escenario', 'circo',
                    'opera', 'ballet'
                ],
                
                literatura: [
                    'literatura', 'escritura', 'ensayo', 'libro',
                    'novela', 'poesia', 'cuento', 'narrativa',
                    'editorial', 'publicacion', 'letras', 'writing',
                    'literary'
                ],
                
                musica: [
                    'musica', 'opera', 'sonoro', 'sound', 'musical',
                    'composicion', 'orchestra', 'concierto', 'jazz',
                    'clasica', 'contemporanea', 'experimental'
                ],
                
                // Formatos
                exposicion: [
                    'exposicion', 'exhibition', 'muestra', 'exhibicion',
                    'galeria', 'display', 'showcase', 'presentacion'
                ],
                
                festival: [
                    'festival', 'bienal', 'feria', 'encuentro',
                    'muestra', 'salon', 'trienal', 'fair', 'biennial'
                ],
                
                laboratorio: [
                    'laboratorio', 'lab', 'taller', 'workshop',
                    'seminario', 'clinica', 'masterclass', 'formacion',
                    'capacitacion', 'training'
                ],
                
                // Académico/Investigación
                investigacion: [
                    'investigacion', 'research', 'conservacion', 'estudio',
                    'academic', 'cientifica', 'desarrollo', 'phd',
                    'doctorado', 'tesis', 'proyecto de investigacion'
                ],
                
                formacion: [
                    'formacion', 'maestria', 'doctorado', 'posgrado',
                    'grado', 'undergraduate', 'graduate', 'master',
                    'curso', 'diploma', 'certificacion', 'estudios',
                    'academico', 'universitario'
                ],
                
                // Otros
                movilidad: [
                    'movilidad', 'mobility', 'intercambio', 'viaje',
                    'visitas', 'estudio en', 'travel', 'exchange',
                    'internacional', 'estancia', 'abroad', 'overseas',
                    'foreign', 'international'
                ],
                
                digital: [
                    'digital', 'virtual', 'online', 'tecnologia',
                    'web', 'internet', 'remote', 'plataforma',
                    'software', 'multimedia', 'new media', 'net art'
                ]
            };
            
            const matchedCategories = [];
            for (const [category, keywords] of Object.entries(categories)) {
                if (keywords.some(keyword => normalizedKeywords.includes(keyword))) {
                    matchedCategories.push(category);
                }
            }
            
            return matchedCategories;
        }

        // Función de tracking modificada con log detallado
        function handleOpportunityClick(element) {
            const dataAttributes = {
                name: element.dataset.name || '',
                keywords: element.dataset.keywords || '',
                url: element.dataset.url || ''
            };

            // Analizamos las categorías
            const categoriesAnalysis = analyzeKeywords(dataAttributes.keywords, dataAttributes.name);
            
            // Separamos en principal y secundaria
            const primaryCategory = categoriesAnalysis[0] || '';
            const secondaryCategory = categoriesAnalysis[1] || '';

            // Enviamos el evento a GA4
            gtag('event', 'opportunity_click', {
                'opportunity_name': dataAttributes.name,
                'opportunity_keywords': dataAttributes.keywords,
                'opportunity_primary_category': primaryCategory,    // Nueva forma
                'opportunity_secondary_category': secondaryCategory,  // Nueva forma
                'opportunity_type': primaryCategory,  // Mantenemos type para compatibilidad
                'event_category': 'Oportunidad'
            });
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.getElementById('search-input');
            if (searchInput) {
                searchInput.addEventListener('input', handleSearchInput);
                searchInput.addEventListener('keypress', handleKeyPress);
            }

            const clearSearchButton = document.querySelector('.clear-search-button');
            if (clearSearchButton) {
                clearSearchButton.addEventListener('click', clearSearch);
            }
        });

        // HTMX event handlers
        document.body.addEventListener('htmx:afterRequest', function(evt) {
            searchInProgress = false;
            toggleSpinner(false);
            scrollToTop('results-container');
        });

        document.body.addEventListener('htmx:error', function(evt) {
            console.error('HTMX error:', evt.detail.error);
            searchInProgress = false;
            toggleSpinner(false);
        });

        function trackAccordionClick(type, name, url) {
            gtag('event', `${type}_click`, {
                send_to: 'G-36M4V4L5RX',
                opportunity_name: name,
                opportunity_url: url,
                event_category: 'Accordion'
            });
        }
    </script>
</body>
{% endblock %}