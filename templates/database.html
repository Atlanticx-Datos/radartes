{% extends 'layout.html' %}

{% block body %}
    {% if request.endpoint == 'find_similar_opportunities' %}

    {% endif %}
    
    <div id="spinner" class="spinner h-8 w-8" style="display: none;">
        <img src="{{ url_for('static', filename='public/spinner.gif') }}" alt="Loading...">
    </div>

    <div class="px-4 md:px-8 mt-4 md:mt-0">
        <!-- Main content -->
        <main class="w-full relative">
            <div class="grid grid-cols-1 md:grid-cols-12 gap-0 md:gap-4 h-[calc(100vh-10rem)]">
                <!-- First Column: Accordions -->
                <div
                    class="col-span-1 md:col-span-5 lg:col-span-4 flex flex-col justify-between min-w-0 md:border-r border-neutral h-full">
                    <div class="flex-1 flex flex-col gap-2">
                        <!-- Accordion 1 -->
                        <div class="join join-vertical w-full">
                            <div class="collapse join-item border-b border-neutral rounded-none w-full">
                                <input type="radio" name="my-accordion-1" checked="" />
                                <div class="collapse-title text-sm tracking-tighter text-neutral-700 inline-block">
                                    <span class="md:border border-neutral-300 md:px-4 md:py-2">
                                        CIERRAN PRONTO
                                    </span>
                                </div>
                                <div class="collapse-content w-full">
                                    {% if closing_soon_pages %}
                                    {% for page in closing_soon_pages[:3] %}
                                    <p class="relative">
                                        <a href="/database#{{ page.id }}" class="cierran-pronto-link">
                                            {{ page.nombre | truncate(50) }}
                                            <span class="inline-block ml-2 opportunity-link cursor-pointer">
                                                <button role="button" 
                                                        tabindex="0" 
                                                        data-url="{{ page.url }}"
                                                        data-name="{{ page.nombre }}"
                                                        data-country="{{ page.país }}"
                                                        data-summary="{{ page.og_resumida }}"
                                                        class="opportunity-link flex items-center justify-center w-4 h-4 truncate" 
                                                        title="{{ page.nombre }}">
                                                    <svg class="w-3 md:w-4" data-slot="icon" fill="none" stroke-width="1.5" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                                                        <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 19.5L19.5 4.5M19.5 4.5H8.25M19.5 4.5V15.75"></path>
                                                    </svg>
                                                </button>
                                            </span>
                                        </a>
                                    </p>
                                    {% endfor %}
                                    {% else %}
                                    <p>No hay oportunidades este mes.</p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        <!-- Accordion 2 -->
                        <div class="join join-vertical w-full">
                            <div class="collapse join-item border-neutral rounded-none w-full">
                                <input type="radio" name="my-accordion-2" checked="" />
                                <div
                                    class="collapse-title text-sm tracking-tighter text-neutral-700 inline-block md:mt">
                                    <span class="md:border border-neutral-300 md:px-4 md:py-2">
                                        DESTACADAS
                                    </span>
                                </div>
                                <div class="collapse-content w-full">
                                    {% if destacar_pages %}
                                    {% for page in destacar_pages %}
                                    <p class="relative">
                                        <a href="/database#{{ page.id }}" class="destacada-link">
                                            <span class="md:hidden whitespace-nowrap">
                                                {{ page.nombre | truncate(18, true, "...") }}
                                                {% if page.entidad %}
                                                / <span class="bg-gray-200 bg-opacity-75 backdrop-blur-md px-1 ml-1 whitespace-nowrap">
                                                    {{ page.entidad | truncate(12, true, "...") }}
                                                </span>
                                                {% endif %}
                                            </span>
                                            <span class="hidden md:inline whitespace-nowrap">
                                                {{ page.nombre | truncate(25, true, "...") }}
                                                {% if page.entidad %}
                                                / <span class="bg-gray-200 bg-opacity-75 backdrop-blur-md px-1 ml-1 whitespace-nowrap">
                                                    {{ page.entidad | truncate(12, true, "...") }}
                                                </span>
                                                {% endif %}
                                            </span>
                                        </a>
                                    </p>
                                    {% endfor %}
                                    {% else %}
                                    <p>Vuelva a intentar</p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Search Input -->
                    <div class="flex-shrink-0 flex flex-col gap-1 relative w-full">
                        <div class="relative">
                            <input type="text" 
                                   id="search-input" 
                                   placeholder="Buscar por nombre, disciplina, mes o país" 
                                   class="input input-bordered rounded-none w-full pl-6 lg:ml-0 focus:ring-0 focus:ring-offset-0 focus:ring-inset md:border-r-0 bg-gray-200" 
                                   name="search">
                            <div class="absolute right-2 top-1/2 transform -translate-y-1/2 flex items-center justify-center cursor-pointer"
                                 onclick="clearSearch()">
                                <svg class="w-4 h-4" fill="none" stroke-width="1.5" stroke="currentColor"
                                    viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12"></path>
                                </svg>
                            </div>
                        </div>
                        <div class="text-xs tracking-tighter font-medium text-neutral-500 pl-6 mt-2">
                            <span class="hidden md:inline">
                                Usa comas para combinar términos: "España, visuales" ︱ "Música, residencia"
                            </span>
                            <span class="md:hidden">
                                Usa comas para combinar: "España, visuales" ︱ "Música, residencia"
                            </span>
                        </div>
                    </div>
                </div>

                <!-- Second Column: Table -->
                <div class="col-span-1 md:col-span-7 lg:col-span-8 mt-2 lg:mt-0 min-w-0 h-full" id="table-container"
                    hx-preserve="true">
                    <form id="save-form" method="POST">
                        <div class="border-b border-neutral" id="results-container">
                            <div
                                class="max-h-[35rem] min-h-[35rem] overflow-y-auto overflow-x-hidden pl-4 md:pl-0 md:scrollbar-none custom-scrollbar md:border-t border-black md:border-r md:border-r-black">
                                <div
                                    class="w-[120%] md:w-full -ml-4 md:ml-0 overflow-x-auto md:overflow-x-hidden scrollbar-none">
                                    <div class="min-w-full">
                                        <table class="w-full h-full table-fixed relative isolate">
                                            <thead class="sticky top-0 bg-zinc-100 z-20">
                                                <tr>
                                                    <th class="w-[7%] 3 pt-4 pb-3">✓</th>
                                                    <th
                                                        class="w-[38%] text-xs tracking-tighter text-neutral-700 text-left pl-6 pt-4 pb-3">
                                                        Oportunidad</th>
                                                    <th
                                                        class="w-[35%] text-xs tracking-tighter text-neutral-700 text-left pl-6 pt-4 pb-3">
                                                        Descripción</th>
                                                    <th
                                                        class="w-[12%] text-xs tracking-tighter text-neutral-700 text-center pt-4 pb-3">
                                                        Cierre</th>
                                                    <th class="w-[8%] pt-4 pb-3"></th>
                                                </tr>
                                            </thead>
                                            <tbody id="search-results" class="relative z-30" style="min-height: 35rem;">
                                                {% include "_search_results.html" %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="flex justify-center items-center space-x-2 mt-6 mb-4">
                            <div id="notification" class="flex items-center"></div>
                            {% if session.get('user') %}
                            <button 
                                hx-post="/save_user_opportunity"
                                hx-trigger="click"
                                hx-include="[name='selected_pages']"
                                hx-target="#notification"
                                hx-swap="innerHTML"
                                class="inline-flex items-center justify-center px-4 py-2 text-sm font-bold tracking-tight text-neutral-700 bg-gray-200 hover:bg-gray-300 transition-colors duration-200 rounded-none"
                                onclick="if(!document.querySelector('input[name=\'selected_pages\']:checked')) { alert('Por favor selecciona al menos una oportunidad'); return false; }"
                            >
                                <span class="uppercase">Guardar Seleccionados</span>
                            </button>
                            {% else %}
                            <button type="button" 
                                onclick="redirectToLogin()"
                                class="inline-flex items-center justify-center px-4 py-2 text-sm font-bold tracking-tight text-neutral-700 bg-gray-200 hover:bg-gray-300 transition-colors duration-200 rounded-none"
                            >
                                <span class="uppercase">Iniciar sesión para guardar</span>
                            </button>
                            {% endif %}
                        </div>
                    </form>
                </div>
        </main>
        {% include 'footer.html' %}
    </div>

    <style>
        .spinner {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
        }

        /* Hide scrollbar for all devices */
        .scrollbar-none::-webkit-scrollbar,
        .custom-scrollbar::-webkit-scrollbar,
        #results-container>div::-webkit-scrollbar,
        #results-container::-webkit-scrollbar {
            display: none !important;
            width: 0 !important;
            height: 0 !important;
        }

        /* Firefox */
        .scrollbar-none,
        .custom-scrollbar,
        #results-container>div,
        #results-container {
            scrollbar-width: none !important;
            -ms-overflow-style: none !important;
        }

        /* Ensure clickable areas are accessible */
        .dropdown,
        .opportunity-link {
            position: relative !important;
            z-index: 10 !important;
        }

        @media (max-width: 1024px) {

            #results-container,
            #results-container>div,
            .max-h-\[35rem\] {
                overflow-x: auto !important;
            }

            /* Override any md: prefixed overflow classes */
            .md\:overflow-x-hidden {
                overflow-x: auto !important;
            }

            table {
                table-layout: fixed !important;
                width: 150% !important;
            }

            /* Adjust z-index for headers */
            th:nth-child(2),
            /* Oportunidad */
            th:nth-child(3)

            /* Descripción */
                {
                position: relative !important;
                z-index: 1 !important;
                /* Ensure headers are below the border */
            }

            /* Adjust sticky header behavior */
            thead.sticky {
                position: sticky !important;
                top: 0 !important;
                z-index: 1 !important;
            }

            /* Ensure border stays above sticky header */
            .max-h-\[35rem\].md\:border-r {
                position: relative !important;
                z-index: 20 !important;
                /* Higher z-index for the border */
            }
        }


        /* Keep overflow hidden for larger screens */
        @media (min-width: 1025px) {

            #results-container,
            #results-container>div,
            .max-h-\[35rem\] {
                overflow-x: hidden !important;
            }
        }

        /* Hide scrollbars but keep functionality */
        .scrollbar-none::-webkit-scrollbar,
        .custom-scrollbar::-webkit-scrollbar,
        #results-container>div::-webkit-scrollbar,
        #results-container::-webkit-scrollbar {
            width: 0 !important;
            height: 0 !important;
        }

        .highlighted {
            background-color: rgb(243, 244, 246) !important;
            transition: background-color 0.3s ease;
        }

        .destacada-link {
            transition: background-color 0.2s ease;
        }

        .destacada-link:hover {
            background-color: rgb(243, 244, 246);
        }

        @keyframes flashHighlight {
            0% { border-left: 0px solid rgb(239, 68, 68); }
            50% { border-left: 12px solid rgb(239, 68, 68); }
            100% { border-left: 0px solid rgb(239, 68, 68); }
        }

        .flash-highlight {
            animation: flashHighlight 1s ease-out forwards;
        }

        /* Ensure smooth border transition */
        tr[data-id] {
            transition: border-left-width 0.3s ease;
        }

        .modal-open {
            overflow: hidden;
        }

        .modal-content {
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none; /* IE/Edge */
        }

        .modal-content::-webkit-scrollbar {
            display: none; /* Chrome/Safari */
        }

        @keyframes modalEntry {
            0% {
                opacity: 0;
                transform: translateY(20px);
            }
            100% {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-animate {
            animation: modalEntry 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
    </style>


    <!-- Script for handling HTMX search -->
    <script>
        let searchInProgress = false;
        let searchTimeout;

        // Función para manejar la entrada de búsqueda
        function handleSearchInput(event) {
            if (searchInProgress) return;

            clearTimeout(searchTimeout);
            const searchTerm = event.target.value.trim();

            // If empty, just clear results using HTMX
            if (searchTerm === '') {
                htmx.ajax('GET', '/database?clear=true', {
                    target: '#search-results',
                    swap: 'innerHTML',
                    headers: { 'HX-Request': 'true' }
                });
                return;
            }

            // Proceed with normal search if 3+ characters
            if (searchTerm.length >= 3) {
                searchTimeout = setTimeout(() => {
                    searchInProgress = true;
                    trackSearch(searchTerm);
                    htmx.ajax('GET', `/database?search=${encodeURIComponent(searchTerm)}`, {
                        target: '#search-results',
                        swap: 'innerHTML',
                        headers: { 'HX-Request': 'true' }
                    }).then(() => {
                        searchInProgress = false;
                    }).catch(error => {
                        console.error('Search error:', error);
                        searchInProgress = false;
                    });
                }, 500);
            }
        }

        // Función para manejar la pulsación de teclas (Enter)
        function handleKeyPress(event) {
            if (event.key === 'Enter' && !searchInProgress) {
                event.preventDefault();
                const searchValue = document.getElementById('search-input').value.trim();
                if (searchValue.length >= 3) {
                    searchInProgress = true;
                    trackSearch(searchValue);
                    htmx.ajax('GET', `/database?search=${encodeURIComponent(searchValue)}`, {
                        target: '#search-results',
                        swap: 'innerHTML',
                        headers: { 'HX-Request': 'true' },
                        onAfterSwap: () => {
                            scrollToTop('search-results');
                            searchInProgress = false;
                        },
                        onError: (error) => {
                            console.error('Search error:', error);
                            trackSearchError(searchValue, 'fetch_error');
                            searchInProgress = false;
                        }
                    });
                }
            }
        }

        // Función para limpiar la búsqueda utilizando HTMX
        function clearSearch() {
            const searchInput = document.getElementById('search-input');
            if (searchInput) {
                searchInput.value = '';
                htmx.ajax('GET', '/database?clear=true', {
                    target: '#search-results',
                    swap: 'innerHTML',
                    headers: { 'HX-Request': 'true' }
                });
            }
        }

        // Función para alternar la visibilidad del spinner
        function toggleSpinner(show) {
            const spinner = document.getElementById('spinner');
            if (spinner) {
                spinner.style.display = show ? 'block' : 'none';
            }
        }

        // Función para desplazarse al inicio de un elemento
        function scrollToTop(id) {
            const element = document.getElementById(id);
            if (element) {
                element.scrollTop = 0;
            }
        }

        // Función para rastrear eventos de búsqueda
        function trackSearch(searchTerm) {
            gtag('event', 'opportunity_search', {
                send_to: 'G-36M4V4L5RX',
                search_term: searchTerm,
                search_type: 'opportunity'
            });
        }

        // Función para rastrear errores de búsqueda
        function trackSearchError(searchTerm, errorType) {
            gtag('event', 'search_error', {
                search_term: searchTerm,
                error_type: errorType
            });
        }

        // Inicialización de eventos al cargar el DOM
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, setting up listeners');

            const searchInput = document.getElementById('search-input');
            let initialContent = null;
            let searchInProgress = false;
            let searchTimeout = null;

            // Guardar el contenido inicial
            const searchResults = document.getElementById('search-results');
            if (searchResults) {
                initialContent = searchResults.innerHTML;
            }

            if (searchInput) {
                searchInput.addEventListener('input', function (event) {
                    event.preventDefault(); // Prevent default behavior
                    if (searchInProgress) return;

                    clearTimeout(searchTimeout);
                    const searchTerm = event.target.value.trim();

                    console.log("Search term:", searchTerm); // Debugging statement

                    if (searchTerm === '') {
                        console.log("Clearing search results"); // Debugging statement
                        htmx.ajax('GET', '/database?clear=true', {
                            target: '#search-results',
                            swap: 'innerHTML',
                            headers: { 'HX-Request': 'true' }
                        });
                        return;
                    }

                    if (searchTerm.length >= 3) {
                        searchTimeout = setTimeout(() => {
                            console.log("Performing search for:", searchTerm); // Debugging statement
                            htmx.ajax('GET', `/database?search=${encodeURIComponent(searchTerm)}`, {
                                target: '#search-results',
                                swap: 'innerHTML',
                                headers: { 'HX-Request': 'true' }
                            });
                        }, 500);
                    }
                });

                searchInput.addEventListener('keypress', handleKeyPress);
            }

            // Ensure clearSearch is only bound once and logs its action
            window.clearSearch = function(event) {
                if (event) {
                    event.preventDefault(); // Prevent default behavior
                    event.stopPropagation(); // Stop event bubbling
                }
                console.log("Explicit clear search action triggered"); // Debugging statement
                const searchInput = document.getElementById('search-input');
                if (searchInput) {
                    searchInput.value = '';
                    htmx.ajax('GET', '/database?clear=true', {
                        target: '#search-results',
                        swap: 'innerHTML',
                        headers: { 'HX-Request': 'true' }
                    });
                }
            };

            // Handle opportunity links (modal opening)
            document.body.addEventListener('click', function(event) {
                const clickedElement = event.target;
                const svg = clickedElement.closest('svg');
                
                if (svg) {
                    const opportunityButton = svg.closest('.opportunity-link');
                    
                    if (opportunityButton) {
                        event.preventDefault();
                        event.stopPropagation();
                        
                        const targetUrl = opportunityButton.getAttribute('data-url');
                        const name = opportunityButton.getAttribute('data-name');
                        const country = opportunityButton.getAttribute('data-country');
                        const summary = opportunityButton.getAttribute('data-summary');
                        
                        console.log('Modal data:', { targetUrl, name, country, summary }); // Debug log
                        
                        if (!targetUrl) {
                            console.error('No URL found');
                            return;
                        }

                        showPreviewModal(targetUrl, name, country, summary);
                    }
                }
            });

            // 2. Handle clear search button (preserve existing functionality)
            document.body.addEventListener('click', function (event) {
                const clearButton = event.target.closest('[onclick="clearSearch()"]');
                if (clearButton) {
                    event.preventDefault();
                    window.location.href = '/database';
                    return false;
                }
            });

            // 3. Handle modal close clicks
            document.body.addEventListener('click', function(event) {
                if (event.target.classList.contains('fixed') && event.target.classList.contains('inset-0')) {
                    event.target.remove();
                }
            });

            // Manejar el botón de retroceso y el historial
            window.addEventListener('popstate', function (event) {
                window.location.reload();
            });

            // Eventos HTMX para el spinner
            document.body.addEventListener('htmx:beforeRequest', function (event) {
                toggleSpinner(true);
            });

            document.body.addEventListener('htmx:afterRequest', function (event) {
                toggleSpinner(false);
                searchInProgress = false;
            });

            document.body.addEventListener('htmx:responseError', function (event) {
                console.error('HTMX Response Error:', event.detail.xhr);
                toggleSpinner(false);
                searchInProgress = false;
            });

            // Asegurar que el spinner se oculte si hay algún error no manejado
            window.addEventListener('error', function (event) {
                console.error('Global error:', event.error);
                toggleSpinner(false);
                searchInProgress = false;
            });

            // Registrar el total de oportunidades para depuración
            const totalOpportunities = document.querySelectorAll('.opportunity-link').length;
            console.log('Total opportunities:', totalOpportunities);
        });

        // Opcional: Rastrear solicitudes HTMX para depuración
        document.addEventListener('htmx:configRequest', function (evt) {
            console.log('HTMX request triggered:', evt.detail);
        });

        // Ocultar el spinner en caso de errores de respuesta
        document.body.addEventListener('htmx:responseError', function (event) {
            console.error('HTMX Response Error:', event.detail.xhr);
            toggleSpinner(false);
        });

        function redirectToLogin() {
            // Get current URL and encode it
            const currentUrl = encodeURIComponent(window.location.pathname);
            // Redirect to login with next parameter
            window.location.href = `/login?next=${currentUrl}`;
        }

        // Add HTMX event handlers
        document.body.addEventListener('htmx:afterRequest', function(evt) {
            if (evt.detail.successful) {
                // Clear checkboxes after successful save
                document.querySelectorAll('input[name="selected_pages"]').forEach(checkbox => {
                    checkbox.checked = false;
                });
                
                // Show success notification (will be handled by the response)
                setTimeout(() => {
                    document.getElementById('notification').innerHTML = '';
                }, 2000);
            }
        });

        function scrollToOpportunity(id, event) {
            event.preventDefault();
            const spinner = document.getElementById('layout-spinner');
            const targetRow = document.querySelector(`tr[data-id="${id}"]`);
            
            spinner.style.display = 'block';

            if (targetRow) {
                targetRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
                spinner.style.display = 'none';
            } else {
                htmx.ajax('GET', `/database?scroll_id=${id}`, {
                    target: '#search-results',
                    swap: 'innerHTML',
                    headers: { 
                        'HX-Request': 'true',
                        'HX-Target': '#search-results'
                    },
                    pushHistory: false
                });
            }
        }

        // HTMX event handlers
        document.body.addEventListener('htmx:beforeRequest', function() {
            document.getElementById('layout-spinner').style.display = 'block';
        });

        document.body.addEventListener('htmx:afterSwap', function() {
            const spinner = document.getElementById('layout-spinner');
            spinner.style.display = 'none';
            
            // Handle scroll after content loads
            const urlParams = new URLSearchParams(window.location.search);
            const scrollId = urlParams.get('scroll_id');
            if (scrollId) {
                // Small delay to ensure DOM is ready
                setTimeout(() => {
                    const targetRow = document.querySelector(`tr[data-id="${scrollId}"]`);
                    if (targetRow) {
                        targetRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }, 50);
            }
        });

        // Error handling
        document.body.addEventListener('htmx:responseError', function() {
            document.getElementById('layout-spinner').style.display = 'none';
        });

        // Close modal with ESC key
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                const modals = document.querySelectorAll('.fixed.inset-0');
                if (modals.length > 0) {
                    modals[modals.length - 1].remove();
                }
            }
        });

        // Add this script to maintain search state
        document.addEventListener('DOMContentLoaded', function() {
            // Preserve search input value
            const urlParams = new URLSearchParams(window.location.search);
            const searchParam = urlParams.get('keyword');
            if (searchParam) {
                document.getElementById('search-input').value = decodeURIComponent(searchParam);
            }
        });

        // Enhanced hash handler
        function handleHashScroll() {
            if (window.location.hash) {
                const id = window.location.hash.substring(1);
                const targetRow = document.querySelector(`tr[data-id="${id}"]`);
                const urlParams = new URLSearchParams(window.location.search);
                const scrollFlag = urlParams.get('scroll');

                if (targetRow) {
                    // If coming from redirect, clear the scroll parameter
                    if (scrollFlag) {
                        window.history.replaceState(null, null, window.location.pathname + window.location.hash);
                    }

                    // Trigger animation
                    targetRow.style.animation = 'none';
                    void targetRow.offsetWidth;
                    targetRow.style.animation = 'highlight 2s ease-in-out';
                    
                    targetRow.scrollIntoView({ behavior: 'smooth', block: 'center' });

                    setTimeout(() => {
                        targetRow.style.animation = '';
                    }, 2000);
                } else if (scrollFlag) {
                    // If scroll flag is present but row not found, check again after HTMX swaps
                    const observer = new MutationObserver(() => {
                        const newTarget = document.querySelector(`tr[data-id="${id}"]`);
                        if (newTarget) {
                            observer.disconnect();
                            newTarget.style.animation = 'highlight 2s ease-in-out';
                            newTarget.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            setTimeout(() => {
                                newTarget.style.animation = '';
                            }, 2000);
                        }
                    });

                    observer.observe(document.body, {
                        childList: true,
                        subtree: true
                    });
                }
            }
        }

        // Initialize listeners
        document.addEventListener('DOMContentLoaded', handleHashScroll);
        document.body.addEventListener('htmx:afterSwap', handleHashScroll);
    </script>

    <!-- JavaScript for Modal -->
    <script>
        // Function to create and show the modal
        function showPreviewModal(url, name, country, summary) {
            const modalId = `modal-${Date.now()}`;
            const modal = document.createElement('div');
            modal.id = modalId;
            modal.className = 'fixed inset-0 z-50 bg-black bg-opacity-30 backdrop-blur-sm flex items-center justify-center p-4';
            
            modal.innerHTML = `
                <div class="bg-white rounded-lg w-full max-w-lg overflow-hidden border border-neutral modal-animate">
                    <div class="flex items-center justify-between p-3 border-b border-neutral bg-gray-50">
                        <h3 class="text-lg font-medium text-gray-900">Vista previa de la oportunidad</h3>
                        <button class="text-neutral-700 hover:text-neutral-900 px-3 py-1 transition-colors" 
                                onclick="document.getElementById('${modalId}').remove()">
                            ✕
                        </button>
                    </div>
                    <div class="p-6">
                        <div class="space-y-4">
                            <div>
                                <p class="text-sm text-gray-500">Nombre</p>
                                <p class="mt-1 text-sm text-gray-900">${name || 'No disponible'}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-500">País</p>
                                <p class="mt-1 text-sm text-gray-900">${country || 'No disponible'}</p>
                            </div>
                            ${summary ? `
                            <div>
                                <p class="text-sm text-gray-500">Resumen</p>
                                <div class="mt-2 p-4 bg-gray-50 rounded-lg">
                                    <p class="text-sm text-gray-700 whitespace-pre-line">${summary}</p>
                                </div>
                            </div>
                            ` : ''}
                            <div>
                                <p class="text-sm text-gray-500">URL</p>
                                <a href="${url}" class="mt-1 text-sm text-blue-600 hover:text-blue-800 break-all" target="_blank">
                                    ${url}
                                </a>
                            </div>
                            <div class="mt-6 flex justify-end space-x-3">
                                <button onclick="document.getElementById('${modalId}').remove()" 
                                        class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-md">
                                    Cerrar
                                </button>
                                <a href="${url}" 
                                   target="_blank" 
                                   class="px-4 py-2 text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 rounded-md">
                                    Ir al sitio web
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
            
            // Add class to prevent body scrolling
            document.body.classList.add('modal-open');

            // Close modal when clicking outside
            modal.addEventListener('click', function(event) {
                if (event.target === modal) {
                    modal.remove();
                    document.body.classList.remove('modal-open');
                }
            });

            // Close modal with ESC key
            document.addEventListener('keydown', function escListener(event) {
                if (event.key === 'Escape') {
                    modal.remove();
                    document.body.classList.remove('modal-open');
                    document.removeEventListener('keydown', escListener);
                }
            });
        }
    </script>

    <!-- CSS for Modal Animations -->
    <style>
        /* Fade-in animation */
        @keyframes fade-in {
            from {
                opacity: 0;
                transform: scale(0.95);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .animate-fade-in {
            animation: fade-in 0.3s ease-out forwards;
        }

        /* Ensure the modal overlay is hidden initially */
        #custom-modal.hidden {
            display: none;
        }

        /* Optional: Prevent background scrolling when modal is open */
        .modal-open {
            overflow: hidden;
        }
    </style>
{% endblock %}