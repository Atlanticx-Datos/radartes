{% extends "layout.html" %}

{% block body %}
<div class="container mx-auto px-4 py-8">
    <h1 class="text-3xl font-bold">OPORTUNIDADES GRATIS [EN CONSTRUCCIÓN]!!!
        <h2 class="text-xl mb-6">Toda la info sobre nuestro proyecto <a href="https://github.com/Atlanticx-Datos/100_Oportunidades"
                class="underline">está en GitHub</a></h2>
    </h1>

    <!-- Data container with proper escaping -->
    <div id="prefiltered-data" data-results="{{ prefiltered_results|tojson|forceescape }}"
        data-pages="{{ pages|tojson|forceescape }}" class="hidden">
    </div>

    <!-- Filter Buttons Section (Discipline) -->
    <div class="space-y-6">
        <h2 class="text-lg font-semibold mb-3">Obtener resultados por disciplina</h2>
        <div class="flex flex-wrap gap-2">
            <button class="filter-btn px-4 py-2 rounded-full border bg-blue-600 text-white"
                data-discipline-filter="todos">
                Todos
            </button>
            {% for discipline in discipline_groups.keys() %}
            <button class="filter-btn px-4 py-2 rounded-full border border-gray-300 text-gray-700"
                data-discipline-filter="{{ discipline }}">
                {{ discipline|title }}
            </button>
            {% endfor %}
        </div>
    </div>

    <!-- Replace the current search input div with this -->
    <div class="mt-4 mb-6 relative">
        <div class="relative flex items-center">
            <input type="text" id="open-search" placeholder="Buscar (ej: pintura, españa o beca, alemania)..."
                class="w-full p-2 pr-24 border rounded-lg" oninput="performSearch()">

            <!-- Filter trigger button -->
            <button id="filter-dropdown-trigger"
                class="absolute right-10 top-1/2 -translate-y-1/2 p-2 text-gray-400 hover:text-gray-600"
                aria-label="Open filters">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd"
                        d="M3 3a1 1 0 011-1h12a1 1 0 011 1v3a1 1 0 01-.293.707L12 11.414V15a1 1 0 01-.293.707l-2 2A1 1 0 018 17v-5.586L3.293 6.707A1 1 0 013 6V3z"
                        clip-rule="evenodd" />
                </svg>
            </button>

            <!-- Clear search button -->
            <button id="clear-search"
                class="absolute right-2 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600"
                onclick="clearTestSearch()" style="display: none;">
                ✕
            </button>
        </div>

        <!-- New structured filters dropdown -->
        <div id="structured-filters"
            class="hidden absolute z-50 mt-1 w-80 right-0 bg-white rounded-lg shadow-lg border border-gray-200 p-3">
            <!-- Categories Section -->
            <div class="mb-4">
                <h3 class="text-sm font-semibold mb-2">Categorías</h3>
                <div class="grid grid-cols-2 gap-2">
                    <button
                        class="category-filter-btn px-3 py-1 rounded border border-gray-300 text-gray-700 hover:border-blue-500 hover:bg-blue-50"
                        data-category="beca">
                        Beca
                    </button>
                    <button
                        class="category-filter-btn px-3 py-1 rounded border border-gray-300 text-gray-700 hover:border-blue-500 hover:bg-blue-50"
                        data-category="residencia">
                        Residencia
                    </button>
                    <button
                        class="category-filter-btn px-3 py-1 rounded border border-gray-300 text-gray-700 hover:border-blue-500 hover:bg-blue-50"
                        data-category="premio">
                        Premio
                    </button>
                    <button
                        class="category-filter-btn px-3 py-1 rounded border border-gray-300 text-gray-700 hover:border-blue-500 hover:bg-blue-50"
                        data-category="convocatoria">
                        Convocatoria
                    </button>
                    <button
                        class="category-filter-btn px-3 py-1 rounded border border-gray-300 text-gray-700 hover:border-blue-500 hover:bg-blue-50"
                        data-category="oportunidad">
                        Oportunidad
                    </button>
                    <button
                        class="category-filter-btn px-3 py-1 rounded border border-gray-300 text-gray-700 hover:border-blue-500 hover:bg-blue-50"
                        data-category="fondos">
                        Fondos
                    </button>
                    <button
                        class="category-filter-btn px-3 py-1 rounded border border-gray-300 text-gray-700 hover:border-blue-500 hover:bg-blue-50"
                        data-category="apoyo">
                        Apoyo
                    </button>
                </div>
            </div>

            <!-- Country Dropdown -->
            <div class="mb-4">
                <h3 class="text-sm font-semibold mb-2">País</h3>
                <select id="country-filter" class="w-full p-2 border rounded-lg bg-white">
                    <option value="">Todos los países</option>
                    <!-- Dynamically populated -->
                </select>
            </div>

            <!-- Month Dropdown -->
            <div class="mb-4">
                <h3 class="text-sm font-semibold mb-2">Mes de cierre</h3>
                <select id="month-filter" class="w-full p-2 border rounded-lg bg-white">
                    <option value="">Todos los meses</option>
                    <!-- Dynamically populated -->
                </select>
            </div>

            <!-- Search Button -->
            <button id="apply-filters"
                class="w-full py-2 px-4 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                Buscar
            </button>
        </div>
    </div>

    <!-- Results -->
    <div class="text-sm text-gray-600 my-4" id="results-counter"></div>
    <div id="results-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
</div>

<!-- Update the script section -->
<script>
    // Add HTML escaping utility at the top of the script
    function escapeHTML(str) {
        return str.replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }

    function clearTestSearch() {
        const searchInput = document.getElementById('open-search');
        const clearButton = document.getElementById('clear-search');
        searchInput.value = '';
        clearButton.style.display = 'none';
        performSearch();
    }

    function performSearch() {
        const searchInput = document.getElementById('open-search');
        const clearButton = document.getElementById('clear-search');
        const searchValue = searchInput.value.trim();

        // Show/hide clear button based on whether there's text
        clearButton.style.display = searchValue ? 'block' : 'none';

        const allPages = JSON.parse(document.getElementById('prefiltered-data').dataset.pages);

        if (!searchValue) {
            updateResults(allPages);
            return;
        }

        // Split search terms by comma and trim each term
        const searchTerms = searchValue.split(',').map(term => term.trim().toLowerCase());

        const filtered = allPages.filter(page => {
            // If we have multiple search terms, all must match
            return searchTerms.every(term => {
                // Normalize all relevant fields for searching
                const normalizedPage = {
                    nombre: normalizeText(page.nombre || ''),
                    og_resumida: normalizeText(page.og_resumida || ''),
                    entidad: normalizeText(page.entidad || ''),
                    categoria: normalizeText(page.categoria || ''),
                    disciplina: normalizeText(page.disciplina || ''),
                    pais: normalizeText(page.pais || '')
                };

                // Check if the term matches any field
                const allFieldsText = Object.values(normalizedPage).join(' ');

                // Special handling for common categories
                if (term === 'beca' && normalizedPage.categoria.includes('beca')) return true;
                if (term === 'premio' && normalizedPage.categoria.includes('premio')) return true;
                if (term === 'residencia' && normalizedPage.categoria.includes('residencia')) return true;

                // Check if the term exactly matches país or disciplina
                if (term === normalizedPage.pais) return true;
                if (term === normalizedPage.disciplina) return true;

                // If no special match, look for the term in all fields
                return allFieldsText.includes(normalizeText(term));
            });
        });

        updateResults(filtered);
    }

    function normalizeText(text) {
        return text.normalize("NFD")
            .replace(/[\u0300-\u036f]/g, "")
            .toLowerCase()
            .trim();
    }

    function updateResults(results) {
        const container = document.getElementById('results-container');
        const counter = document.getElementById('results-counter');

        if (results.length === 0) {
            container.innerHTML = '<p>No se encontraron resultados.</p>';
            counter.textContent = '0 resultados encontrados';
            return;
        }

        container.innerHTML = results.map(page => `
        <div class="opportunity-card border rounded-lg p-4 shadow-sm hover:shadow-md transition-shadow duration-200">
            <h3 class="font-bold text-lg mb-2">${escapeHTML(page.nombre || 'Sin nombre')}</h3>
            <p class="text-sm text-gray-600 mb-2">${escapeHTML(page.og_resumida || '')}</p>
            <div class="flex justify-between items-center">
                <span class="text-sm text-gray-500">${escapeHTML(page.disciplina || '')}</span>
                <button 
                    class="preview-btn text-blue-600 hover:underline text-sm"
                    data-url="${escapeHTML(page.url || '')}"
                    data-name="${escapeHTML(page.nombre || '')}"
                    data-country="${escapeHTML(page.pais || '')}"
                    data-summary="${escapeHTML(page.og_resumida || '')}"
                    data-id="${escapeHTML(page.id || '')}"
                >
                    Ver más
                </button>
            </div>
        </div>
        `).join('');

        counter.textContent = `${results.length} resultado${results.length !== 1 ? 's' : ''} encontrado${results.length !== 1 ? 's' : ''}`;
    }

    // Initialize with all results on load
    document.addEventListener('DOMContentLoaded', function () {
        const initialPages = JSON.parse(document.getElementById('prefiltered-data').dataset.pages);
        updateResults(initialPages);
    });
</script>
{% endblock %}