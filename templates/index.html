{% extends "layout.html" %}

{% block body %}
<div class="container max-w-[1292px] mx-auto px-8">
    <!-- Header Section -->
    <header class="py-16 flex flex-col items-center text-center">
        <h1 class="text-5xl font-bold mb-4">Descubrí tu próxima oportunidad</h1>
        <p class="text-xl text-gray-600 mb-8 max-w-2xl">Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua.</p>
        
        <!-- Search Section -->
        <div class="relative w-full max-w-2xl">
            <div class="relative flex items-center">
                <input type="text" 
                       id="open-search" 
                       placeholder="Buscar (ej: pintura, españa o beca, alemania)..." 
                       class="w-full p-4 pr-28 border rounded-lg shadow-sm">

                <!-- Filter trigger button (now first) -->
                <button id="filter-dropdown-trigger"
                        class="absolute right-16 p-2 text-gray-400 hover:text-gray-600">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M3 3a1 1 0 011-1h12a1 1 0 011 1v3a1 1 0 01-.293.707L12 11.414V15a1 1 0 01-.293.707l-2 2A1 1 0 018 17v-5.586L3.293 6.707A1 1 0 013 6V3z" clip-rule="evenodd" />
                    </svg>
                </button>

                <!-- Clear all filters button (now second) -->
                <button type="button"
                        id="clear-search"
                        class="absolute right-4 p-2 text-gray-400 hover:text-gray-600"
                        onclick="clearAllFilters();">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
                    </svg>
                </button>
            </div>

            <!-- Structured filters dropdown -->
            <div id="structured-filters"
                class="hidden absolute z-50 mt-1 w-80 right-0 bg-white rounded-lg shadow-lg border border-gray-200 p-3 text-left"
                style="top: 100%; /* Ensure dropdown appears below search bar */">
                <!-- Categories Section -->
                <div class="mb-4">
                    <h3 class="text-sm font-semibold mb-2">Categorías</h3>
                    <div class="grid grid-cols-2 gap-2">
                        <button class="category-filter-btn px-3 py-1 rounded border border-gray-300 text-gray-700 hover:border-blue-500 hover:bg-blue-50"
                            data-category="beca">Beca</button>
                        <button class="category-filter-btn px-3 py-1 rounded border border-gray-300 text-gray-700 hover:border-blue-500 hover:bg-blue-50"
                            data-category="residencia">Residencia</button>
                        <button class="category-filter-btn px-3 py-1 rounded border border-gray-300 text-gray-700 hover:border-blue-500 hover:bg-blue-50"
                            data-category="premio">Premio</button>
                        <button class="category-filter-btn px-3 py-1 rounded border border-gray-300 text-gray-700 hover:border-blue-500 hover:bg-blue-50"
                            data-category="convocatoria">Convocatoria</button>
                        <button class="category-filter-btn px-3 py-1 rounded border border-gray-300 text-gray-700 hover:border-blue-500 hover:bg-blue-50"
                            data-category="oportunidad">Oportunidad</button>
                        <button class="category-filter-btn px-3 py-1 rounded border border-gray-300 text-gray-700 hover:border-blue-500 hover:bg-blue-50"
                            data-category="fondos">Fondos</button>
                        <button class="category-filter-btn px-3 py-1 rounded border border-gray-300 text-gray-700 hover:border-blue-500 hover:bg-blue-50"
                            data-category="apoyo">Apoyo</button>
                    </div>
                </div>

                <!-- Country Dropdown -->
                <div class="mb-4">
                    <h3 class="text-sm font-semibold mb-2">País</h3>
                    <select id="country-filter" class="w-full p-2 border rounded-lg bg-white">
                        <option value="">Todos los países</option>
                        <!-- Dynamically populated -->
                    </select>
                </div>

                <!-- Month Dropdown -->
                <div class="mb-4">
                    <h3 class="text-sm font-semibold mb-2">Mes de cierre</h3>
                    <select id="month-filter" class="w-full p-2 border rounded-lg bg-white">
                        <option value="">Todos los meses</option>
                        <!-- Dynamically populated -->
                    </select>
                </div>

                <!-- Search Button -->
                <button id="apply-filters"
                    class="w-full py-2 px-4 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                    Buscar
                </button>
            </div>
        </div>
    </header>

    <!-- Data container with proper escaping -->
    <div id="prefiltered-data" data-results="{{ prefiltered_results|tojson|forceescape }}"
        data-pages="{{ pages|tojson|forceescape }}" class="hidden">
    </div>

    <!-- Filter buttons section -->
    <div class="mb-8">
        <div class="flex flex-wrap gap-2">
            {% for discipline in discipline_groups.keys() %}
            <button class="filter-btn px-4 py-2 rounded-full border border-gray-300 text-gray-700"
                data-discipline-filter="{{ discipline }}"
                onclick="toggleDisciplineFilter(this, '{{ discipline }}')">
                {{ discipline|title }}
            </button>
            {% endfor %}
        </div>
    </div>

    <!-- Destacados section with proper spacing and full width -->
    <div class="relative max-w-7xl mx-auto">
        <!-- Previous button - adjusted to -ml-14 -->
        <button 
            onclick="prevDestacarPage()"
            class="destacar-prev absolute left-0 top-1/2 -translate-y-1/2 -ml-14 w-10 h-10 flex items-center justify-center rounded-full bg-white shadow-lg hover:bg-gray-50 focus:outline-none transition-opacity duration-200"
            aria-disabled="true"
        >
            <svg class="h-6 w-6 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
            </svg>
        </button>

        <!-- Featured opportunities grid - full width -->
        <div class="featured-opportunities w-full">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Content will be populated by JavaScript -->
            </div>
        </div>

        <!-- Next button - adjusted to -mr-14 -->
        <button 
            onclick="nextDestacarPage()"
            class="destacar-next absolute right-0 top-1/2 -translate-y-1/2 -mr-14 w-10 h-10 flex items-center justify-center rounded-full bg-white shadow-lg hover:bg-gray-50 focus:outline-none transition-opacity duration-200"
        >
            <svg class="h-6 w-6 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
            </svg>
        </button>
    </div>

    <!-- Results Section -->
    <div class="mt-4 mb-6">
        <!-- Results Counter -->
        <div class="text-sm text-gray-600 my-4" id="results-counter"></div>

        <!-- Results Grid -->
        <div id="results-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
    </div>
</div>

<!-- Update the script section -->
<script>
    // Global variables needed by site.js
    let activeFilters = {
        categories: new Set(),
        country: '',
        month: '',
        discipline: 'todos'
    };

    // Ensure these functions are globally available
    window.performSearch = function() {
        const searchInput = document.getElementById('open-search');
        const clearButton = document.getElementById('clear-search');
        
        // Debug
        console.log('performSearch called', {
            inputValue: searchInput.value,
            clearButtonExists: !!clearButton
        });
        
        // Show/hide clear button based on input content
        if (searchInput.value.length > 0) {
            clearButton.style.display = 'block';
        } else {
            clearButton.style.display = 'none';
        }

        const searchInputValue = searchInput.value;
        applyFilters(searchInputValue);
    };

    window.clearSearch = function() {
        const searchInput = document.getElementById('open-search');
        const clearButton = document.getElementById('clear-search');
        
        // Debug
        console.log('clearSearch called');
        
        searchInput.value = '';
        clearButton.style.display = 'none';
        performSearch(); // Trigger search to reset results
    };

    document.addEventListener('DOMContentLoaded', function() {
        // Debug: Initial check
        console.log('DOM Content Loaded');
        
        const searchInput = document.getElementById('open-search');
        const clearButton = document.getElementById('clear-search');
        
        // Debug: Element check
        console.log('Elements found:', {
            searchInput: !!searchInput,
            clearButton: !!clearButton
        });
        
        // Remove any existing listeners to prevent conflicts
        const newSearchInput = searchInput.cloneNode(true);
        searchInput.parentNode.replaceChild(newSearchInput, searchInput);
        
        // Add our listeners
        newSearchInput.addEventListener('input', window.performSearch);
        
        // Initial check for existing input
        if (newSearchInput.value.length > 0) {
            clearButton.style.display = 'block';
        }
        
        // Debug: Setup complete
        console.log('Search setup complete');
    });

    function escapeHTML(str) {
        if (!str) return '';
        return str.replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }

    function performSearch() {
        const searchInput = document.getElementById('open-search');
        const clearButton = document.getElementById('clear-search');
        
        // Show/hide clear button based on input content
        if (searchInput.value.length > 0) {
            clearButton.style.display = 'block';
        } else {
            clearButton.style.display = 'none';
        }

        const searchInputValue = searchInput.value;
        applyFilters(searchInputValue);
    }

    function clearSearch() {
        const searchInput = document.getElementById('open-search');
        const clearButton = document.getElementById('clear-search');
        searchInput.value = '';
        clearButton.style.display = 'none';
        performSearch(); // Trigger search to reset results
    }

    document.addEventListener('DOMContentLoaded', function() {
        const allPages = JSON.parse(document.getElementById('prefiltered-data').dataset.pages);
        initializeDropdowns(allPages);
        
        // Setup event listeners
        document.getElementById('open-search').addEventListener('input', performSearch);
        
        // Debug: Check if elements exist
        console.log('Search input exists:', !!document.getElementById('open-search'));
        console.log('Clear button exists:', !!document.getElementById('clear-search'));
        
        // Debug: Check initial state
        const searchInput = document.getElementById('open-search');
        console.log('Initial search value:', searchInput.value);
        
        // Force initial check of search input
        performSearch();
        
        // Setup category filter buttons
        document.querySelectorAll('.category-filter-btn').forEach(button => {
            button.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();  // Prevent event bubbling
                const category = this.dataset.category;
                console.log('Category clicked:', category);
                
                // Toggle category in activeFilters
                if (activeFilters.categories.has(category)) {
                    activeFilters.categories.delete(category);
                    this.classList.remove('border-blue-500', 'bg-blue-50');
                } else {
                    activeFilters.categories.add(category);
                    this.classList.add('border-blue-500', 'bg-blue-50');
                }
                
                // Store categories in a way that persists
                window.selectedCategories = Array.from(activeFilters.categories);
                console.log('Selected categories:', window.selectedCategories);
            });
        });

        // Setup discipline filter buttons
        document.querySelectorAll('[data-discipline-filter]').forEach(button => {
            button.addEventListener('click', function() {
                document.querySelectorAll('[data-discipline-filter]').forEach(btn => {
                    btn.classList.remove('bg-blue-600', 'text-white');
                    btn.classList.add('border-gray-300', 'text-gray-700');
                });
                
                this.classList.remove('border-gray-300', 'text-gray-700');
                this.classList.add('bg-blue-600', 'text-white');
                activeFilters.discipline = this.dataset.disciplineFilter;
                applyFilters();
            });
        });

        // Setup apply filters button
        const applyFiltersBtn = document.getElementById('apply-filters');
        if (applyFiltersBtn) {
            applyFiltersBtn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                
                // Get current filter values
                activeFilters.country = document.getElementById('country-filter').value;
                activeFilters.month = document.getElementById('month-filter').value;
                
                // Ensure we're using the stored categories
                if (window.selectedCategories) {
                    activeFilters.categories = new Set(window.selectedCategories);
                }
                
                console.log('Applying combined filters:', {
                    categories: Array.from(activeFilters.categories),
                    country: activeFilters.country,
                    month: activeFilters.month
                });
                
                applyFilters();
                document.getElementById('structured-filters').classList.add('hidden');
            });
        }
    });

    function applyFilters(searchInput = document.getElementById('open-search').value) {
        // Add featured section toggle at the start
        const featuredSection = document.querySelector('.featured-opportunities');
        
        // Hide featured section if there's any active filtering
        if (searchInput || 
            activeFilters.categories.size > 0 || 
            activeFilters.country || 
            activeFilters.month || 
            activeFilters.discipline !== 'todos') {
            featuredSection?.classList.add('hidden');
        } else {
            featuredSection?.classList.remove('hidden');
        }

        // Restore categories from our stored selection
        if (window.selectedCategories) {
            activeFilters.categories = new Set(window.selectedCategories);
        }

        const allPages = JSON.parse(document.getElementById('prefiltered-data').dataset.pages);
        
        const filtered = allPages.filter(page => {
            // For debugging
            let filterResults = {
                searchMatch: true,
                disciplineMatch: true,
                countryMatch: true,
                monthMatch: true,
                categoryMatch: true
            };

            // Apply text search filter
            if (searchInput) {
                filterResults.searchMatch = matchesSearchTerms(page, searchInput);
                if (!filterResults.searchMatch) return false;
            }

            // Apply discipline filter
            if (activeFilters.discipline !== 'todos') {
                filterResults.disciplineMatch = normalizeText(page.disciplina) === normalizeText(activeFilters.discipline);
                if (!filterResults.disciplineMatch) return false;
            }

            // Apply country filter
            if (activeFilters.country) {
                filterResults.countryMatch = normalizeText(page.país) === normalizeText(activeFilters.country);
                if (!filterResults.countryMatch) return false;
            }

            // Apply month filter
            if (activeFilters.month) {
                const monthToFind = String(activeFilters.month).padStart(2, '0');
                const pageMonth = page.fecha_de_cierre ? page.fecha_de_cierre.split('-')[1] : '';
                
                console.log('Month matching:', {
                    page: page.nombre,
                    monthToFind,
                    fecha_de_cierre: page.fecha_de_cierre,
                    pageMonth,
                    matches: pageMonth === monthToFind
                });
                
                filterResults.monthMatch = pageMonth === monthToFind;
                if (!filterResults.monthMatch) return false;
            }

            // Apply category filters
            if (activeFilters.categories.size > 0) {
                const pageCategory = normalizeText(page.categoria);
                filterResults.categoryMatch = Array.from(activeFilters.categories).some(category => {
                    const normalizedCategory = normalizeText(category);
                    return pageCategory.startsWith(normalizedCategory) || 
                           pageCategory.startsWith(normalizedCategory + 's');
                });
                if (!filterResults.categoryMatch) return false;
            }

            return true;
        });

        console.log('Filtered results:', filtered.length);
        updateResults(filtered);
    }

    function matchesSearchTerms(page, searchInput) {
        const searchTerms = searchInput.split(',').map(term => normalizeText(term.trim()));
        return searchTerms.every(term => {
            const pageText = normalizeText([
                page.nombre,
                page.og_resumida,
                page.entidad,
                page.categoria,
                page.disciplina,
                page.pais
            ].join(' '));
            return pageText.includes(term);
        });
    }

    function normalizeText(text) {
        if (!text) return '';
        return text.normalize("NFD")
            .replace(/[\u0300-\u036f]/g, "")
            .toLowerCase()
            .trim();
    }

    function updateResults(results) {
        const container = document.getElementById('results-container');
        const counter = document.getElementById('results-counter');

        if (!results.length) {
            container.innerHTML = '<p>No se encontraron resultados.</p>';
            counter.textContent = '0 resultados encontrados';
            return;
        }

        container.innerHTML = results.map(page => `
            <div class="opportunity-card border rounded-lg p-4 shadow-sm hover:shadow-md transition-shadow duration-200">
                <h3 class="font-bold text-lg mb-2">${escapeHTML(page.nombre || 'Sin nombre')}</h3>
                <p class="text-sm text-gray-600 mb-2">${escapeHTML(page.og_resumida || '')}</p>
                <div class="flex justify-between items-center">
                    <span class="text-sm text-gray-500">${escapeHTML(page.disciplina || '')}</span>
                    <button 
                        class="preview-btn text-blue-600 hover:underline text-sm"
                        data-url="${escapeHTML(page.url || '')}"
                        data-name="${escapeHTML(page.nombre || '')}"
                        data-country="${escapeHTML(page.pais || '')}"
                        data-summary="${escapeHTML(page.og_resumida || '')}"
                        data-id="${escapeHTML(page.id || '')}"
                    >
                        Ver más
                    </button>
                </div>
            </div>
        `).join('');

        counter.textContent = `${results.length} resultado${results.length !== 1 ? 's' : ''} encontrado${results.length !== 1 ? 's' : ''}`;
    }

    function initializeDropdowns(pages) {
        // Initialize country dropdown
        const countryFilter = document.getElementById('country-filter');
        const countries = [...new Set(pages.map(page => page.pais).filter(Boolean))].sort();
        
        countries.forEach(country => {
            const option = document.createElement('option');
            option.value = country;
            option.textContent = country;
            countryFilter.appendChild(option);
        });

        // Initialize month dropdown
        const monthFilter = document.getElementById('month-filter');
        const months = [
            { value: '1', label: 'Enero' },
            { value: '2', label: 'Febrero' },
            { value: '3', label: 'Marzo' },
            { value: '4', label: 'Abril' },
            { value: '5', label: 'Mayo' },
            { value: '6', label: 'Junio' },
            { value: '7', label: 'Julio' },
            { value: '8', label: 'Agosto' },
            { value: '9', label: 'Septiembre' },
            { value: '10', label: 'Octubre' },
            { value: '11', label: 'Noviembre' },
            { value: '12', label: 'Diciembre' }
        ];

        months.forEach(month => {
            const option = document.createElement('option');
            option.value = month.value;
            option.textContent = month.label;
            monthFilter.appendChild(option);
        });
    }

    // Function to clear all filters
    function clearAllFilters() {
        // Clear search input
        document.getElementById('open-search').value = '';
        
        // Clear category filters
        activeFilters.categories.clear();
        window.selectedCategories = [];
        document.querySelectorAll('.category-filter-btn').forEach(btn => {
            btn.classList.remove('border-blue-500', 'bg-blue-50');
        });
        
        // Clear country filter
        document.getElementById('country-filter').value = '';
        activeFilters.country = '';
        
        // Clear month filter
        document.getElementById('month-filter').value = '';
        activeFilters.month = '';
        
        // Reset discipline to 'todos'
        activeFilters.discipline = 'todos';
        document.querySelectorAll('[data-discipline-filter]').forEach(btn => {
            btn.classList.remove('bg-blue-600', 'text-white');
            btn.classList.add('border-gray-300', 'text-gray-700');
            if (btn.dataset.disciplineFilter === 'todos') {
                btn.classList.remove('border-gray-300', 'text-gray-700');
                btn.classList.add('bg-blue-600', 'text-white');
            }
        });
        
        // Trigger search to update results
        performSearch();
        
        // Close the filters dropdown if it's open
        document.getElementById('structured-filters').classList.add('hidden');
        
        // Show featured section when clearing all filters
        const featuredSection = document.querySelector('.featured-opportunities');
        featuredSection?.classList.remove('hidden');
    }

    // Ensure the clear button stays visible
    function ensureClearButtonVisible() {
        const clearButton = document.getElementById('clear-search');
        if (clearButton) {
            clearButton.style.display = 'block';
            setTimeout(ensureClearButtonVisible, 100);
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        ensureClearButtonVisible();
    });
</script>
{% endblock %}

{% block page_scripts %}
<script>
    // Process data and store in a dedicated window property
    const rawData = {{ destacar_pages|tojson|safe }};
    window.processedDestacarData = rawData.map(item => ({
        ...item,
        url_base: item.url_base || new URL(item.url).hostname.replace('www.', '')
    }));
    console.log('Processed data:', window.processedDestacarData);
</script>
{% endblock %}