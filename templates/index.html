{% extends "layout.html" %}

{% block head %}
<script type="module" src="{{ url_for('static', filename='js/site.js') }}"></script>
<style>
    /* Custom styles for multiple select dropdowns */
    select[multiple] {
        padding: 0.5rem;
        border-radius: 0.375rem;
        border: 1px solid #e5e7eb;
        width: 100%;
        min-height: 120px;
        background-color: white;
    }

    select[multiple] option {
        padding: 0.375rem 0.75rem;
        cursor: pointer;
    }

    select[multiple] option:checked {
        background: #3b82f6 linear-gradient(0deg, #3b82f6 0%, #3b82f6 100%);
        color: white;
    }

    select[multiple] option:hover {
        background-color: #eff6ff;
    }

    /* Custom styles for single select dropdowns */
    .form-select {
        appearance: none;
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
        background-position: right 0.5rem center;
        background-repeat: no-repeat;
        background-size: 1.5em 1.5em;
        padding: 0.5rem 2.5rem 0.5rem 0.75rem;
        border-radius: 0.375rem;
        border: 1px solid #e5e7eb;
        width: 100%;
    }

    .form-select:focus {
        outline: 2px solid transparent;
        outline-offset: 2px;
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
</style>
{% endblock %}

{% block body %}

<!-- Full width header section -->
<header class="relative w-full h-[550px] overflow-visible">
    <!-- Background image with overlay -->
    <div class="absolute inset-0 z-0">
        <div class="absolute inset-0" style="height: calc(100% + 2rem);">
            <img src="{{ url_for('static', filename='public/mirada.png') }}" 
                 alt="Background" 
                 class="w-full h-full object-cover">
            <div class="absolute inset-0 bg-gradient-to-r from-[#6232FF]/75 to-[#CEFF1C]/20 mix-blend-multiply"></div>
        </div>
    </div>
    
    <!-- Content container -->
    <div class="container max-w-[1292px] mx-auto px-8 h-full">
        <div class="relative z-10 flex flex-col items-center text-center justify-center h-full">
            <h1 class="text-[40px] font-bold leading-[130%] tracking-normal text-center text-white">Descubr칤 tu pr칩xima</h1>
            <h1 class="text-[40px] font-bold leading-[130%] tracking-normal text-center text-[#CEFF1C] mb-8">oportunidad</h1>
           
            <!-- Search Section -->
            <div class="relative w-full max-w-2xl">
                <!-- Search input and buttons -->
                <div class="relative flex items-center">
                    <input type="text" id="open-search" placeholder="Buscar (acepta combinaciones, por ej.: 'Visuales, Espa침a')"
                        class="w-full p-4 pr-28 border rounded-lg shadow-xl bg-white/95 placeholder-gray-500">

                    <!-- Filter trigger button (now first) -->
                    <button id="filter-dropdown-trigger" class="absolute right-16 p-2 text-gray-400 hover:text-gray-600">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.5 6h9.75M10.5 6a1.5 1.5 0 11-3 0m3 0a1.5 1.5 0 10-3 0M3.75 6H7.5m3 12h9.75m-9.75 0a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m-3.75 0H7.5m9-6h3.75m-3.75 0a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m-9.75 0h9.75" />
                        </svg>
                    </button>

                    <!-- Clear all filters button (now second) -->
                    <button type="button" id="clear-search" class="absolute right-4 p-2 text-gray-400 hover:text-gray-600"
                        onclick="clearSearch();">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd"
                                d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
                                clip-rule="evenodd" />
                        </svg>
                    </button>

                    <!-- Structured filters dropdown -->
                    <div id="structured-filters"
                        class="hidden absolute right-0 mt-2 w-96 bg-white rounded-lg shadow-2xl border border-gray-200 p-4"
                        style="top: 100%; z-index: 999999;">
                        <!-- Header with Filtros and trash icon -->
                        <div class="flex justify-between items-center mb-4 pb-2 border-b">
                            <div class="flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.5 6h9.75M10.5 6a1.5 1.5 0 11-3 0m3 0a1.5 1.5 0 10-3 0M3.75 6H7.5m3 12h9.75m-9.75 0a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m-3.75 0H7.5m9-6h3.75m-3.75 0a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m-9.75 0h9.75" />
                                </svg>
                                <h3 class="text-lg font-semibold">Filtros</h3>
                            </div>
                            <button id="clear-filters" class="text-gray-400 hover:text-gray-600" type="button">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                </svg>
                            </button>
                        </div>

                        <!-- Categories Section -->
                        <div class="mb-4 filter-section">
                            <button class="filter-dropdown-trigger w-full flex justify-between items-center py-2 px-3 bg-gray-50 hover:bg-gray-100 rounded-md" data-target="categories-dropdown" type="button">
                                <span class="font-medium text-gray-700">Categor칤as</span>
                                <span class="selected-values text-sm text-gray-500"></span>
                                <svg class="h-5 w-5 text-gray-400" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                                </svg>
                            </button>
                            <div id="categories-dropdown" class="filter-dropdown-content hidden mt-2 p-2 border border-gray-200 rounded-md bg-white">
                                <div class="max-h-48 overflow-y-auto">
                                    <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                        <input type="checkbox" class="form-checkbox h-4 w-4 text-blue-600" value="beca" name="categories">
                                        <span class="ml-2 text-gray-700">Beca</span>
                                    </label>
                                    <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                        <input type="checkbox" class="form-checkbox h-4 w-4 text-blue-600" value="residencia" name="categories">
                                        <span class="ml-2 text-gray-700">Residencia</span>
                                    </label>
                                    <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                        <input type="checkbox" class="form-checkbox h-4 w-4 text-blue-600" value="premio" name="categories">
                                        <span class="ml-2 text-gray-700">Premio</span>
                                    </label>
                                    <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                        <input type="checkbox" class="form-checkbox h-4 w-4 text-blue-600" value="convocatoria" name="categories">
                                        <span class="ml-2 text-gray-700">Convocatoria</span>
                                    </label>
                                    <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                        <input type="checkbox" class="form-checkbox h-4 w-4 text-blue-600" value="oportunidad" name="categories">
                                        <span class="ml-2 text-gray-700">Oportunidad</span>
                                    </label>
                                    <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                        <input type="checkbox" class="form-checkbox h-4 w-4 text-blue-600" value="fondos" name="categories">
                                        <span class="ml-2 text-gray-700">Fondos</span>
                                    </label>
                                    <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                        <input type="checkbox" class="form-checkbox h-4 w-4 text-blue-600" value="apoyo" name="categories">
                                        <span class="ml-2 text-gray-700">Apoyo</span>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Subdisciplinas Section -->
                        <div class="mb-4 filter-section">
                            <button class="filter-dropdown-trigger w-full flex justify-between items-center py-2 px-3 bg-gray-50 hover:bg-gray-100 rounded-md" data-target="subdisciplinas-dropdown" type="button">
                                <span class="font-medium text-gray-700">Subdisciplinas</span>
                                <span class="selected-values text-sm text-gray-500"></span>
                                <svg class="h-5 w-5 text-gray-400" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                                </svg>
                            </button>
                            <div id="subdisciplinas-dropdown" class="filter-dropdown-content hidden mt-2 p-2 border border-gray-200 rounded-md bg-white">
                                <div class="max-h-48 overflow-y-auto" id="subdisciplinas-container">
                                    <!-- Will be populated dynamically -->
                                </div>
                            </div>
                        </div>

                        <!-- Country Dropdown -->
                        <div class="mb-4 filter-section">
                            <button class="filter-dropdown-trigger w-full flex justify-between items-center py-2 px-3 bg-gray-50 hover:bg-gray-100 rounded-md" data-target="country-dropdown" type="button">
                                <span class="font-medium text-gray-700">Pa칤s</span>
                                <span class="selected-values text-sm text-gray-500"></span>
                                <svg class="h-5 w-5 text-gray-400" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                                </svg>
                            </button>
                            <div id="country-dropdown" class="filter-dropdown-content hidden mt-2 p-2 border border-gray-200 rounded-md bg-white">
                                <div class="max-h-48 overflow-y-auto" id="country-container">
                                    <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                        <input type="radio" class="form-radio h-4 w-4 text-blue-600" value="" name="country" checked>
                                        <span class="ml-2 text-gray-700">Todos los pa칤ses</span>
                                    </label>
                                    <!-- Will be populated dynamically -->
                                </div>
                            </div>
                        </div>

                        <!-- Month Dropdown -->
                        <div class="mb-4 filter-section">
                            <button class="filter-dropdown-trigger w-full flex justify-between items-center py-2 px-3 bg-gray-50 hover:bg-gray-100 rounded-md" data-target="month-dropdown" type="button">
                                <span class="font-medium text-gray-700">Mes de cierre</span>
                                <span class="selected-values text-sm text-gray-500"></span>
                                <svg class="h-5 w-5 text-gray-400" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                                </svg>
                            </button>
                            <div id="month-dropdown" class="filter-dropdown-content hidden mt-2 p-2 border border-gray-200 rounded-md bg-white">
                                <div class="max-h-48 overflow-y-auto" id="month-container">
                                    <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                        <input type="radio" class="form-radio h-4 w-4 text-blue-600" value="" name="month" checked>
                                        <span class="ml-2 text-gray-700">Todos los meses</span>
                                    </label>
                                    <!-- Will be populated dynamically -->
                                </div>
                            </div>
                        </div>

                        <!-- Inscripci칩n filter -->
                        <div class="mb-4 filter-section">
                            <button class="filter-dropdown-trigger w-full flex justify-between items-center py-2 px-3 bg-gray-50 hover:bg-gray-100 rounded-md" data-target="inscripcion-dropdown" type="button">
                                <span class="font-medium text-gray-700">Inscripci칩n</span>
                                <span class="selected-values text-sm text-gray-500"></span>
                                <svg class="h-5 w-5 text-gray-400" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                                </svg>
                            </button>
                            <div id="inscripcion-dropdown" class="filter-dropdown-content hidden mt-2 p-2 border border-gray-200 rounded-md bg-white">
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" id="inscripcion-checkbox" class="form-checkbox h-4 w-4 text-blue-600">
                                    <span class="ml-2 text-gray-700">Solo oportunidades sin pago</span>
                                </label>
                            </div>
                        </div>

                        <!-- Search Button -->
                        <button id="search-filters"
                            class="w-full py-2 px-4 bg-design-primary text-white rounded-lg hover:bg-opacity-90 transition-colors"
                            type="button">
                            Buscar
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- Data container with proper escaping -->
<div id="prefiltered-data" data-results="{{ prefiltered_results|tojson|forceescape }}"
    data-pages="{{ pages|tojson|forceescape }}" class="hidden">
</div>

<!-- Script to fix table styling -->
<script>
    // Function to fix table styling
    function fixTableStyling() {
        console.log('Fixing table styling on page load');
        
        // Fix header background
        const tableHeaders = document.querySelectorAll('.results-table thead, table[id*="results"] thead');
        tableHeaders.forEach(header => {
            header.style.backgroundColor = '#6232FF';
            header.style.color = 'white';
        });
        
        // Fix header cells
        const headerCells = document.querySelectorAll('.results-table th, table[id*="results"] th');
        headerCells.forEach(cell => {
            // Remove problematic classes
            cell.classList.remove('bg-gray-50', 'hover:bg-gray-100', 'text-gray-500');
            
            // Apply direct styles
            cell.style.backgroundColor = '#6232FF';
            cell.style.color = 'white';
            cell.style.padding = '12px 16px';
            cell.style.fontWeight = '600';
            cell.style.fontSize = '14px';
        });
        
        // Fix sort icons
        const sortIcons = document.querySelectorAll('.results-table th svg, table[id*="results"] th svg');
        sortIcons.forEach(icon => {
            icon.style.color = 'white';
            icon.classList.remove('text-gray-400');
            icon.classList.add('text-white');
        });
        
        // Fix discipline tags
        const disciplineTags = document.querySelectorAll('.discipline-tag');
        disciplineTags.forEach(tag => {
            // Apply common styles
            tag.style.display = 'inline-block';
            tag.style.padding = '4px 12px';
            tag.style.borderRadius = '16px';
            tag.style.fontSize = '13px';
            tag.style.fontWeight = '500';
            
            // Apply discipline-specific styles
            if (tag.classList.contains('visuales')) {
                tag.style.backgroundColor = '#E92E4A';
                tag.style.color = 'white';
            } else if (tag.classList.contains('musica')) {
                tag.style.backgroundColor = '#FF7022';
                tag.style.color = 'white';
            } else if (tag.classList.contains('escenicas')) {
                tag.style.backgroundColor = '#F3CE3A';
                tag.style.color = '#333';
            } else if (tag.classList.contains('literatura')) {
                tag.style.backgroundColor = '#2ED0FF';
                tag.style.color = 'white';
            } else if (tag.classList.contains('diseno')) {
                tag.style.backgroundColor = '#17A398';
                tag.style.color = 'white';
            } else if (tag.classList.contains('cine')) {
                tag.style.backgroundColor = '#64113F';
                tag.style.color = 'white';
            } else {
                tag.style.backgroundColor = '#F15BB5';
                tag.style.color = 'white';
            }
        });
        
        // Fix action buttons
        const actionButtons = document.querySelectorAll('.action-button');
        actionButtons.forEach(button => {
            button.style.backgroundColor = '#6232FF';
            button.style.color = 'white';
            button.style.padding = '6px 12px';
            button.style.borderRadius = '6px';
            button.style.fontWeight = '500';
            button.style.fontSize = '13px';
            button.style.cursor = 'pointer';
        });
    }
    
    // Run immediately
    document.addEventListener('DOMContentLoaded', fixTableStyling);
    
    // Also run when the page is fully loaded
    window.addEventListener('load', fixTableStyling);
    
    // Run again after a short delay to catch any late-rendered elements
    setTimeout(fixTableStyling, 500);
    setTimeout(fixTableStyling, 1000);
    setTimeout(fixTableStyling, 2000);
</script>

<!-- Full width background container with rounded top corners -->
<div class="w-full bg-gray-50 rounded-t-[40px] overflow-hidden relative z-10 -mt-8">
    <!-- Re-open container for content alignment -->
    <div class="container max-w-[1292px] mx-auto px-8">
        <div class="pt-10 relative z-20">
            <!-- Filter buttons section -->
            <div class="mb-8">
                <h2 class="text-2xl font-bold mb-6 text-design-gray-900">Oportunidades por disciplina</h2>
                <div class="filter-container">
                    <button
                        class="filter-btn"
                        data-discipline-filter="todos" data-active="true"
                        onclick="this.dataset.active = this.dataset.active === 'true' ? 'false' : 'true'; toggleDisciplineFilter(this, 'todos')">
                        <div class="icon-container">
                            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M4 6h16M4 12h16m-7 6h7" />
                            </svg>
                        </div>
                        <span>Todos</span>
                    </button>
                    
                    {% for discipline in discipline_groups.keys() %}
                    {% if discipline != 'todos' %}
                    <button
                        class="filter-btn"
                        data-discipline-filter="{{ discipline }}" data-active="false"
                        onclick="this.dataset.active = this.dataset.active === 'true' ? 'false' : 'true'; toggleDisciplineFilter(this, '{{ discipline }}')">
                        <div class="icon-container">
                            {% if discipline == 'Visuales' %}
                            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                            </svg>
                            {% elif discipline == 'M칰sica' %}
                            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3" />
                            </svg>
                            {% elif discipline == 'Esc칠nicas' %}
                            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" />
                            </svg>
                            {% elif discipline == 'Literatura' %}
                            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
                            </svg>
                            {% elif discipline == 'Dise침o' %}
                            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01" />
                            </svg>
                            {% elif discipline == 'Cine' %}
                            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M7 4v16M17 4v16M3 8h4m10 0h4M3 12h18M3 16h4m10 0h4M4 20h16a1 1 0 001-1V5a1 1 0 00-1-1H4a1 1 0 00-1 1v14a1 1 0 001 1z" />
                            </svg>
                            {% elif discipline == 'Otras' %}
                            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                            </svg>
                            {% endif %}
                        </div>
                        <span>{{ discipline }}</span>
                    </button>
                    {% endif %}
                    {% endfor %}
                </div>
            </div>

            <!-- Destacados section with proper spacing and full width -->
            <div class="relative max-w-full mx-auto destacados-container mb-12">
                <h2 class="text-2xl font-bold mb-8 destacados-header text-design-gray-900">Destacados de la semana 游댠</h2>
                <div class="relative">
                    <!-- Previous button - adjusted position for better responsiveness -->
                    <button onclick="prevDestacarPage()"
                        class="destacar-prev absolute left-0 top-1/2 -translate-y-1/2 -ml-4 sm:-ml-8 lg:-ml-14 w-10 h-10 flex items-center justify-center rounded-full bg-white shadow-lg hover:bg-gray-50 focus:outline-none transition-opacity duration-200"
                        aria-disabled="true">
                        <svg class="h-6 w-6 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                        </svg>
                    </button>

                    <!-- Featured opportunities grid - full width with flex container -->
                    <div class="featured-opportunities w-full overflow-hidden">
                        <div class="flex flex-wrap gap-6">
                            <!-- Content will be populated by JavaScript, but we can add a template for reference -->
                            <!-- This template won't be displayed, it's just for reference -->
                            <template id="destacar-card-template">
                                <div class="bg-white rounded-lg shadow-md overflow-hidden relative cursor-pointer opportunity-preview">
                                    <div class="relative h-48 bg-gray-200">
                                        <img src="/static/public/IsoAtx.png" alt="Atlantic x Logo" class="w-full h-full object-contain">
                                        <span class="absolute top-3 left-3 text-sm">Categor칤a</span>
                                        <span class="discipline-badge discipline-default">Disciplina</span>
                                        <button class="absolute top-3 right-3 text-gray-400 hover:text-gray-600">
                                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"/>
                                            </svg>
                                        </button>
                                    </div>
                                    <!-- Card Details Section-->
                                    <div class="p-2">
                                        <h3 class="font-medium text-lg">T칤tulo de la oportunidad</h3>
                                        
                                        <div class="flex flex-wrap gap-4 text-sm text-gray-600">
                                            <div class="meta-row">
                                                <div class="flex items-center gap-1">
                                                    <svg class="w-4 h-4" viewBox="0 0 20 20" fill="currentColor">
                                                        <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"/>
                                                    </svg>
                                                    <span>Pa칤s</span>
                                                </div>
                                                
                                                <div class="flex items-center gap-1">
                                                    <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                                        <circle cx="12" cy="12" r="10"/>
                                                        <path d="M12 6v12M15 9.5C15 8.7 14.3 8 13.5 8h-3C9.7 8 9 8.7 9 9.5S9.7 11 10.5 11h3c0.8 0 1.5 0.7 1.5 1.5v0c0 0.8-0.7 1.5-1.5 1.5h-3C9.7 14 9 14.7 9 15.5"/>
                                                    </svg>
                                                </div>
                                                
                                                <div class="flex items-center gap-1 subdisciplines-inline">
                                                    <svg class="w-4 h-4" viewBox="0 0 20 20" fill="currentColor">
                                                        <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"/>
                                                        <path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3zm-3 4a1 1 0 100 2h.01a1 1 0 100-2H7zm3 0a1 1 0 100 2h3a1 1 0 100-2h-3z" clip-rule="evenodd"/>
                                                    </svg>
                                                    <span>Subdisciplinas</span>
                                                </div>
                                            </div>
                                            
                                            <div class="flex items-center gap-1 date-row">
                                                <svg class="w-4 h-4" viewBox="0 0 20 20" fill="currentColor">
                                                    <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd"/>
                                                </svg>
                                                <span>Cierre: 01/Ene/2023</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>

                    <!-- Next button - adjusted position for better responsiveness -->
                    <button onclick="nextDestacarPage()"
                        class="destacar-next absolute right-0 top-1/2 -translate-y-1/2 -mr-4 sm:-mr-8 lg:-mr-14 w-10 h-10 flex items-center justify-center rounded-full bg-white shadow-lg hover:bg-gray-50 focus:outline-none transition-opacity duration-200">
                        <svg class="h-6 w-6 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Results Section -->
            <div class="mb-8">
                <h2 id="radar-header" class="text-2xl font-bold mb-6 text-design-gray-900">Radar de oportunidades 游깵</h2>
                <!-- Results Counter -->
                <div class="text-sm text-gray-600 mb-4" id="results-counter"></div>

                <!-- Results Grid -->
                <div id="results-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
            </div>

            <!-- New Top Opportunities Section -->
            <div class="mb-8">
                <h2 class="text-2xl font-bold mb-6 text-design-gray-900">Top convocatorias 游꿢</h2>
                <div class="relative">
                    <!-- Previous button -->
                    <button onclick="prevTopPage()"
                        class="top-prev absolute left-0 top-1/2 -translate-y-1/2 -ml-14 w-10 h-10 flex items-center justify-center rounded-full bg-white shadow-lg hover:bg-gray-50 focus:outline-none transition-opacity duration-200"
                        aria-disabled="true">
                        <svg class="h-6 w-6 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                        </svg>
                    </button>

                    <!-- Top opportunities grid -->
                    <div class="top-opportunities-container">
                        <div class="grid grid-cols-1 gap-6">
                            <!-- Content will be populated by JavaScript -->
                        </div>
                    </div>

                    <!-- Next button -->
                    <button onclick="nextTopPage()"
                        class="top-next absolute right-0 top-1/2 -translate-y-1/2 -mr-14 w-10 h-10 flex items-center justify-center rounded-full bg-white shadow-lg hover:bg-gray-50 focus:outline-none transition-opacity duration-200">
                        <svg class="h-6 w-6 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Newsletter Section -->
            <div class="mb-8 bg-[#8B8B9D] rounded-lg overflow-hidden">
                <div class="container mx-auto px-6 py-10">
                    <div class="text-center">
                        {% if existing_email %}
                        <!-- Already subscribed -->
                        <h2 class="text-3xl font-bold text-white mb-4">춰Ya est치s suscripto!</h2>
                        <p class="text-gray-200 mb-8 text-lg">
                            Est치s recibiendo actualizaciones con el email: <strong>{{ existing_email }}</strong>
                        </p>
                        <form action="/unsubscribe" method="post" class="mt-6">
                            <input type="hidden" name="email" value="{{ existing_email }}">
                            <button type="submit"
                                class="bg-white text-gray-800 px-8 py-3 rounded-full font-medium hover:bg-gray-100 transition-colors text-lg">
                                Cancelar suscripci칩n
                            </button>
                        </form>
                        {% else %}
                        <!-- Not subscribed -->
                        <h2 class="text-3xl font-bold text-white mb-4">Suscribite a nuestro newsletter</h2>
                        <p class="text-gray-200 mb-8 text-lg max-w-2xl mx-auto">
                            Recib칤 actualizaciones mensuales de fotograf칤a, arte, literatura y mucho m치s.
                        </p>
                        <form action="/subscribe" method="post" class="mt-6 flex flex-col sm:flex-row justify-center max-w-lg mx-auto">
                            <input type="email" name="email" placeholder="Tu email"
                                class="px-6 py-3 rounded-full mb-3 sm:mb-0 sm:mr-3 w-full sm:w-auto flex-grow focus:outline-none text-lg"
                                required>
                            <button type="submit"
                                class="bg-white text-gray-800 px-8 py-3 rounded-full font-medium hover:bg-gray-100 transition-colors text-lg">
                                Suscribirme
                            </button>
                        </form>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Update the script section -->
<script type="module">
    console.log('SearchModule availability check:', {
        searchModuleExists: !!window.SearchModule,
        updateResultsExists: !!(window.SearchModule && window.SearchModule.updateResults)
    });

    // Global variables needed by site.js
    let activeFilters = {
        categories: new Set(),
        country: '',
        month: '',
        discipline: 'todos'
    };

    // Define functions first
    function initializeDropdowns(pages) {
        console.log('Initializing dropdowns');
        // Initialize country dropdown
        const countryFilter = document.getElementById('country-filter');
        if (countryFilter) {
            const countries = [...new Set(pages.map(page => page.pais).filter(Boolean))].sort();

            countries.forEach(country => {
                const option = document.createElement('option');
                option.value = country;
                option.textContent = country;
                countryFilter.appendChild(option);
            });
        } else {
            console.warn('country-filter element not found');
        }

        // Initialize month dropdown
        const monthFilter = document.getElementById('month-filter');
        if (monthFilter) {
            const months = [
                { value: '1', label: 'Enero' },
                { value: '2', label: 'Febrero' },
                { value: '3', label: 'Marzo' },
                { value: '4', label: 'Abril' },
                { value: '5', label: 'Mayo' },
                { value: '6', label: 'Junio' },
                { value: '7', label: 'Julio' },
                { value: '8', label: 'Agosto' },
                { value: '9', label: 'Septiembre' },
                { value: '10', label: 'Octubre' },
                { value: '11', label: 'Noviembre' },
                { value: '12', label: 'Diciembre' }
            ];

            months.forEach(month => {
                const option = document.createElement('option');
                option.value = month.value;
                option.textContent = month.label;
                monthFilter.appendChild(option);
            });
        } else {
            console.warn('month-filter element not found');
        }
    }

    function updateResults(results) {
        if (window.SearchModule && window.SearchModule.updateResults) {
            window.SearchModule.updateResults(results);
        } else {
            // Your existing fallback card-based display logic
            const container = document.getElementById('results-container');
            const counter = document.getElementById('results-counter');

            if (!results.length) {
                container.innerHTML = '<p>No se encontraron resultados.</p>';
                counter.textContent = '0 resultados encontrados';
                return;
            }

            container.innerHTML = results.map(page => `
                <div class="opportunity-card border rounded-lg p-4 shadow-sm hover:shadow-md transition-shadow duration-200">
                    <h3 class="font-bold text-lg mb-2">${escapeHTML(page.nombre || 'Sin nombre')}</h3>
                    <p class="text-sm text-gray-600 mb-2">${escapeHTML(page.og_resumida || '')}</p>
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-gray-500">${escapeHTML(page.disciplina || '')}</span>
                        <button 
                            class="preview-btn text-blue-600 hover:underline text-sm"
                            data-url="${escapeHTML(page.url || '')}"
                            data-name="${escapeHTML(page.nombre || '')}"
                            data-country="${escapeHTML(page.pais || '')}"
                            data-summary="${escapeHTML(page.og_resumida || '')}"
                            data-category="${escapeHTML(page.categoria || '')}"
                            data-id="${escapeHTML(page.id || '')}"
                        >
                            Ver m치s
                        </button>
                    </div>
                </div>
            `).join('');

            counter.textContent = `${results.length} resultado${results.length !== 1 ? 's' : ''} encontrado${results.length !== 1 ? 's' : ''}`;
        }
    }

    function applyFilters(searchInput = document.getElementById('open-search').value) {
        console.log('applyFilters called with:', { searchInput, activeFilters });
        
        const featuredSection = document.querySelector('.featured-opportunities');

        if (searchInput ||
            activeFilters.categories.size > 0 ||
            activeFilters.country ||
            activeFilters.month ||
            activeFilters.discipline !== 'todos') {
            featuredSection?.classList.add('hidden');
            // Removed scroll logic as the featured section is now hidden
        } else {
            featuredSection?.classList.remove('hidden');
        }

        const allPages = JSON.parse(document.getElementById('prefiltered-data').dataset.pages);
        
        const filtered = allPages.filter(page => {
            // For debugging
            let filterResults = {
                searchMatch: true,
                disciplineMatch: true,
                countryMatch: true,
                monthMatch: true,
                categoryMatch: true
            };

            // Apply text search filter
            if (searchInput) {
                filterResults.searchMatch = matchesSearchTerms(page, searchInput);
                if (!filterResults.searchMatch) return false;
            }
            
            // If the "Buscar solo oportunidades sin pago" checkbox is checked, filter by inscripcion field
            const inscripcionCheckbox = document.getElementById('inscripcion-checkbox');
            if (inscripcionCheckbox && inscripcionCheckbox.checked) {
                // Only include pages that are free ("Sin cargo") or have no value for inscripcion
                if (page.inscripcion && page.inscripcion.trim().toLowerCase() !== 'sin cargo') {
                    return false;
                }
            }

            // Apply discipline filter
            if (activeFilters.discipline !== 'todos') {
                filterResults.disciplineMatch = normalizeText(page.disciplina) === normalizeText(activeFilters.discipline);
                if (!filterResults.disciplineMatch) return false;
            }

            // Apply country filter
            if (activeFilters.country) {
                filterResults.countryMatch = normalizeText(page.pais) === normalizeText(activeFilters.country);
                if (!filterResults.countryMatch) return false;
            }

            // Apply month filter
            if (activeFilters.month) {
                const monthToFind = String(activeFilters.month).padStart(2, '0');
                const pageMonth = page.fecha_de_cierre ? page.fecha_de_cierre.split('-')[1] : '';
                filterResults.monthMatch = pageMonth === monthToFind;
                if (!filterResults.monthMatch) return false;
            }

            // Apply category filters
            if (activeFilters.categories.size > 0) {
                const pageCategory = normalizeText(page.categoria);
                filterResults.categoryMatch = Array.from(activeFilters.categories).some(category => {
                    const normalizedCategory = normalizeText(category);
                    return pageCategory.startsWith(normalizedCategory) ||
                        pageCategory.startsWith(normalizedCategory + 's');
                });
                if (!filterResults.categoryMatch) return false;
            }

            return true;
        });

        console.log('Filtered results:', filtered.length);
        console.log('Filtered data:', filtered);
        updateResults(filtered);
    }

    function matchesSearchTerms(page, searchInput) {
        const searchTerms = searchInput.split(',').map(term => normalizeText(term.trim()));
        return searchTerms.every(term => {
            const pageText = normalizeText([
                page.nombre,
                page.og_resumida,
                page.entidad,
                page.categoria,
                page.disciplina,
                page.pais
            ].join(' '));
            return pageText.includes(term);
        });
    }

    function normalizeText(text) {
        if (!text) return '';
        return text.normalize("NFD")
            .replace(/[\u0300-\u036f]/g, "")
            .toLowerCase()
            .trim();
    }

    // Then add event listeners
    document.addEventListener('DOMContentLoaded', function () {
        console.log('DOM Content Loaded - Setting up event listeners');
        
        try {
            const prefilteredData = document.getElementById('prefiltered-data');
            if (!prefilteredData) {
                console.error('prefiltered-data element not found');
                return;
            }
            
            // Parse the pages data safely
            let allPages = [];
            try {
                const tempParser = new DOMParser();
                const pagesString = tempParser.parseFromString(prefilteredData.dataset.pages || '[]', 'text/html').body.textContent;
                allPages = JSON.parse(pagesString);
                console.log(`Successfully parsed ${allPages.length} pages`);
            } catch (error) {
                console.error('Error parsing pages data:', error);
                allPages = [];
            }
            
            // Only try to initialize dropdowns if we have pages
            if (allPages.length > 0) {
                try {
                    initializeDropdowns(allPages);
                } catch (error) {
                    console.error('Error initializing dropdowns:', error);
                }
            }
            
            // Log the total number of pages fetched
            console.log('Initial load - Total pages fetched:', allPages.length);

            // Note: The actual initialization of results is now handled by site.js
            // to ensure consistent behavior
            
            // Initialize TopModule directly if it exists
            if (window.TopModule && typeof window.TopModule.init === 'function') {
                try {
                    window.TopModule.init(allPages);
                    console.log('TopModule initialized directly');
                } catch (error) {
                    console.error('Error initializing TopModule:', error);
                }
            }
        } catch (error) {
            console.error('Error in DOMContentLoaded handler:', error);
        }

        // Setup category filter buttons
        document.querySelectorAll('.category-filter-btn').forEach(button => {
            console.log('Setting up category button:', button.dataset.category);
            button.addEventListener('click', function (e) {
                console.log('Category clicked:', this.dataset.category);
                e.preventDefault();
                e.stopPropagation();
                const category = this.dataset.category;

                if (activeFilters.categories.has(category)) {
                    activeFilters.categories.delete(category);
                    this.classList.remove('border-blue-500', 'bg-blue-50');
                } else {
                    activeFilters.categories.add(category);
                    this.classList.add('border-blue-500', 'bg-blue-50');
                }

                window.selectedCategories = Array.from(activeFilters.categories);
                console.log('Selected categories:', window.selectedCategories);
            });
        });

        // Setup apply filters button
        const applyFiltersBtn = document.getElementById('search-filters');
        if (applyFiltersBtn) {
            console.log('Setting up apply filters button');
            applyFiltersBtn.addEventListener('click', function (e) {
                console.log('Apply filters clicked');
                e.preventDefault();
                e.stopPropagation();

                activeFilters.country = document.getElementById('country-filter').value;
                activeFilters.month = document.getElementById('month-filter').value;

                if (window.selectedCategories) {
                    activeFilters.categories = new Set(window.selectedCategories);
                }

                console.log('Applying filters with:', {
                    categories: Array.from(activeFilters.categories),
                    country: activeFilters.country,
                    month: activeFilters.month
                });

                applyFilters();
                document.getElementById('structured-filters').classList.add('hidden');
            });
        } else {
            console.warn('Apply filters button not found!');
        }
    });
</script>

<!-- Add this script right after the newsletter section -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('subscribe-form');
    const emailInput = document.getElementById('subscribe-email');
    const emailError = document.getElementById('email-error');
    const submitButton = form?.querySelector('button[type="submit"]');

    if (!form || !emailInput || !emailError || !submitButton) return;

    // Email validation function
    function validateEmail(email) {
        const emailRegex = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
        return emailRegex.test(email);
    }

    // Input validation
    emailInput.addEventListener('input', function() {
        const email = this.value.trim();
        
        if (email === '') {
            emailError.textContent = 'El correo electr칩nico es requerido';
            emailError.classList.remove('hidden');
            submitButton.disabled = true;
        } else if (!validateEmail(email)) {
            emailError.textContent = 'Por favor ingresa un correo electr칩nico v치lido';
            emailError.classList.remove('hidden');
            submitButton.disabled = true;
        } else {
            emailError.classList.add('hidden');
            submitButton.disabled = false;
        }
    });

    // Form submission
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        const email = emailInput.value.trim();
        
        if (!email || !validateEmail(email)) {
            emailError.textContent = 'Por favor ingresa un correo electr칩nico v치lido';
            emailError.classList.remove('hidden');
            return;
        }

        // Disable form while submitting
        submitButton.disabled = true;
        emailInput.disabled = true;
        submitButton.innerHTML = 'Enviando...';

        // Here you would typically send the data to your server
        // For now we'll just simulate a response
        setTimeout(() => {
            form.innerHTML = `
                <div class="text-green-400 font-medium">
                    춰Gracias por suscribirte! Pronto recibir치s nuestras actualizaciones.
                </div>
            `;
        }, 1000);
    });
});
</script>
{% endblock %}

{% block page_scripts %}
<script type="module">
    import { processDestacarData } from "{{ url_for('static', filename='js/modules/data-processor.js') }}";
    
    const rawData = JSON.parse('{{ destacar_pages| tojson | safe }}');
    processDestacarData(rawData);
</script>
{% endblock %}