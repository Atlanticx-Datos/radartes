{% extends "layout.html" %}

{% block head %}
<script type="module" src="{{ url_for('static', filename='js/site.js') }}"></script>
{% endblock %}

{% block body %}

<div class="container max-w-[1292px] mx-auto px-8">
    <!-- Header Section -->
    <header class="py-16 flex flex-col items-center text-center min-h-screen justify-center">
        <h1 class="text-5xl font-bold mb-4 text-white">Descubrí tu próxima oportunidad</h1>
        <p class="text-xl text-gray-600 mb-8 max-w-2xl">Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do
            eiusmod tempor incididunt ut labore et dolore magna aliqua.</p>

        <!-- Search Section -->
        <div class="relative w-full max-w-2xl">
            <div class="relative flex items-center">
                <input type="text" id="open-search" placeholder="Buscar (acepta combinaciones, por ej.: 'Visuales, España')"
                    class="w-full p-4 pr-28 border rounded-lg shadow-sm">

                <!-- Filter trigger button (now first) -->
                <button id="filter-dropdown-trigger" class="absolute right-16 p-2 text-gray-400 hover:text-gray-600">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd"
                            d="M3 3a1 1 0 011-1h12a1 1 0 011 1v3a1 1 0 01-.293.707L12 11.414V15a1 1 0 01-.293.707l-2 2A1 1 0 018 17v-5.586L3.293 6.707A1 1 0 013 6V3z"
                            clip-rule="evenodd" />
                    </svg>
                </button>

                <!-- Clear all filters button (now second) -->
                <button type="button" id="clear-search" class="absolute right-4 p-2 text-gray-400 hover:text-gray-600"
                    onclick="clearAllFilters();">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd"
                            d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
                            clip-rule="evenodd" />
                    </svg>
                </button>
            </div>

            <!-- Structured filters dropdown -->
            <div id="structured-filters"
                class="hidden absolute z-50 mt-1 w-80 right-0 bg-white rounded-lg shadow-lg border border-gray-200 p-3 text-left"
                style="top: 100%; /* Ensure dropdown appears below search bar */">
                <!-- Categories Section -->
                <div class="mb-4">
                    <h3 class="text-sm font-semibold mb-2">Categorías</h3>
                    <div class="grid grid-cols-2 gap-2">
                        <button
                            class="category-filter-btn px-3 py-1 rounded border border-gray-300 text-gray-700 hover:border-blue-500 hover:bg-blue-50"
                            data-category="beca">Beca</button>
                        <button
                            class="category-filter-btn px-3 py-1 rounded border border-gray-300 text-gray-700 hover:border-blue-500 hover:bg-blue-50"
                            data-category="residencia">Residencia</button>
                        <button
                            class="category-filter-btn px-3 py-1 rounded border border-gray-300 text-gray-700 hover:border-blue-500 hover:bg-blue-50"
                            data-category="premio">Premio</button>
                        <button
                            class="category-filter-btn px-3 py-1 rounded border border-gray-300 text-gray-700 hover:border-blue-500 hover:bg-blue-50"
                            data-category="convocatoria">Convocatoria</button>
                        <button
                            class="category-filter-btn px-3 py-1 rounded border border-gray-300 text-gray-700 hover:border-blue-500 hover:bg-blue-50"
                            data-category="oportunidad">Oportunidad</button>
                        <button
                            class="category-filter-btn px-3 py-1 rounded border border-gray-300 text-gray-700 hover:border-blue-500 hover:bg-blue-50"
                            data-category="fondos">Fondos</button>
                        <button
                            class="category-filter-btn px-3 py-1 rounded border border-gray-300 text-gray-700 hover:border-blue-500 hover:bg-blue-50"
                            data-category="apoyo">Apoyo</button>
                    </div>
                </div>

                <!-- Country Dropdown -->
                <div class="mb-4">
                    <h3 class="text-sm font-semibold mb-2">País</h3>
                    <select id="country-filter" class="form-select">
                        <option value="">Todos los países</option>
                    </select>
                </div>

                <!-- Month Dropdown -->
                <div class="mb-4">
                    <h3 class="text-sm font-semibold mb-2">Mes de cierre</h3>
                    <select id="month-filter" class="form-select">
                        <option value="">Todos los meses</option>
                    </select>
                </div>

                <!-- Search Button -->
                <button id="search-filters"
                    class="w-full py-2 px-4 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                    Buscar
                </button>
            </div>
        </div>
    </header>

    <!-- Data container with proper escaping -->
    <div id="prefiltered-data" data-results="{{ prefiltered_results|tojson|forceescape }}"
        data-pages="{{ pages|tojson|forceescape }}" class="hidden">
    </div>
</div>

<!-- Full width background container with rounded top corners -->
<div class="w-full bg-gray-50 rounded-t-[40px] overflow-hidden">
    <!-- Re-open container for content alignment -->
    <div class="container max-w-[1292px] mx-auto px-8">
        <div class="pt-16 -mt-10 relative z-20">
            <!-- Filter buttons section -->
            <div class="mb-8">
                <div class="filter-container">
                    {% for discipline in discipline_groups.keys() %}
                    <button
                        class="filter-btn flex flex-col items-center justify-center rounded-med border text-gray-700 transition-all"
                        data-discipline-filter="{{ discipline }}" data-active="false"
                        onclick="this.dataset.active = this.dataset.active === 'true' ? 'false' : 'true'; toggleDisciplineFilter(this, '{{ discipline }}')">
                        <!-- Icons for each discipline -->
                        {% if discipline == 'Visuales' %}
                        <svg class="w-8 h-8 mb-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                        </svg>
                        {% elif discipline == 'Música' %}
                        <svg class="w-8 h-8 mb-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3" />
                        </svg>
                        {% elif discipline == 'Escénicas' %}
                        <svg class="w-8 h-8 mb-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" />
                        </svg>
                        {% elif discipline == 'Literatura' %}
                        <svg class="w-8 h-8 mb-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
                        </svg>
                        {% elif discipline == 'Diseño' %}
                        <svg class="w-8 h-8 mb-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01" />
                        </svg>
                        {% elif discipline == 'Cine' %}
                        <svg class="w-8 h-8 mb-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M7 4v16M17 4v16M3 8h4m10 0h4M3 12h18M3 16h4m10 0h4M4 20h16a1 1 0 001-1V5a1 1 0 00-1-1H4a1 1 0 00-1 1v14a1 1 0 001 1z" />
                        </svg>
                        {% else %}
                        <svg class="w-8 h-8 mb-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                        </svg>
                        {% endif %}
                        {{ discipline|title }}
                    </button>
                    {% endfor %}
                </div>
            </div>

            <!-- Destacados section with proper spacing and full width -->
            <div class="relative max-w-7xl mx-auto">
                <!-- Previous button - adjusted to -ml-14 -->
                <button onclick="prevDestacarPage()"
                    class="destacar-prev absolute left-0 top-1/2 -translate-y-1/2 -ml-14 w-10 h-10 flex items-center justify-center rounded-full bg-white shadow-lg hover:bg-gray-50 focus:outline-none transition-opacity duration-200"
                    aria-disabled="true">
                    <svg class="h-6 w-6 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                    </svg>
                </button>

                <!-- Featured opportunities grid - full width -->
                <div class="featured-opportunities w-full">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <!-- Content will be populated by JavaScript -->
                    </div>
                </div>

                <!-- Next button - adjusted to -mr-14 -->
                <button onclick="nextDestacarPage()"
                    class="destacar-next absolute right-0 top-1/2 -translate-y-1/2 -mr-14 w-10 h-10 flex items-center justify-center rounded-full bg-white shadow-lg hover:bg-gray-50 focus:outline-none transition-opacity duration-200">
                    <svg class="h-6 w-6 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                    </svg>
                </button>
            </div>

            <!-- Results Section -->
            <div class="mt-4 mb-6">
                <!-- Results Counter -->
                <div class="text-sm text-gray-600 my-4" id="results-counter"></div>

                <!-- Results Grid -->
                <div id="results-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
            </div>
        </div>
    </div>
</div>

<!-- Update the script section -->
<script type="module">
    console.log('SearchModule availability check:', {
        searchModuleExists: !!window.SearchModule,
        updateResultsExists: !!(window.SearchModule && window.SearchModule.updateResults)
    });

    // Global variables needed by site.js
    let activeFilters = {
        categories: new Set(),
        country: '',
        month: '',
        discipline: 'todos'
    };

    // Define functions first
    function initializeDropdowns(pages) {
        console.log('Initializing dropdowns');
        // Initialize country dropdown
        const countryFilter = document.getElementById('country-filter');
        const countries = [...new Set(pages.map(page => page.pais).filter(Boolean))].sort();

        countries.forEach(country => {
            const option = document.createElement('option');
            option.value = country;
            option.textContent = country;
            countryFilter.appendChild(option);
        });

        // Initialize month dropdown
        const monthFilter = document.getElementById('month-filter');
        const months = [
            { value: '1', label: 'Enero' },
            { value: '2', label: 'Febrero' },
            { value: '3', label: 'Marzo' },
            { value: '4', label: 'Abril' },
            { value: '5', label: 'Mayo' },
            { value: '6', label: 'Junio' },
            { value: '7', label: 'Julio' },
            { value: '8', label: 'Agosto' },
            { value: '9', label: 'Septiembre' },
            { value: '10', label: 'Octubre' },
            { value: '11', label: 'Noviembre' },
            { value: '12', label: 'Diciembre' }
        ];

        months.forEach(month => {
            const option = document.createElement('option');
            option.value = month.value;
            option.textContent = month.label;
            monthFilter.appendChild(option);
        });
    }

    function updateResults(results) {
        if (window.SearchModule && window.SearchModule.updateResults) {
            window.SearchModule.updateResults(results);
        } else {
            // Your existing fallback card-based display logic
            const container = document.getElementById('results-container');
            const counter = document.getElementById('results-counter');

            if (!results.length) {
                container.innerHTML = '<p>No se encontraron resultados.</p>';
                counter.textContent = '0 resultados encontrados';
                return;
            }

            container.innerHTML = results.map(page => `
                <div class="opportunity-card border rounded-lg p-4 shadow-sm hover:shadow-md transition-shadow duration-200">
                    <h3 class="font-bold text-lg mb-2">${escapeHTML(page.nombre || 'Sin nombre')}</h3>
                    <p class="text-sm text-gray-600 mb-2">${escapeHTML(page.og_resumida || '')}</p>
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-gray-500">${escapeHTML(page.disciplina || '')}</span>
                        <button 
                            class="preview-btn text-blue-600 hover:underline text-sm"
                            data-url="${escapeHTML(page.url || '')}"
                            data-name="${escapeHTML(page.nombre || '')}"
                            data-country="${escapeHTML(page.pais || '')}"
                            data-summary="${escapeHTML(page.og_resumida || '')}"
                            data-category="${escapeHTML(page.categoria || '')}"
                            data-id="${escapeHTML(page.id || '')}"
                        >
                            Ver más
                        </button>
                    </div>
                </div>
            `).join('');

            counter.textContent = `${results.length} resultado${results.length !== 1 ? 's' : ''} encontrado${results.length !== 1 ? 's' : ''}`;
        }
    }

    function applyFilters(searchInput = document.getElementById('open-search').value) {
        console.log('applyFilters called with:', { searchInput, activeFilters });
        
        const featuredSection = document.querySelector('.featured-opportunities');

        if (searchInput ||
            activeFilters.categories.size > 0 ||
            activeFilters.country ||
            activeFilters.month ||
            activeFilters.discipline !== 'todos') {
            featuredSection?.classList.add('hidden');
        } else {
            featuredSection?.classList.remove('hidden');
        }

        const allPages = JSON.parse(document.getElementById('prefiltered-data').dataset.pages);
        
        const filtered = allPages.filter(page => {
            // For debugging
            let filterResults = {
                searchMatch: true,
                disciplineMatch: true,
                countryMatch: true,
                monthMatch: true,
                categoryMatch: true
            };

            // Apply text search filter
            if (searchInput) {
                filterResults.searchMatch = matchesSearchTerms(page, searchInput);
                if (!filterResults.searchMatch) return false;
            }

            // Apply discipline filter
            if (activeFilters.discipline !== 'todos') {
                filterResults.disciplineMatch = normalizeText(page.disciplina) === normalizeText(activeFilters.discipline);
                if (!filterResults.disciplineMatch) return false;
            }

            // Apply country filter
            if (activeFilters.country) {
                filterResults.countryMatch = normalizeText(page.pais) === normalizeText(activeFilters.country);
                if (!filterResults.countryMatch) return false;
            }

            // Apply month filter
            if (activeFilters.month) {
                const monthToFind = String(activeFilters.month).padStart(2, '0');
                const pageMonth = page.fecha_de_cierre ? page.fecha_de_cierre.split('-')[1] : '';
                filterResults.monthMatch = pageMonth === monthToFind;
                if (!filterResults.monthMatch) return false;
            }

            // Apply category filters
            if (activeFilters.categories.size > 0) {
                const pageCategory = normalizeText(page.categoria);
                filterResults.categoryMatch = Array.from(activeFilters.categories).some(category => {
                    const normalizedCategory = normalizeText(category);
                    return pageCategory.startsWith(normalizedCategory) ||
                        pageCategory.startsWith(normalizedCategory + 's');
                });
                if (!filterResults.categoryMatch) return false;
            }

            return true;
        });

        console.log('Filtered results:', filtered.length);
        updateResults(filtered);
    }

    function matchesSearchTerms(page, searchInput) {
        const searchTerms = searchInput.split(',').map(term => normalizeText(term.trim()));
        return searchTerms.every(term => {
            const pageText = normalizeText([
                page.nombre,
                page.og_resumida,
                page.entidad,
                page.categoria,
                page.disciplina,
                page.pais
            ].join(' '));
            return pageText.includes(term);
        });
    }

    function normalizeText(text) {
        if (!text) return '';
        return text.normalize("NFD")
            .replace(/[\u0300-\u036f]/g, "")
            .toLowerCase()
            .trim();
    }

    // Then add event listeners
    document.addEventListener('DOMContentLoaded', function () {
        console.log('DOM Content Loaded - Setting up event listeners');
        
        const allPages = JSON.parse(document.getElementById('prefiltered-data').dataset.pages);
        initializeDropdowns(allPages);

        // Initialize the view with all results
        applyFilters();

        // Setup category filter buttons
        document.querySelectorAll('.category-filter-btn').forEach(button => {
            console.log('Setting up category button:', button.dataset.category);
            button.addEventListener('click', function (e) {
                console.log('Category clicked:', this.dataset.category);
                e.preventDefault();
                e.stopPropagation();
                const category = this.dataset.category;

                if (activeFilters.categories.has(category)) {
                    activeFilters.categories.delete(category);
                    this.classList.remove('border-blue-500', 'bg-blue-50');
                } else {
                    activeFilters.categories.add(category);
                    this.classList.add('border-blue-500', 'bg-blue-50');
                }

                window.selectedCategories = Array.from(activeFilters.categories);
                console.log('Selected categories:', window.selectedCategories);
            });
        });

        // Setup apply filters button
        const applyFiltersBtn = document.getElementById('search-filters');
        if (applyFiltersBtn) {
            console.log('Setting up apply filters button');
            applyFiltersBtn.addEventListener('click', function (e) {
                console.log('Apply filters clicked');
                e.preventDefault();
                e.stopPropagation();

                activeFilters.country = document.getElementById('country-filter').value;
                activeFilters.month = document.getElementById('month-filter').value;

                if (window.selectedCategories) {
                    activeFilters.categories = new Set(window.selectedCategories);
                }

                console.log('Applying filters with:', {
                    categories: Array.from(activeFilters.categories),
                    country: activeFilters.country,
                    month: activeFilters.month
                });

                applyFilters();
                document.getElementById('structured-filters').classList.add('hidden');
            });
        } else {
            console.warn('Apply filters button not found!');
        }
    });
</script>
{% endblock %}

{% block page_scripts %}
<script>
    // Process data and store in a dedicated window property
    const rawData = {{ destacar_pages| tojson | safe }};
    window.processedDestacarData = rawData.map(item => ({
        ...item,
        url_base: item.url_base || new URL(item.url).hostname.replace('www.', '')
    }));
    console.log('Processed data:', window.processedDestacarData);
</script>
{% endblock %}