{% extends 'layout.html' %}

{% block body %}
<div class="px-0 md:px-8 mt-4 md:-mt-12">
    <!-- Header Section -->
    <header class="mb-8 md:mb-16 ml-4 !block">
        <div class="flex flex-col md:flex-row items-start justify-between gap-6 md:gap-12">
            <!-- Logo and Brand -->
            <div class="relative !border-l-[6px] !border-gray-300 pl-6 h-10" 
                 style="border-left: 6px solid rgb(209 213 219) !important; border-top: 6px solid transparent !important;">
                <div class="flex items-center gap-3 -mt-2.5">
                    <img src="{{ url_for('static', filename='public/Frame_3.png') }}" 
                         alt="+ Oportunidades Logo"
                         class="w-10 h-10 md:w-12 md:h-12">
                    <div class="flex flex-col">
                        <h2 class="text-3xl font-bold tracking-tight text-slate-700">+ Oportunidades</h2>
                        <p class="text-sm text-neutral-500 ml-[2em] tracking-wide -mt-1">Mi información guardada</p>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main content -->
    <main class="w-full relative">
        <div class="grid grid-cols-1 md:grid-cols-12 gap-0">
            <!-- First Column: Accordion -->
            <div class="col-span-1 md:col-span-5 lg:col-span-4 flex flex-col justify-between min-w-0 md:border-r border-neutral">
                <div class="flex-1 flex flex-col gap-2">
                    <!-- Accordion: Cierran Pronto -->
                    <div class="join join-vertical w-full">
                        <div class="collapse join-item border-b border-neutral rounded-none w-full">
                            <input type="radio" name="my-accordion-1" checked="" />
                            <div class="collapse-title text-sm tracking-tighter text-neutral-700 inline-block">
                                <span class="md:border border-neutral-300 md:px-4 md:py-2">
                                    CIERRAN PRONTO
                                </span>
                            </div>
                            <div class="collapse-content w-full">
                                {% if closing_soon_pages %}
                                {% for page in closing_soon_pages %}
                                <p class="relative">
                                    <a href="{{ page.base_url if page.base_url else page.url }}" target="_blank"
                                        data-name="{{ page.nombre }}" data-country="{{ page.País }}"
                                        data-url="{{ page.url }}" class="cierran-pronto-link">
                                        {{ page.resumen_IA | truncate(50) }}
                                        <span class="absolute right-0 top-1/2 transform -translate-y-1/2 flex items-center justify-center -mr-1">
                                            <span class="flex items-center justify-center group-hover:bg-slate-200 group-hover:rounded-md transition-all duration-200 p-2">
                                                <svg class="w-3 h-3 z-10" data-slot="icon" fill="none"
                                                    stroke-width="1.5" stroke="currentColor" viewBox="0 0 24 24"
                                                    xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                                                    <path stroke-linecap="round" stroke-linejoin="round"
                                                        d="m4.5 19.5 15-15m0 0H8.25m11.25 0v11.25"></path>
                                                </svg>
                                            </span>
                                        </span>
                                    </a>
                                </p>
                                {% endfor %}
                                {% else %}
                                <p>No hay oportunidades este mes.</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Second Column: Results Table -->
            <div class="col-span-1 md:col-span-7 lg:col-span-8 min-w-0">
                <div class="border-b border-t border-neutral overflow-auto">
                    <table class="table-fixed w-full">
                        <tbody id="my-results">
                            {% include "_my_results.html" %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>
</div>

<!-- Update the spinner element -->
<div id="layout-spinner" class="spinner h-8 w-8" style="display: none;">
    <img src="{{ url_for('static', filename='public/spinner.gif') }}" alt="Loading...">
</div>

<style>
    .spinner {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 1000;
    }
</style>

<script>
    function shareOpportunity(url, title, platform) {
        const encodedUrl = encodeURIComponent(url);
        const encodedTitle = encodeURIComponent('\n- + Oportunidades');

        let shareUrl = '';

        if (platform === 'whatsapp') {
            shareUrl = `https://wa.me/?text=${encodedTitle}%20${encodedUrl}`;
        } else if (platform === 'linkedin') {
            shareUrl = `https://www.linkedin.com/sharing/share-offsite/?url=${encodedUrl}&text=${encodedTitle}`;
        } else if (platform === 'gmail') {
            shareUrl = `mailto:?subject=${encodeURIComponent(encodedTitle)}&body=${encodedUrl}`;
        }
        window.open(shareUrl, '_blank');
    }

    function toggleDropdown(button) {
        // Prevent any event bubbling and default behavior
        event.preventDefault();
        event.stopPropagation();
        
        // Clear any existing alerts
        const alertContainer = document.getElementById('alert-container');
        if (alertContainer) {
            alertContainer.innerHTML = '';
        }
        
        // Close all other table dropdowns first
        document.querySelectorAll('th .dropdown-content').forEach(d => {
            if (d !== button.nextElementSibling) {
                d.classList.add('hidden');
            }
        });
        
        // Toggle current dropdown
        const dropdown = button.nextElementSibling;
        dropdown.classList.toggle('hidden');
        
        // Position the dropdown relative to the button
        if (!dropdown.classList.contains('hidden')) {
            const buttonHeight = button.offsetHeight;
            dropdown.style.top = `${buttonHeight + 4}px`;
            dropdown.style.right = '0';
            dropdown.style.zIndex = '9999';
        }
    }

    // Close dropdown when clicking outside
    document.addEventListener('click', function(event) {
        if (!event.target.closest('th .dropdown-content') && !event.target.closest('th button')) {
            document.querySelectorAll('th .dropdown-content').forEach(d => {
                d.classList.add('hidden');
            });
        }
        
        // Prevent form submission checks when clicking dropdowns
        if (event.target.closest('.dropdown-content') || event.target.closest('button[onclick*="toggleDropdown"]')) {
            event.stopPropagation();
        }
    });
</script>
{% endblock %}